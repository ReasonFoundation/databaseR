---
title: "Teacher Retirement System of Texas Solvency Analysis"
author: "Prepared by: Pension Integrity Project at Reason Foundation. 2022—Preliminary Draft"
date: "07/14/2021"
output:
  powerpoint_presentation:
    reference_doc: template_deck.pptx
  beamer_presentation: default
always_allow_html: true
fontsize: 9pt
font-family: Arial
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  #dev = "svg",
  fig.width = 12,
  fig.height = 7
  #Font size (Graphs + Text)
  #Source line
  #Header
  
)

year <- 2021
#Update linePlot() for Treasury functionality
#Update linePlot() for shaded UAL area/line plot
#Create glPlot() w/ function to turn "interactive" parameter TRUE/FALSE to create Plotly graph (eventually use database data)
#Create barPlot() w/ manual ready data + database calculated Neg.Amo + interest on Debt
#
```

### About the Pension Integrity Project

We offer pro-bono technical assistance to public officials to help them design and implement pension reforms that improve plan solvency and promote retirement security, including:

</p>

-   Customized analysis of pension system design, trends

    </p>

-   Independent actuarial modeling of reform scenarios

    </p>

-   Consultation and modeling around custom policy designs

    </p>

-   Latest pension reform research and case studies

    </p>

-   Peer-to-peer mentoring from state and local officials who have successfully enacted pension reforms

    </p>

-   Assistance with stakeholder outreach, engagement and relationship management

    </p>

-   Design and execution of public education programs and media campaigns

    </p>

### TxTRS Unfunded Liabilities (2001-`r year`) w/ R (areaPlot())

```{r debtTRS, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial valuation reports.", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

rm(list = ls())

###Load/install packages
#R.Version()
#https://github.com/ReasonFoundation/pensionviewr
#Create token -> usethis::edit_r_environ() -> restart -> Sys.getenv("GITHUB_PAT")
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
# devtools::install_github(
#   "ANiraula/pensionviewr_private",
#    ref = "master", auth_token = "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")

library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(plyr)
library(dplyr)

###
##Pull PERSI data
##Load list of plans
pl <- planList()

#############

pl <- planList()

#############
pullStateData <- function (FY)
{
  con <- RPostgres::dbConnect(
    RPostgres::Postgres(),
    dbname = "d629vjn37pbl3l",
    host = "ec2-3-209-200-73.compute-1.amazonaws.com",
    port = 5432,
    user = "reason_readonly",
    password = "p88088bd28ea68027ee96c65996f7ea3b56db0e27d7c9928c05edc6c23ef2bc27",
    sslmode = "require")
  
  query <- paste("select * from pull_data_state_only()\nwhere year > '",
                 paste(FY - 1), "'\nand attribute_name in ('1 Year Investment Return Percentage',
                 \n'PPD ID',
                 \n'Number of Employers',
                 \n'Number of Plans',\n'Actuarial Cost Method in GASB Reporting',
                 \n'Employer Normal Cost Percentage',
                 \n'Total Normal Cost Dollar',\n'Actuarial Funded Ratio Percentage',
                 \n'Market Investment Return (MVA Basis)',
                 \n'Actuarial Value of Assets GASB Dollar',
                 \n'Market Value of Assets Dollar',
                 \n'Market Assets Reported for Asset Smoothing',
                 \n'Actuarially Accrued Liabilities Dollar',
                 \n'Total Pension Liability Dollar',
                 \n'Actuarially Determined Contribution Percentage of Payroll',
                 \n'Actuarially Required Contribution Dollar',
                 \n'Actuarially Required Contribution Paid Percentage',
                 \n'Total Employer Contributions',
                 \n'Statutory Payment Dollar',
                 \n'Statutory Payment Percentage',
                 \n'Amortizaton Method',
                 \n'Total Benefits Paid Dollar',
                 \n'Benefit Payments Dollar',
                 \n'Refunds Dollar',
                 \n'Administrative Expense Dollar',
                 \n'Cost Structure',
                 \n'Asset Valuation Method for GASB Reporting',
                 \n'Covered Payroll Dollar',
                 \n'Employee Contribution Dollar',
                 \n'Employee Normal Cost Percentage',
                 \n'Employer Contribution Regular Dollar',
                 \n'Employer Normal Cost Dollar',
                 \n'Employer State Contribution Dollar',
                 \n'ADEC as a Percent of Payroll',
                 \n'Other Contribution Dollar',
                 \n'Other Additions',
                 \n'Fiscal Year of Contribution',
                 \n'Inflation Rate Assumption For GASB Reporting',
                 \n'Investment Return Assumption for GASB Reporting',
                 \n'Discount Rate Assumption',
                 \n'Number of Years Remaining on Amortization Schedule',
                 \n'Payroll Growth Assumption',
                 \n'Unfunded Actuarially Accrued Liabilities Dollar',
                 \n'Total Contribution Dollar',
                 \n'Total Normal Cost Percentage',
                 \n'Net Pension Liability Dollar',
                 \n'Net Pension Liability Assuming 1% Decrease in Discount Rate',
                 \n'Net Pension Liability Assuming 1% Increase in Discount Rate',
                 \n'Total Number Of Members',
                 \n'Total Projected Actuarial Required Contribution Percentage Of Payroll',
                 \n'Actuarially Required Contribution Paid Dollar',
                 \n'Actuarially Determined Contribution Paid Dollar',
                 \n'Type of Employees Covered',
                 \n'Total Amortization Payment Percentage',
                 \n'Wage Inflation')")
  result <- RPostgres::dbSendQuery(con, query)
  all_data <- RPostgres::dbFetch(result) %>% janitor::clean_names()
  RPostgres::dbClearResult(result)
  RPostgres::dbDisconnect(con)
  all_data %>% dplyr::group_by_at(dplyr::vars(-.data$attribute_value)) %>%
    dplyr::mutate(row_id = 1:dplyr::n()) %>% dplyr::ungroup() %>%
    tidyr::pivot_wider(names_from = attribute_name, values_from = attribute_value) %>%
    dplyr::select(-.data$row_id) %>% 
    dplyr::arrange(display_name, year) %>%
    janitor::clean_names()
}

###########

filterAssets2 <- function (data, fy = 2001, plan = NULL) {
  data <- data.frame(data)
  
  data[, 5:83] <- data[, 5:83] %>% mutate_all(as.numeric)
  data <- data %>% replace(is.na(.), 0)
  data$year <- as.numeric(data$year)
  
  assets <- data %>% select(year, display_name, state, contains("percent")) %>%
    
    mutate(private.equity = percent_of_assets_invested_in_private_equity, 
           real.estate =  percent_of_assets_invested_in_real_estate, 
           hedge = percent_of_assets_invested_in_hedge_funds,
           commodities = percent_of_assets_invested_in_commodities,
           other.alternatives = percent_of_assets_invested_in_misc_alternatives + percent_of_assets_invested_in_other_investments,
           equity = percent_of_assets_invested_in_equity_investments_total,
           fixed = percent_of_assets_invested_in_fixed_income, 
           cash = percent_of_assets_invested_in_cash) %>% 
    select( -contains("percent")
    )
  
  
  if (!is.null(plan)) {
    assets <- assets %>% filter(display_name == plan)
  }
  assets$total <- 0
  y <- as.numeric(length(assets$total))
  assets[, 4:11] <- assets[, 4:11] %>% mutate_all(as.numeric)
  for (i in (1:y)) {
    assets$total[i] <- sum(assets[i, 4:11])
  }
  
  assets$total <- as.numeric(assets$total)
  
  
  colnames(assets) <- c("year", "Plan", "State", "Private Equity", 
                        "Real Estate", "Hedge Funds", "Commodities", "Other Alternatives", 
                        "Total Equity", "Fixed Income", "Cash Equivalents", 
                        "Total")
  
  assets <- assets %>% 
    filter(year >= fy) %>% 
    select(-Total)
  
  assets
}

#########
# Filter Downloaded Data -------------------------------------------------------------

filterData2 <- function(Data, fy = 2001,
                        inflation = TRUE,
                        expenditure = TRUE,
                        employee = NULL,
                        sp500 = TRUE,
                        dcData = TRUE,
                        treasury = TRUE,
                        blend.teacher = FALSE,
                        source = FALSE) {
  if (isTRUE(blend.teacher)) {
    blended.teach <- c("Arizona State Retirement System",
                       "Delaware State Employees’ Pension Plan", "District of Columbia Teachers Retirement Fund",
                       "Florida Retirement System", "Employee Retirement System of Hawaii",
                       "Idaho Public Employee Retirement System", "Iowa Public Employees' Retirement System",
                       "Kansas Public Employees' Retirement System", "Public Employees' Retirement System of Mississippi",
                       "Nevada Public Employees Retirement System", "New Hampshire Retirement System",
                       "North Carolina Teachers' and State Employees' Retirement System",
                       "Oregon Public Employees Retirement System", "Rhode Island Employees Retirement System",
                       "South Carolina Retirement Systems", "South Dakota Retirement System",
                       "Tennessee Consolidated Retirement System, Teachers Pension Plan",
                       "Utah Retirement Systems, Noncontributory Retirement System",
                       "Virginia Retirement System", "Wisconsin Retirement System",
                       "Wyoming Retirement System, Public Employees’ Pension Plan",
                       "Maine Public Employees Retirement System (PERS) Defined Benefit Plan",
                       "Maryland State Employees’ Retirement System")
    Data <- data.frame(Data)
    Data <- Data %>% mutate(type_of_employees_covered = case_when(display_name %in%
                                                                    blended.teach ~ "Plan covers state, local and teachers",
                                                                  TRUE ~ type_of_employees_covered))
  }
  Data <- data.frame(Data)
  columns <- c("total_pension_liability_dollar", "wage_inflation",
               "payroll_growth_assumption", "other_contribution_dollar",
               "other_additions_dollar", "x1_year_investment_return_percentage",
               "amortizaton_method", "number_of_years_remaining_on_amortization_schedule",
               "amortization_payment_total_amount",
               "x1_year_investment_return_percentage",
               "total_normal_cost_dollar", "fiscal_year_of_contribution",
               "statutory_payment_dollar", "statutory_payment_percentage",
               "ppd_fund_id", "number_of_employers", "number_of_plans", "ppd_id",
               "discount_rate_assumption", "market_investment_return_mva_basis", 
               "actuarially_determined_contribution_dollar",
               "net_pension_liability_dollar",
               "administrative_expense_dollar",
               "employer_state_contribution_dollar",
               "total_amortization_payment_percentage",
               "type_of_employees_covered",
               "total_contribution_dollar",
               "employer_contribution_regular_dollar",
               "actuarial_cost_method_in_gasb_reporting",
               "net_pension_liability_assuming_1_percent_decrease_in_discount_rate",
               "net_pension_liability_assuming_1_percent_increase_in_discount_rate",
               "actuarially_required_contribution_paid_dollar",
               "actuarially_required_contribution_paid_percentage",
               "total_benefits_paid_dollar",
               "benefit_payments_dollar",
               "refunds_dollar",
               "actuarially_determined_contribution_paid_dollar",
               "cost_structure", "employer_normal_cost_percentage", "actuarial_value_of_assets_dollar",
               "asset_valuation_method_for_gasb_reporting", "inflation_rate_assumption",
               "total_number_of_members", "total_projected_actuarial_required_contribution_percentage_of_payroll",
               "market_assets_reported_for_asset_smoothing")
  columns2 <- c("test")
  for (i in (1:length(columns))) {
    if (sum(colnames(Data) %in% columns[i]) == 0) {
      columns2 <- rbind(columns2, columns[i])
    }
  }
  columns2 <- as.character(columns2 <- columns2[2:length(columns2)])
  cols <- matrix(NA, length(Data[, 1]), length(columns2))
  colnames(cols) <- columns2
  Data <- cbind(Data, cols)
  Data <- data.frame(Data)
  Data <- Data %>% arrange(state, display_name, year)
  Data$year <- as.numeric(Data$year)
  if (isTRUE(inflation)) {
    library(readxl)
    library(httr)
    url1 <- "https://github.com/ReasonFoundation/databaseR/raw/master/files/CPI_by_Region_DOL.xlsx"
    GET(url1, write_disk(tf <- tempfile(fileext = ".xlsx")))
    cpi <- read_excel(tf, sheet = 1)
    regions <- read_excel(tf, sheet = 2)
    cpi <- data.table(cpi)
    regions <- data.table(regions)
    cpi$cpi_change <- NA
    for (i in (2:length(cpi$region))) {
      cpi$cpi_change[i] <- (cpi$cpi[i]/cpi$cpi[i - 1]) -
        1
    }
    Data <- Data %>% left_join(regions, by = "state")
    Data <- Data %>% left_join(cpi, by = c("year", "region"))
    Data <- Data %>% select(-cpi)
  }
  
  if (isTRUE(sp500)) {
  urlfile2 = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/S%26P500.csv"
  

  SP500 <- data.table(
    read_csv(url(urlfile2), col_names = TRUE, na = c(""), 
                    skip_empty_rows = TRUE, col_types = NULL))

    Data <- Data %>% left_join(SP500, by = c("year"))
  
  }
  
  if (isTRUE(dcData)) {
    
  #Data <- data.table(pullStateData(2001))
   
  urlfile3 = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/DCPlanData.csv"
  
  DCPlanData <- data.table(
    read_csv(url(urlfile3), col_names = TRUE, na = c(""), 
             skip_empty_rows = TRUE, col_types = NULL))
  
  DCPlanData <- DCPlanData %>% 
    select(year = fy, ppd_id, plantype,
           ee_contrate_mandatory, er_contrate_fixedrate, 
           planname, primary,
           eligible_eegroups, assets, members_total, actives, inactives, coveredpayroll) %>% 
    replace(is.na(.), 0)
  
  DCPlanData$ppd_id <- as.numeric(DCPlanData$ppd_id)
  DCPlanData$fy <- as.numeric(DCPlanData$fy)
  DCPlanData$er_contrate_fixedrate <- as.numeric(DCPlanData$er_contrate_fixedrate)
  DCPlanData$ee_contrate_mandatory <- as.numeric(DCPlanData$ee_contrate_mandatory)
  DCPlanData$assets <- as.numeric(DCPlanData$assets)
  DCPlanData$members_total <- as.numeric(DCPlanData$members_total)
  DCPlanData$actives <- as.numeric(DCPlanData$actives)
  DCPlanData$inactives <- as.numeric(DCPlanData$inactives)
  
  for(i in (1:length(DCPlanData$members_total))){
  
  DCPlanData$members_total[i] <- max(DCPlanData$members_total[i], (DCPlanData$actives[i]+DCPlanData$inactives[i]))
  
  }
  
  Data$ppd_id <- as.numeric(Data$ppd_id)
  Data$year<- as.numeric(Data$year)
  
  Data <- Data %>% left_join(DCPlanData, by = c("ppd_id", "year"))

  }
  if (isTRUE(treasury)) {
  urlfile <- "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/treasury.csv"
  treasury <- data.table(
    read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL))
  
  colnames(treasury)[2] <- "treasury_30"
  Data <- Data %>% left_join(treasury, by = c("year"))

  }
  
  if (isTRUE(expenditure)) {

    #1. General Fund Exp./Rev. NASBO (State)
    #2. Total Exp./Rev. NASBO (State) --> general funds, other state funds, bonds, and federal funds.
    #3. Total Exp./Rev. Urban (State & Local) --> state and local direct general expenditures (exclude “business-like” activities such as utilities and transfers between state and local governments.)

    library(readxl)
    library(httr)
    urlfile="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/NASBO_Exp_Report_Data_v1.csv"
    NASBO<-read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    NASBO <- setDT(NASBO)
    NASBO <- NASBO %>% select(YEAR, STATE,"TOTAL_CAPI") %>% filter(YEAR>2000)
    #View(NASBO)
    colnames(NASBO)[1] <- "year"
    colnames(NASBO)[2] <- "state"
    Data <- Data %>% left_join(NASBO, by = c("year","state"))
    ####
    urlfile="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/UrbanCensus_ExpRev_2000-2018.csv"
    Urban<-read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    Urban <- setDT(Urban)

    Urban <- Urban %>% select(Year, State,"(R01) Total Revenue", "(E001) Total Expenditure")

    colnames(Urban)[1] <- "year"
    colnames(Urban)[2] <- "state"
     
    Data <- Data %>% left_join(Urban, by = c("year","state"))

  }

  Data <- Data %>% select(year, plan_name = display_name,
                          state, if (isTRUE(source)) {
                            "data_source_name"
                          }, return_1yr = x1_year_investment_return_percentage,
                          ava_return = market_investment_return_mva_basis, actuarial_cost_method_in_gasb_reporting,
                          funded_ratio = actuarial_funded_ratio_percentage, ava = actuarial_value_of_assets_gasb_dollar, #actuarial_value_of_assets_gasb_dollar (PPD)
                          mva = market_value_of_assets_dollar, #mva_smooth = market_assets_reported_for_asset_smoothing,
                          aal = actuarially_accrued_liabilities_dollar,
                          adec1 = actuarially_determined_contribution_dollar,
                          adec2 =   actuarially_required_contribution_paid_dollar,  #actuarially_required_contribution_dollar (PPD)
                          adec_paid_pct = actuarially_required_contribution_paid_percentage,
                          adec_pct = adec_as_a_percent_of_payroll, #instead of employers_projected_actuarial_required_contribution
                          arc_paid_dollar = actuarially_required_contribution_paid_dollar, #NEW
                          adec_paid_dollar = actuarially_determined_contribution_paid_dollar,#NEW
                          statutory = statutory_payment_dollar, statutory_pct = statutory_payment_percentage,
                          amortizaton_method, total_benefit_payments = total_benefits_paid_dollar,
                          benefit_payments = benefit_payments_dollar, refunds = refunds_dollar,
                          admin_exp = administrative_expense_dollar, cost_structure,
                          state_exp_NASBO = TOTAL_CAPI, #gf_rev_NASBO = "TOTAL REV",
                          state.local_exp_Census = "(R01) Total Revenue", state.local_rev_Census = "(E001) Total Expenditure",
                          fund_id = ppd_fund_id, ppd_id = ppd_id, employers = number_of_employers,
                          plans = number_of_plans, asset_valuation_method_for_gasb_reporting,
                          dc_plantype = plantype,  dc_er_pct = er_contrate_fixedrate, #dc_eligble = eligible_eegroups,
                          dc_ee_pct = ee_contrate_mandatory, dc_plan = planname, dc_primary = primary,
                          dc_assets = assets, dc_members = members_total, dc_payroll = coveredpayroll,
                          payroll = covered_payroll_dollar, ee_contribution = employee_contribution_dollar,
                          ee_nc_pct = employee_normal_cost_percentage,
                          er_nc_pct = employer_normal_cost_percentage,total_nc_pct = total_normal_cost_percentage, 
                          er_contribution = employer_contribution_regular_dollar, er_state_contribution = employer_state_contribution_dollar,
                          other_contribution = other_contribution_dollar, other_additions = other_additions_dollar,
                          fy_contribution = fiscal_year_of_contribution, inflation_assum = inflation_rate_assumption,
                          arr = investment_return_assumption_for_gasb_reporting,
                          dr = discount_rate_assumption, number_of_years_remaining_on_amortization_schedule,
                          payroll_growth_assumption, total_amortization_payment_pct = total_amortization_payment_percentage,
                          total_amo_payment = amortization_payment_total_amount, #Added
                          total_contribution = total_contribution_dollar,
                          total_nc_dollar = total_normal_cost_dollar, total_number_of_members,
                          total_proj_adec_pct = total_projected_actuarial_required_contribution_percentage_of_payroll,
                          tpl = total_pension_liability_dollar,
                          npl_pct_down = net_pension_liability_assuming_1_percent_decrease_in_discount_rate, #Added
                          npl = net_pension_liability_dollar, #Added
                          npl_pct_up = net_pension_liability_assuming_1_percent_increase_in_discount_rate, #Added
                          type_of_employees_covered, unfunded_actuarially_accrued_liabilities_dollar,
                          wage_inflation, region, cpi_change, sp_500, treasury_30)

  
  ## Combining ARC & ADEC
  Data$state.local_exp_Census <- as.numeric(Data$state.local_exp_Census)
  Data$state.local_rev_Census <- as.numeric(Data$state.local_exp_Census)
  Data$state_exp_NASBO <- as.numeric(Data$state_exp_NASBO)
  Data$dc_primary <- ifelse(Data$dc_primary == 1, "Yes", "No")
  
  Data$adec1 <- as.numeric(Data$adec1)
  Data$adec2 <- as.numeric(Data$adec2)
  Data$adec_paid_dollar <- as.numeric(Data$adec_paid_dollar)
  Data$arc_paid_dollar <- as.numeric(Data$arc_paid_dollar)
  Data$arc_adec_dollar <- ifelse(is.na(Data$adec1) == TRUE,Data$adec2, Data$adec1)
  Data$arc_adec_paid_dollar <- ifelse(is.na(Data$arc_paid_dollar) == TRUE,
                               ifelse(is.na(Data$statutory_payment_dollar) == TRUE,statutory_payment_dollar, 
                                      Data$adec_paid_dollar), 
                                      Data$arc_paid_dollar)
  
  Data$fy_contribution <- as.numeric(Data$fy_contribution)
  Data$year <- as.numeric(Data$year)
  Data$fy_contribution <- round(Data$fy_contribution, 0)
  Data <- Data %>% filter(year >= fy) #%>% select(-adec1, -adec2)

  #https://www.urban.org/policy-centers/cross-center-initiatives/state-and-local-finance-initiative/projects/state-fiscal-briefs/florida

  if (isTRUE(expenditure)) {
   Data$ava <- as.numeric(Data$ava)
   Data$aal <- as.numeric(Data$aal)
   Data$state_exp_NASBO <- as.numeric(Data$state_exp_NASBO)
   Data$state.local_exp_Census <- as.numeric(Data$state.local_exp_Census)
   Data <- Data %>% group_by(state, year) %>% mutate(ual_exp_NASBO = round((sum(aal)-sum(ava))/(state_exp_NASBO*1000000),2),
                                                     ual_exp_Census = round((sum(aal)-sum(ava))/(state.local_exp_Census*1000),2))
  }

  if (is_null(employee)) {
    employee <- employee
  }
  else if (employee == "teacher") {
    employee <- c("Plan covers teachers")
  }
  else if (employee == "state and local") {
    employee <- c("Plan covers state and local employees")
  }
  else if (employee == "police and fire") {
    employee <- c("Plan covers police and/or fire")
  }
  else if (employee == "state") {
    employee <- c("Plan covers state employees")
  }
  else if (employee == "local") {
    employee <- c("Plan covers local employees")
  }
  else if (employee == "state, local, and teachers") {
    employee <- c("Plan covers state, local and teachers")
  }
  if (is_null(employee)) {
    Data <- data.frame(Data) %>% replace(is.na(.), 0)
  }
  else {
    Data %>% filter(type_of_employees_covered == paste(employee)) %>% replace(is.na(.), 0)
  }
}

#PULL DATA
Data <- pullStateData(2001)
Data <- data.table(filterData2(Data, 2001))

Data <-
  data.table(Data %>% filter(plan_name == "Texas Teacher Retirement System"))


Data$year <- as.numeric(Data$year)
Data$ava <- as.numeric(Data$ava)
Data$aal <- as.numeric(Data$aal)
Data$unfunded_actuarially_accrued_liabilities_dollar <- as.numeric(Data$unfunded_actuarially_accrued_liabilities_dollar)
#Manually calculating 2021 AVA (AAL - UAL)
#Data$ava[21] <- Data$aal[21] - Data$unfunded_actuarially_accrued_liabilities_dollar[21]
########areaPlot

areaPlot <- function(data, title = NULL, caption = FALSE, grid = FALSE, 
                     yaxisScale = 1e-06, 
                     maxYear = 2021,
                     labelY = "Unfunded Accrued Actuarial Liabilities (Millions)",
                     ticks = TRUE, sp500 = FALSE, font) 
{
  
  
  plotTheme <- ggplot2::theme(   panel.grid.major = element_blank(),
                                 panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                 plot.margin = margin(0,0,0,0, "cm"),
                                 axis.text.y = element_text(size=12, color = "black"),
                                 axis.text.x = element_text(size=12, color = "black", angle = 0, hjust = 0.5, vjust = -1),
                                 axis.title = element_text(size = 12, face = "bold"),
                                 legend.text = element_text(size = 12),
                                 legend.title = element_blank(),
                                 text = element_text(family = "Calibri"))
  
  if (isTRUE(sp500)) {
    urlfile2 = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/S%26P500.csv"
    SP500 <- read_csv(url(urlfile2), col_names = TRUE, na = c(""), 
      skip_empty_rows = TRUE, col_types = NULL)
    SP500 <- SP500 %>% filter(year >= min(data$year) & year < (maxYear+1))
    data <- cbind(data, SP500[, 2])
    graph <- data.frame(data %>% select(year, SP500 = sp_500, 
      funded_ratio) %>% tidyr::drop_na())
  }
  else {
    data <- as.data.table(data)
    data <- data %>% filter(year < (maxYear+1))
    data$uaal <- (data$unfunded_actuarially_accrued_liabilities_dollar)
    data <- data %>% dplyr::filter(data$uaal != 0)
    extrapo <- stats::approx(data$year, data$uaal, n = 10000)
    extrapo2 <- stats::approx(data$year, data$funded_ratio, 
      n = 10000)
    graph <- data.frame(year = extrapo$x, uaal = extrapo$y, 
      funded_ratio = extrapo2$y) %>% tidyr::drop_na()
    graph <- graph %>% dplyr::mutate(sign = dplyr::case_when(.data$uaal >= 
      0 ~ "positive", .data$uaal < 0 ~ "negative"))
  }
  graph$funded_ratio <- as.numeric(graph$funded_ratio)
  graph$year <- as.numeric(graph$year)
  if (!isTRUE(sp500)) {
    graph$uaal <- as.numeric(graph$uaal)
  }
  y_minimum <- as.numeric(min(if (!isTRUE(sp500)) {
    min(graph$uaal,0)
  } else {
    0
  }))
  y_maximum <- as.numeric(max(if (!isTRUE(sp500)) {
    graph$uaal
  } else {
    graph$SP500
  }))
  reasontheme::set_reason_theme(style = "slide")
  
  #annotation <- data.frame(
  # x = c(2004, 2018),
  # y = c(10/yaxisScale, 20/yaxisScale),
  # label = c(paste("FYE 2001:",round(data.table(Data$ava/Data$aal)[1]*100,1),"%"), "2020 FR")
  # )
  
  ggplot2::ggplot(graph, ggplot2::aes(x = graph$year)) + ggplot2::geom_area(ggplot2::aes(y = if (!isTRUE(sp500)) {
    graph$uaal
  }
  else {
    graph$SP500
  }, fill = if (!isTRUE(sp500)) {
    graph$sign
  }
  else {
    palette_reason$Orange
  })) + ggplot2::geom_line(ggplot2::aes(y = graph$funded_ratio * 
    (y_maximum)), color = palette_reason$GreyBlue, size = 1.5) + 
    ggplot2::labs(y = if (!isTRUE(sp500)) {
      labelY
    }
    else {
      "S&P500 Index"
    }, x = NULL) + ggplot2::scale_fill_manual(values = if (!isTRUE(sp500)) {
    c(negative = paste(palette_reason$Green), positive = paste(palette_reason$Red))
  }
  else {
    c(paste(palette_reason$Yellow))
  }) + ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 10), 
    labels = scales::dollar_format(prefix = if (!isTRUE(sp500)) {
      "$"
    }
    else {
      ""
    }, scale = if (!isTRUE(sp500)) {
      (yaxisScale)
    }
    else {
      1
    }, largest_with_cents = if (!isTRUE(sp500)) {
      1
    }
    else {
      0.001
    }), limits = c(y_minimum, y_maximum * 1.2), sec.axis = ggplot2::sec_axis(~./(y_maximum/100), 
      breaks = scales::pretty_breaks(n = 10), name = "Funded Ratio", 
      labels = function(b) {
        paste0(round(b, 0), "%")
      }), expand = c(0, 0)) + geom_hline(yintercept = 0, 
    linetype = "solid", color = "black", size = 0.5) + labs(title = paste(title), 
    caption = ifelse(isTRUE(caption), paste("reason.org/pensions"), 
      paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) + ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(plot.margin = margin(0, 0,0,0, "cm"))+
    ggplot2::theme(panel.border = element_blank(),axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    coord_cartesian(expand = FALSE, xlim = c(min(graph$year), 
      max(graph$year)), ylim = c(y_minimum, y_maximum * 
      1.2)) + ggplot2::scale_x_continuous(breaks = round(seq(min(graph$year), 
    maxYear, by = 2), 1), expand = c(0, 0)) + ggplot2::theme(legend.position = "none") + 
    ggplot2::theme(text = element_text(family = paste(font), 
      size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid),
    paste(palette_reason$SpaceGrey), "white"), size = (1)))+ plotTheme 
  # + geom_text(data=annotation, aes(x=x, y=y, label=label),
  #         color="black", 
  #         size=5 , angle=0, fontface="bold" )
}
####

debtTRS <-
  areaPlot(
    Data,
    title = "",
    yaxisScale = 1e-09, 
    labelY = "Unfunded Accrued Actuarial Liabilities (Billions)",
    maxYear = 2021,
    caption = FALSE,
    font = "Calibri",
    grid = F,
    ticks = F,
    sp500 = F
  )

debtTRS

#debt <- areaPlot(Data, title = "", caption = FALSE, grid = F, ticks = F, sp500 = TRUE)
#debt
```

### TxTRS UAL #2 (2001-2021) w/ R (areaPlot())

```{r debt2, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial valuation reports.", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

rm(list = ls())

###Load/install packages
#R.Version()
#https://github.com/ReasonFoundation/pensionviewr
#Create token -> usethis::edit_r_environ() -> restart -> Sys.getenv("GITHUB_PAT")
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
#devtools::install_github(
#  "ANiraula/pensionviewr_private",
#   ref = "master", auth_token = "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")
library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(plyr)
library(dplyr)

###
##Pull PERSI data
##Load list of plans
pl <- planList()

#############
pullStateData <- function (FY)
{
  con <- RPostgres::dbConnect(
    RPostgres::Postgres(),
    dbname = "d629vjn37pbl3l",
    host = "ec2-3-209-200-73.compute-1.amazonaws.com",
    port = 5432,
    user = "reason_readonly",
    password = "p88088bd28ea68027ee96c65996f7ea3b56db0e27d7c9928c05edc6c23ef2bc27",
    sslmode = "require")
  
  query <- paste("select * from pull_data_state_only()\nwhere year > '",
                 paste(FY - 1), "'\nand attribute_name in ('1 Year Investment Return Percentage',
                 \n'PPD ID',
                 \n'Number of Employers',
                 \n'Number of Plans',\n'Actuarial Cost Method in GASB Reporting',
                 \n'Employer Normal Cost Percentage',
                 \n'Total Normal Cost Dollar',\n'Actuarial Funded Ratio Percentage',
                 \n'Market Investment Return (MVA Basis)',
                 \n'Actuarial Value of Assets GASB Dollar',
                 \n'Market Value of Assets Dollar',
                 \n'Market Assets Reported for Asset Smoothing',
                 \n'Actuarially Accrued Liabilities Dollar',
                 \n'Total Pension Liability Dollar',
                 \n'Actuarially Determined Contribution Percentage of Payroll',
                 \n'Actuarially Required Contribution Dollar',
                 \n'Actuarially Required Contribution Paid Percentage',
                 \n'Total Employer Contributions',
                 \n'Statutory Payment Dollar',
                 \n'Statutory Payment Percentage',
                 \n'Amortizaton Method',
                 \n'Total Benefits Paid Dollar',
                 \n'Benefit Payments Dollar',
                 \n'Refunds Dollar',
                 \n'Administrative Expense Dollar',
                 \n'Cost Structure',
                 \n'Asset Valuation Method for GASB Reporting',
                 \n'Covered Payroll Dollar',
                 \n'Employee Contribution Dollar',
                 \n'Employee Normal Cost Percentage',
                 \n'Employer Contribution Regular Dollar',
                 \n'Employer Normal Cost Dollar',
                 \n'Employer State Contribution Dollar',
                 \n'ADEC as a Percent of Payroll',
                 \n'Other Contribution Dollar',
                 \n'Other Additions',
                 \n'Fiscal Year of Contribution',
                 \n'Inflation Rate Assumption For GASB Reporting',
                 \n'Investment Return Assumption for GASB Reporting',
                 \n'Discount Rate Assumption',
                 \n'Number of Years Remaining on Amortization Schedule',
                 \n'Payroll Growth Assumption',
                 \n'Unfunded Actuarially Accrued Liabilities Dollar',
                 \n'Total Contribution Dollar',
                 \n'Total Normal Cost Percentage',
                 \n'Net Pension Liability Dollar',
                 \n'Net Pension Liability Assuming 1% Decrease in Discount Rate',
                 \n'Net Pension Liability Assuming 1% Increase in Discount Rate',
                 \n'Total Number Of Members',
                 \n'Total Projected Actuarial Required Contribution Percentage Of Payroll',
                 \n'Actuarially Required Contribution Paid Dollar',
                 \n'Actuarially Determined Contribution Paid Dollar',
                 \n'Type of Employees Covered',
                 \n'Total Amortization Payment Percentage',
                 \n'Wage Inflation')")
  result <- RPostgres::dbSendQuery(con, query)
  all_data <- RPostgres::dbFetch(result) %>% janitor::clean_names()
  RPostgres::dbClearResult(result)
  RPostgres::dbDisconnect(con)
  all_data %>% dplyr::group_by_at(dplyr::vars(-.data$attribute_value)) %>%
    dplyr::mutate(row_id = 1:dplyr::n()) %>% dplyr::ungroup() %>%
    tidyr::pivot_wider(names_from = attribute_name, values_from = attribute_value) %>%
    dplyr::select(-.data$row_id) %>% 
    dplyr::arrange(display_name, year) %>%
    janitor::clean_names()
}

###########

filterAssets2 <- function (data, fy = 2001, plan = NULL) {
  data <- data.frame(data)
  
  data[, 5:83] <- data[, 5:83] %>% mutate_all(as.numeric)
  data <- data %>% replace(is.na(.), 0)
  data$year <- as.numeric(data$year)
  
  assets <- data %>% select(year, display_name, state, contains("percent")) %>%
    
    mutate(private.equity = percent_of_assets_invested_in_private_equity, 
           real.estate =  percent_of_assets_invested_in_real_estate, 
           hedge = percent_of_assets_invested_in_hedge_funds,
           commodities = percent_of_assets_invested_in_commodities,
           other.alternatives = percent_of_assets_invested_in_misc_alternatives + percent_of_assets_invested_in_other_investments,
           equity = percent_of_assets_invested_in_equity_investments_total,
           fixed = percent_of_assets_invested_in_fixed_income, 
           cash = percent_of_assets_invested_in_cash) %>% 
    select( -contains("percent")
    )
  
  
  if (!is.null(plan)) {
    assets <- assets %>% filter(display_name == plan)
  }
  assets$total <- 0
  y <- as.numeric(length(assets$total))
  assets[, 4:11] <- assets[, 4:11] %>% mutate_all(as.numeric)
  for (i in (1:y)) {
    assets$total[i] <- sum(assets[i, 4:11])
  }
  
  assets$total <- as.numeric(assets$total)
  
  
  colnames(assets) <- c("year", "Plan", "State", "Private Equity", 
                        "Real Estate", "Hedge Funds", "Commodities", "Other Alternatives", 
                        "Total Equity", "Fixed Income", "Cash Equivalents", 
                        "Total")
  
  assets <- assets %>% 
    filter(year >= fy) %>% 
    select(-Total)
  
  assets
}

#########
# Filter Downloaded Data -------------------------------------------------------------

filterData2 <- function(Data, fy = 2001,
                        inflation = TRUE,
                        expenditure = TRUE,
                        employee = NULL,
                        sp500 = TRUE,
                        dcData = TRUE,
                        treasury = TRUE,
                        blend.teacher = FALSE,
                        source = FALSE) {
  if (isTRUE(blend.teacher)) {
    blended.teach <- c("Arizona State Retirement System",
                       "Delaware State Employees’ Pension Plan", "District of Columbia Teachers Retirement Fund",
                       "Florida Retirement System", "Employee Retirement System of Hawaii",
                       "Idaho Public Employee Retirement System", "Iowa Public Employees' Retirement System",
                       "Kansas Public Employees' Retirement System", "Public Employees' Retirement System of Mississippi",
                       "Nevada Public Employees Retirement System", "New Hampshire Retirement System",
                       "North Carolina Teachers' and State Employees' Retirement System",
                       "Oregon Public Employees Retirement System", "Rhode Island Employees Retirement System",
                       "South Carolina Retirement Systems", "South Dakota Retirement System",
                       "Tennessee Consolidated Retirement System, Teachers Pension Plan",
                       "Utah Retirement Systems, Noncontributory Retirement System",
                       "Virginia Retirement System", "Wisconsin Retirement System",
                       "Wyoming Retirement System, Public Employees’ Pension Plan",
                       "Maine Public Employees Retirement System (PERS) Defined Benefit Plan",
                       "Maryland State Employees’ Retirement System")
    Data <- data.frame(Data)
    Data <- Data %>% mutate(type_of_employees_covered = case_when(display_name %in%
                                                                    blended.teach ~ "Plan covers state, local and teachers",
                                                                  TRUE ~ type_of_employees_covered))
  }
  Data <- data.frame(Data)
  columns <- c("total_pension_liability_dollar", "wage_inflation",
               "payroll_growth_assumption", "other_contribution_dollar",
               "other_additions_dollar", "x1_year_investment_return_percentage",
               "amortizaton_method", "number_of_years_remaining_on_amortization_schedule",
               "amortization_payment_total_amount",
               "x1_year_investment_return_percentage",
               "total_normal_cost_dollar", "fiscal_year_of_contribution",
               "statutory_payment_dollar", "statutory_payment_percentage",
               "ppd_fund_id", "number_of_employers", "number_of_plans", "ppd_id",
               "discount_rate_assumption", "market_investment_return_mva_basis", 
               "actuarially_determined_contribution_dollar",
               "net_pension_liability_dollar",
               "administrative_expense_dollar",
               "employer_state_contribution_dollar",
               "total_amortization_payment_percentage",
               "type_of_employees_covered",
               "total_contribution_dollar",
               "employer_contribution_regular_dollar",
               "actuarial_cost_method_in_gasb_reporting",
               "net_pension_liability_assuming_1_percent_decrease_in_discount_rate",
               "net_pension_liability_assuming_1_percent_increase_in_discount_rate",
               "actuarially_required_contribution_paid_dollar",
               "actuarially_required_contribution_paid_percentage",
               "total_benefits_paid_dollar",
               "benefit_payments_dollar",
               "refunds_dollar",
               "actuarially_determined_contribution_paid_dollar",
               "cost_structure", "employer_normal_cost_percentage", "actuarial_value_of_assets_dollar",
               "asset_valuation_method_for_gasb_reporting", "inflation_rate_assumption",
               "total_number_of_members", "total_projected_actuarial_required_contribution_percentage_of_payroll",
               "market_assets_reported_for_asset_smoothing")
  columns2 <- c("test")
  for (i in (1:length(columns))) {
    if (sum(colnames(Data) %in% columns[i]) == 0) {
      columns2 <- rbind(columns2, columns[i])
    }
  }
  columns2 <- as.character(columns2 <- columns2[2:length(columns2)])
  cols <- matrix(NA, length(Data[, 1]), length(columns2))
  colnames(cols) <- columns2
  Data <- cbind(Data, cols)
  Data <- data.frame(Data)
  Data <- Data %>% arrange(state, display_name, year)
  Data$year <- as.numeric(Data$year)
  if (isTRUE(inflation)) {
    library(readxl)
    library(httr)
    url1 <- "https://github.com/ReasonFoundation/databaseR/raw/master/files/CPI_by_Region_DOL.xlsx"
    GET(url1, write_disk(tf <- tempfile(fileext = ".xlsx")))
    cpi <- read_excel(tf, sheet = 1)
    regions <- read_excel(tf, sheet = 2)
    cpi <- data.table(cpi)
    regions <- data.table(regions)
    cpi$cpi_change <- NA
    for (i in (2:length(cpi$region))) {
      cpi$cpi_change[i] <- (cpi$cpi[i]/cpi$cpi[i - 1]) -
        1
    }
    Data <- Data %>% left_join(regions, by = "state")
    Data <- Data %>% left_join(cpi, by = c("year", "region"))
    Data <- Data %>% select(-cpi)
  }
  
  if (isTRUE(sp500)) {
  urlfile2 = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/S%26P500.csv"
  

  SP500 <- data.table(
    read_csv(url(urlfile2), col_names = TRUE, na = c(""), 
                    skip_empty_rows = TRUE, col_types = NULL))

    Data <- Data %>% left_join(SP500, by = c("year"))
  
  }
  
  if (isTRUE(dcData)) {
    
  #Data <- data.table(pullStateData(2001))
   
  urlfile3 = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/DCPlanData.csv"
  
  DCPlanData <- data.table(
    read_csv(url(urlfile3), col_names = TRUE, na = c(""), 
             skip_empty_rows = TRUE, col_types = NULL))
  
  DCPlanData <- DCPlanData %>% 
    select(year = fy, ppd_id, plantype,
           ee_contrate_mandatory, er_contrate_fixedrate, 
           planname, primary,
           eligible_eegroups, assets, members_total, actives, inactives, coveredpayroll) %>% 
    replace(is.na(.), 0)
  
  DCPlanData$ppd_id <- as.numeric(DCPlanData$ppd_id)
  DCPlanData$fy <- as.numeric(DCPlanData$fy)
  DCPlanData$er_contrate_fixedrate <- as.numeric(DCPlanData$er_contrate_fixedrate)
  DCPlanData$ee_contrate_mandatory <- as.numeric(DCPlanData$ee_contrate_mandatory)
  DCPlanData$assets <- as.numeric(DCPlanData$assets)
  DCPlanData$members_total <- as.numeric(DCPlanData$members_total)
  DCPlanData$actives <- as.numeric(DCPlanData$actives)
  DCPlanData$inactives <- as.numeric(DCPlanData$inactives)
  
  for(i in (1:length(DCPlanData$members_total))){
  
  DCPlanData$members_total[i] <- max(DCPlanData$members_total[i], (DCPlanData$actives[i]+DCPlanData$inactives[i]))
  
  }
  
  Data$ppd_id <- as.numeric(Data$ppd_id)
  Data$year<- as.numeric(Data$year)
  
  Data <- Data %>% left_join(DCPlanData, by = c("ppd_id", "year"))

  }
  if (isTRUE(treasury)) {
  urlfile <- "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/treasury.csv"
  treasury <- data.table(
    read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL))
  
  colnames(treasury)[2] <- "treasury_30"
  Data <- Data %>% left_join(treasury, by = c("year"))

  }
  
  if (isTRUE(expenditure)) {

    #1. General Fund Exp./Rev. NASBO (State)
    #2. Total Exp./Rev. NASBO (State) --> general funds, other state funds, bonds, and federal funds.
    #3. Total Exp./Rev. Urban (State & Local) --> state and local direct general expenditures (exclude “business-like” activities such as utilities and transfers between state and local governments.)

    library(readxl)
    library(httr)
    urlfile="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/NASBO_Exp_Report_Data_v1.csv"
    NASBO<-read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    NASBO <- setDT(NASBO)
    NASBO <- NASBO %>% select(YEAR, STATE,"TOTAL_CAPI") %>% filter(YEAR>2000)
    #View(NASBO)
    colnames(NASBO)[1] <- "year"
    colnames(NASBO)[2] <- "state"
    Data <- Data %>% left_join(NASBO, by = c("year","state"))
    ####
    urlfile="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/UrbanCensus_ExpRev_2000-2018.csv"
    Urban<-read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    Urban <- setDT(Urban)

    Urban <- Urban %>% select(Year, State,"(R01) Total Revenue", "(E001) Total Expenditure")

    colnames(Urban)[1] <- "year"
    colnames(Urban)[2] <- "state"
     
    Data <- Data %>% left_join(Urban, by = c("year","state"))

  }

  Data <- Data %>% select(year, plan_name = display_name,
                          state, if (isTRUE(source)) {
                            "data_source_name"
                          }, return_1yr = x1_year_investment_return_percentage,
                          ava_return = market_investment_return_mva_basis, actuarial_cost_method_in_gasb_reporting,
                          funded_ratio = actuarial_funded_ratio_percentage, ava = actuarial_value_of_assets_gasb_dollar, #actuarial_value_of_assets_gasb_dollar (PPD)
                          mva = market_value_of_assets_dollar, #mva_smooth = market_assets_reported_for_asset_smoothing,
                          aal = actuarially_accrued_liabilities_dollar,
                          adec1 = actuarially_determined_contribution_dollar,
                          adec2 =   actuarially_required_contribution_paid_dollar,  #actuarially_required_contribution_dollar (PPD)
                          adec_paid_pct = actuarially_required_contribution_paid_percentage,
                          adec_pct = adec_as_a_percent_of_payroll, #instead of employers_projected_actuarial_required_contribution
                          arc_paid_dollar = actuarially_required_contribution_paid_dollar, #NEW
                          adec_paid_dollar = actuarially_determined_contribution_paid_dollar,#NEW
                          statutory = statutory_payment_dollar, statutory_pct = statutory_payment_percentage,
                          amortizaton_method, total_benefit_payments = total_benefits_paid_dollar,
                          benefit_payments = benefit_payments_dollar, refunds = refunds_dollar,
                          admin_exp = administrative_expense_dollar, cost_structure,
                          state_exp_NASBO = TOTAL_CAPI, #gf_rev_NASBO = "TOTAL REV",
                          state.local_exp_Census = "(R01) Total Revenue", state.local_rev_Census = "(E001) Total Expenditure",
                          fund_id = ppd_fund_id, ppd_id = ppd_id, employers = number_of_employers,
                          plans = number_of_plans, asset_valuation_method_for_gasb_reporting,
                          dc_plantype = plantype,  dc_er_pct = er_contrate_fixedrate, #dc_eligble = eligible_eegroups,
                          dc_ee_pct = ee_contrate_mandatory, dc_plan = planname, dc_primary = primary,
                          dc_assets = assets, dc_members = members_total, dc_payroll = coveredpayroll,
                          payroll = covered_payroll_dollar, ee_contribution = employee_contribution_dollar,
                          ee_nc_pct = employee_normal_cost_percentage,
                          er_nc_pct = employer_normal_cost_percentage,total_nc_pct = total_normal_cost_percentage, 
                          er_contribution = employer_contribution_regular_dollar, er_state_contribution = employer_state_contribution_dollar,
                          other_contribution = other_contribution_dollar, other_additions = other_additions_dollar,
                          fy_contribution = fiscal_year_of_contribution, inflation_assum = inflation_rate_assumption,
                          arr = investment_return_assumption_for_gasb_reporting,
                          dr = discount_rate_assumption, number_of_years_remaining_on_amortization_schedule,
                          payroll_growth_assumption, total_amortization_payment_pct = total_amortization_payment_percentage,
                          total_amo_payment = amortization_payment_total_amount, #Added
                          total_contribution = total_contribution_dollar,
                          total_nc_dollar = total_normal_cost_dollar, total_number_of_members,
                          total_proj_adec_pct = total_projected_actuarial_required_contribution_percentage_of_payroll,
                          tpl = total_pension_liability_dollar,
                          npl_pct_down = net_pension_liability_assuming_1_percent_decrease_in_discount_rate, #Added
                          npl = net_pension_liability_dollar, #Added
                          npl_pct_up = net_pension_liability_assuming_1_percent_increase_in_discount_rate, #Added
                          type_of_employees_covered, unfunded_actuarially_accrued_liabilities_dollar,
                          wage_inflation, region, cpi_change, sp_500, treasury_30)

  
  ## Combining ARC & ADEC
  Data$state.local_exp_Census <- as.numeric(Data$state.local_exp_Census)
  Data$state.local_rev_Census <- as.numeric(Data$state.local_exp_Census)
  Data$state_exp_NASBO <- as.numeric(Data$state_exp_NASBO)
  Data$dc_primary <- ifelse(Data$dc_primary == 1, "Yes", "No")
  
  Data$adec1 <- as.numeric(Data$adec1)
  Data$adec2 <- as.numeric(Data$adec2)
  Data$adec_paid_dollar <- as.numeric(Data$adec_paid_dollar)
  Data$arc_paid_dollar <- as.numeric(Data$arc_paid_dollar)
  Data$arc_adec_dollar <- ifelse(is.na(Data$adec1) == TRUE,Data$adec2, Data$adec1)
  Data$arc_adec_paid_dollar <- ifelse(is.na(Data$arc_paid_dollar) == TRUE,
                               ifelse(is.na(Data$statutory_payment_dollar) == TRUE,statutory_payment_dollar, 
                                      Data$adec_paid_dollar), 
                                      Data$arc_paid_dollar)
  
  Data$fy_contribution <- as.numeric(Data$fy_contribution)
  Data$year <- as.numeric(Data$year)
  Data$fy_contribution <- round(Data$fy_contribution, 0)
  Data <- Data %>% filter(year >= fy) #%>% select(-adec1, -adec2)

  #https://www.urban.org/policy-centers/cross-center-initiatives/state-and-local-finance-initiative/projects/state-fiscal-briefs/florida

  if (isTRUE(expenditure)) {
   Data$ava <- as.numeric(Data$ava)
   Data$aal <- as.numeric(Data$aal)
   Data$state_exp_NASBO <- as.numeric(Data$state_exp_NASBO)
   Data$state.local_exp_Census <- as.numeric(Data$state.local_exp_Census)
   Data <- Data %>% group_by(state, year) %>% mutate(ual_exp_NASBO = round((sum(aal)-sum(ava))/(state_exp_NASBO*1000000),2),
                                                     ual_exp_Census = round((sum(aal)-sum(ava))/(state.local_exp_Census*1000),2))
  }

  if (is_null(employee)) {
    employee <- employee
  }
  else if (employee == "teacher") {
    employee <- c("Plan covers teachers")
  }
  else if (employee == "state and local") {
    employee <- c("Plan covers state and local employees")
  }
  else if (employee == "police and fire") {
    employee <- c("Plan covers police and/or fire")
  }
  else if (employee == "state") {
    employee <- c("Plan covers state employees")
  }
  else if (employee == "local") {
    employee <- c("Plan covers local employees")
  }
  else if (employee == "state, local, and teachers") {
    employee <- c("Plan covers state, local and teachers")
  }
  if (is_null(employee)) {
    Data <- data.frame(Data) %>% replace(is.na(.), 0)
  }
  else {
    Data %>% filter(type_of_employees_covered == paste(employee)) %>% replace(is.na(.), 0)
  }
}

#PULL DATA
Data <- pullStateData(2001)
Data <- filterData2(Data, 2001)
#View(Data)
Data <-
  data.table(Data) %>% filter(plan_name == "Texas Teacher Retirement System")

Data$year <- as.numeric(Data$year)
Data$ava <- as.numeric(Data$ava)
Data$aal <- as.numeric(Data$aal)
Data$unfunded_actuarially_accrued_liabilities_dollar <- as.numeric(Data$unfunded_actuarially_accrued_liabilities_dollar)
#Manually calculating 2021 AVA (AAL - UAL)
#Data$ava[21] <- Data$aal[21] - Data$unfunded_actuarially_accrued_liabilities_dollar[21]

########areaPlot

areaPlot2 <- function(data, title = NULL, caption = FALSE, grid = FALSE, 
                     yaxisScale = 1e-06, 
                     maxYear = 2021,
                     labelY = "Unfunded Accrued Actuarial Liabilities (Millions)",
                     ticks = TRUE, sp500 = FALSE, font) 
{
  
  
  plotTheme <- ggplot2::theme(   panel.grid.major = element_blank(),
                                 panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                 plot.margin = margin(0,0.5,0,0, "cm"),
                                 axis.text.y = element_text(size=12, color = "black"),
                                 axis.text.x = element_text(size=12, color = "black", angle = 0, hjust = 0.5, vjust = -1),
                                 axis.title = element_text(size = 12, face = "bold"),
                                 legend.text = element_text(size = 12),
                                 legend.title = element_blank(),
                                 text = element_text(family = "Calibri"))
  
  if (isTRUE(sp500)) {
    urlfile2 = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/S%26P500.csv"
    SP500 <- read_csv(url(urlfile2), col_names = TRUE, na = c(""), 
      skip_empty_rows = TRUE, col_types = NULL)
    SP500 <- SP500 %>% filter(year >= min(data$year) & year < (maxYear+1))
    data <- cbind(data, SP500[, 2])
    graph <- data.frame(data %>% select(year, SP500 = sp_500, 
      funded_ratio) %>% tidyr::drop_na())
  }
  else {
    data <- as.data.table(data)
    data <- data %>% filter(year < (maxYear+1))
    data$uaal <- (data$unfunded_actuarially_accrued_liabilities_dollar)
    data <- data %>% dplyr::filter(data$uaal != 0)
    extrapo <- stats::approx(data$year, data$uaal, n = 10000)
    extrapo2 <- stats::approx(data$year, data$funded_ratio, 
      n = 10000)
    graph <- data.frame(year = extrapo$x, uaal = extrapo$y, 
      funded_ratio = extrapo2$y) %>% tidyr::drop_na()
    graph <- graph %>% dplyr::mutate(sign = dplyr::case_when(.data$uaal >= 
      0 ~ "positive", .data$uaal < 0 ~ "negative"))
  }
  graph$funded_ratio <- as.numeric(graph$funded_ratio)
  graph$year <- as.numeric(graph$year)
  if (!isTRUE(sp500)) {
    graph$uaal <- as.numeric(graph$uaal)
  }
  y_minimum <- as.numeric(min(if (!isTRUE(sp500)) {
    min(graph$uaal,0)
  } else {
    0
  }))
  y_maximum <- as.numeric(max(if (!isTRUE(sp500)) {
    graph$uaal
  } else {
    graph$SP500
  }))
  reasontheme::set_reason_theme(style = "slide")
  
  #annotation <- data.frame(
  # x = c(2004, 2018),
  # y = c(10/yaxisScale, 20/yaxisScale),
  # label = c(paste("FYE 2001:",round(data.table(Data$ava/Data$aal)[1]*100,1),"%"), "2020 FR")
  # )
  
  ggplot2::ggplot(graph, ggplot2::aes(x = graph$year)) + 
    ggplot2::geom_line(ggplot2::aes(y = if (!isTRUE(sp500)) {
    graph$uaal
  }
  else {
    graph$SP500
  }, fill = if (!isTRUE(sp500)) {
    palette_reason$DarkGrey
  }
  else {
    palette_reason$DarkGrey
  }), size = 1) + 
    ggplot2::labs(y = if (!isTRUE(sp500)) {
      labelY
    }
    else {
      "S&P500 Index"
    }, x = NULL) + ggplot2::scale_fill_manual(values = if (!isTRUE(sp500)) {
    c(negative = paste(palette_reason$Green), positive = "black")
  }
  else {
    c(paste(palette_reason$Yellow))
  }) + ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 10), 
    labels = scales::dollar_format(prefix = if (!isTRUE(sp500)) {
      "$"
    }
    else {
      ""
    }, scale = if (!isTRUE(sp500)) {
      (yaxisScale)
    }
    else {
      1
    }, largest_with_cents = if (!isTRUE(sp500)) {
      1
    }
    else {
      0.001
    }), limits = c(y_minimum, y_maximum * 1.2)) + geom_hline(yintercept = 0, 
    linetype = "solid", color = "black", size = 0.5) + labs(title = paste(title), 
    caption = ifelse(isTRUE(caption), paste("reason.org/pensions"), 
      paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) + ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) +
    ggplot2::theme(panel.border = element_blank(),axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    coord_cartesian(expand = FALSE, xlim = c(min(graph$year), 
      max(graph$year)), ylim = c(y_minimum, y_maximum * 
      1.2)) + ggplot2::scale_x_continuous(breaks = round(seq(min(graph$year), 
    maxYear, by = 2), 1), expand = c(0, 0)) + ggplot2::theme(legend.position = "none") + 
    ggplot2::theme(text = element_text(family = paste(font), 
      size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid),
    paste(palette_reason$SpaceGrey), "white"), size = (1)))+ plotTheme 
  # + geom_text(data=annotation, aes(x=x, y=y, label=label),
  #         color="black", 
  #         size=5 , angle=0, fontface="bold" )
}
####

debt2 <-
  areaPlot2(
    Data,
    title = "",
    yaxisScale = 1e-09, 
    labelY = "Unfunded Accrued Actuarial Liabilities (Billions)",
    maxYear = 2021,
    caption = FALSE,
    font = "Calibri",
    grid = F,
    ticks = F,
    sp500 = F
  )

debt2

#debt <- areaPlot(Data, title = "", caption = FALSE, grid = F, ticks = F, sp500 = TRUE)
#debt
```

### A History of TxTRS Weakening Solvency \#2 (2001/2021) w/ R (table)

```{r}

rm(list = ls())

###Load/install packages
#R.Version()
#https://github.com/ReasonFoundation/pensionviewr
#Create token -> usethis::edit_r_environ() -> restart -> Sys.getenv("GITHUB_PAT")
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
# devtools::install_github(
#   "ANiraula/pensionviewr_private",
#    ref = "master", auth_token = "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")

library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(plyr)
library(dplyr)

###
##Pull PERSI data
##Load list of plans
pl <- planList()

#############

pl <- planList()

#############
pullStateData <- function (FY)
{
  con <- RPostgres::dbConnect(
    RPostgres::Postgres(),
    dbname = "d629vjn37pbl3l",
    host = "ec2-3-209-200-73.compute-1.amazonaws.com",
    port = 5432,
    user = "reason_readonly",
    password = "p88088bd28ea68027ee96c65996f7ea3b56db0e27d7c9928c05edc6c23ef2bc27",
    sslmode = "require")
  
  query <- paste("select * from pull_data_state_only()\nwhere year > '",
                 paste(FY - 1), "'\nand attribute_name in ('1 Year Investment Return Percentage',
                 \n'PPD ID',
                 \n'Number of Employers',
                 \n'Number of Plans',\n'Actuarial Cost Method in GASB Reporting',
                 \n'Employer Normal Cost Percentage',
                 \n'Total Normal Cost Dollar',\n'Actuarial Funded Ratio Percentage',
                 \n'Market Investment Return (MVA Basis)',
                 \n'Actuarial Value of Assets GASB Dollar',
                 \n'Market Value of Assets Dollar',
                 \n'Market Assets Reported for Asset Smoothing',
                 \n'Actuarially Accrued Liabilities Dollar',
                 \n'Total Pension Liability Dollar',
                 \n'Actuarially Determined Contribution Percentage of Payroll',
                 \n'Actuarially Required Contribution Dollar',
                 \n'Actuarially Required Contribution Paid Percentage',
                 \n'Total Employer Contributions',
                 \n'Statutory Payment Dollar',
                 \n'Statutory Payment Percentage',
                 \n'Amortizaton Method',
                 \n'Total Benefits Paid Dollar',
                 \n'Benefit Payments Dollar',
                 \n'Refunds Dollar',
                 \n'Administrative Expense Dollar',
                 \n'Cost Structure',
                 \n'Asset Valuation Method for GASB Reporting',
                 \n'Covered Payroll Dollar',
                 \n'Employee Contribution Dollar',
                 \n'Employee Normal Cost Percentage',
                 \n'Employer Contribution Regular Dollar',
                 \n'Employer Normal Cost Dollar',
                 \n'Employer State Contribution Dollar',
                 \n'ADEC as a Percent of Payroll',
                 \n'Other Contribution Dollar',
                 \n'Other Additions',
                 \n'Fiscal Year of Contribution',
                 \n'Inflation Rate Assumption For GASB Reporting',
                 \n'Investment Return Assumption for GASB Reporting',
                 \n'Discount Rate Assumption',
                 \n'Number of Years Remaining on Amortization Schedule',
                 \n'Payroll Growth Assumption',
                 \n'Unfunded Actuarially Accrued Liabilities Dollar',
                 \n'Total Contribution Dollar',
                 \n'Total Normal Cost Percentage',
                 \n'Net Pension Liability Dollar',
                 \n'Net Pension Liability Assuming 1% Decrease in Discount Rate',
                 \n'Net Pension Liability Assuming 1% Increase in Discount Rate',
                 \n'Total Number Of Members',
                 \n'Total Projected Actuarial Required Contribution Percentage Of Payroll',
                 \n'Actuarially Required Contribution Paid Dollar',
                 \n'Actuarially Determined Contribution Paid Dollar',
                 \n'Type of Employees Covered',
                 \n'Total Amortization Payment Percentage',
                 \n'Wage Inflation')")
  result <- RPostgres::dbSendQuery(con, query)
  all_data <- RPostgres::dbFetch(result) %>% janitor::clean_names()
  RPostgres::dbClearResult(result)
  RPostgres::dbDisconnect(con)
  all_data %>% dplyr::group_by_at(dplyr::vars(-.data$attribute_value)) %>%
    dplyr::mutate(row_id = 1:dplyr::n()) %>% dplyr::ungroup() %>%
    tidyr::pivot_wider(names_from = attribute_name, values_from = attribute_value) %>%
    dplyr::select(-.data$row_id) %>% 
    dplyr::arrange(display_name, year) %>%
    janitor::clean_names()
}

###########

filterAssets2 <- function (data, fy = 2001, plan = NULL) {
  data <- data.frame(data)
  
  data[, 5:83] <- data[, 5:83] %>% mutate_all(as.numeric)
  data <- data %>% replace(is.na(.), 0)
  data$year <- as.numeric(data$year)
  
  assets <- data %>% select(year, display_name, state, contains("percent")) %>%
    
    mutate(private.equity = percent_of_assets_invested_in_private_equity, 
           real.estate =  percent_of_assets_invested_in_real_estate, 
           hedge = percent_of_assets_invested_in_hedge_funds,
           commodities = percent_of_assets_invested_in_commodities,
           other.alternatives = percent_of_assets_invested_in_misc_alternatives + percent_of_assets_invested_in_other_investments,
           equity = percent_of_assets_invested_in_equity_investments_total,
           fixed = percent_of_assets_invested_in_fixed_income, 
           cash = percent_of_assets_invested_in_cash) %>% 
    select( -contains("percent")
    )
  
  
  if (!is.null(plan)) {
    assets <- assets %>% filter(display_name == plan)
  }
  assets$total <- 0
  y <- as.numeric(length(assets$total))
  assets[, 4:11] <- assets[, 4:11] %>% mutate_all(as.numeric)
  for (i in (1:y)) {
    assets$total[i] <- sum(assets[i, 4:11])
  }
  
  assets$total <- as.numeric(assets$total)
  
  
  colnames(assets) <- c("year", "Plan", "State", "Private Equity", 
                        "Real Estate", "Hedge Funds", "Commodities", "Other Alternatives", 
                        "Total Equity", "Fixed Income", "Cash Equivalents", 
                        "Total")
  
  assets <- assets %>% 
    filter(year >= fy) %>% 
    select(-Total)
  
  assets
}

#########
# Filter Downloaded Data -------------------------------------------------------------

filterData2 <- function(Data, fy = 2001,
                        inflation = TRUE,
                        expenditure = TRUE,
                        employee = NULL,
                        sp500 = TRUE,
                        dcData = TRUE,
                        treasury = TRUE,
                        blend.teacher = FALSE,
                        source = FALSE) {
  if (isTRUE(blend.teacher)) {
    blended.teach <- c("Arizona State Retirement System",
                       "Delaware State Employees’ Pension Plan", "District of Columbia Teachers Retirement Fund",
                       "Florida Retirement System", "Employee Retirement System of Hawaii",
                       "Idaho Public Employee Retirement System", "Iowa Public Employees' Retirement System",
                       "Kansas Public Employees' Retirement System", "Public Employees' Retirement System of Mississippi",
                       "Nevada Public Employees Retirement System", "New Hampshire Retirement System",
                       "North Carolina Teachers' and State Employees' Retirement System",
                       "Oregon Public Employees Retirement System", "Rhode Island Employees Retirement System",
                       "South Carolina Retirement Systems", "South Dakota Retirement System",
                       "Tennessee Consolidated Retirement System, Teachers Pension Plan",
                       "Utah Retirement Systems, Noncontributory Retirement System",
                       "Virginia Retirement System", "Wisconsin Retirement System",
                       "Wyoming Retirement System, Public Employees’ Pension Plan",
                       "Maine Public Employees Retirement System (PERS) Defined Benefit Plan",
                       "Maryland State Employees’ Retirement System")
    Data <- data.frame(Data)
    Data <- Data %>% mutate(type_of_employees_covered = case_when(display_name %in%
                                                                    blended.teach ~ "Plan covers state, local and teachers",
                                                                  TRUE ~ type_of_employees_covered))
  }
  Data <- data.frame(Data)
  columns <- c("total_pension_liability_dollar", "wage_inflation",
               "payroll_growth_assumption", "other_contribution_dollar",
               "other_additions_dollar", "x1_year_investment_return_percentage",
               "amortizaton_method", "number_of_years_remaining_on_amortization_schedule",
               "amortization_payment_total_amount",
               "x1_year_investment_return_percentage",
               "total_normal_cost_dollar", "fiscal_year_of_contribution",
               "statutory_payment_dollar", "statutory_payment_percentage",
               "ppd_fund_id", "number_of_employers", "number_of_plans", "ppd_id",
               "discount_rate_assumption", "market_investment_return_mva_basis", 
               "actuarially_determined_contribution_dollar",
               "net_pension_liability_dollar",
               "administrative_expense_dollar",
               "employer_state_contribution_dollar",
               "total_amortization_payment_percentage",
               "type_of_employees_covered",
               "total_contribution_dollar",
               "employer_contribution_regular_dollar",
               "actuarial_cost_method_in_gasb_reporting",
               "net_pension_liability_assuming_1_percent_decrease_in_discount_rate",
               "net_pension_liability_assuming_1_percent_increase_in_discount_rate",
               "actuarially_required_contribution_paid_dollar",
               "actuarially_required_contribution_paid_percentage",
               "total_benefits_paid_dollar",
               "benefit_payments_dollar",
               "refunds_dollar",
               "actuarially_determined_contribution_paid_dollar",
               "cost_structure", "employer_normal_cost_percentage", "actuarial_value_of_assets_dollar",
               "asset_valuation_method_for_gasb_reporting", "inflation_rate_assumption",
               "total_number_of_members", "total_projected_actuarial_required_contribution_percentage_of_payroll",
               "market_assets_reported_for_asset_smoothing")
  columns2 <- c("test")
  for (i in (1:length(columns))) {
    if (sum(colnames(Data) %in% columns[i]) == 0) {
      columns2 <- rbind(columns2, columns[i])
    }
  }
  columns2 <- as.character(columns2 <- columns2[2:length(columns2)])
  cols <- matrix(NA, length(Data[, 1]), length(columns2))
  colnames(cols) <- columns2
  Data <- cbind(Data, cols)
  Data <- data.frame(Data)
  Data <- Data %>% arrange(state, display_name, year)
  Data$year <- as.numeric(Data$year)
  if (isTRUE(inflation)) {
    library(readxl)
    library(httr)
    url1 <- "https://github.com/ReasonFoundation/databaseR/raw/master/files/CPI_by_Region_DOL.xlsx"
    GET(url1, write_disk(tf <- tempfile(fileext = ".xlsx")))
    cpi <- read_excel(tf, sheet = 1)
    regions <- read_excel(tf, sheet = 2)
    cpi <- data.table(cpi)
    regions <- data.table(regions)
    cpi$cpi_change <- NA
    for (i in (2:length(cpi$region))) {
      cpi$cpi_change[i] <- (cpi$cpi[i]/cpi$cpi[i - 1]) -
        1
    }
    Data <- Data %>% left_join(regions, by = "state")
    Data <- Data %>% left_join(cpi, by = c("year", "region"))
    Data <- Data %>% select(-cpi)
  }
  
  if (isTRUE(sp500)) {
  urlfile2 = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/S%26P500.csv"
  

  SP500 <- data.table(
    read_csv(url(urlfile2), col_names = TRUE, na = c(""), 
                    skip_empty_rows = TRUE, col_types = NULL))

    Data <- Data %>% left_join(SP500, by = c("year"))
  
  }
  
  if (isTRUE(dcData)) {
    
  #Data <- data.table(pullStateData(2001))
   
  urlfile3 = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/DCPlanData.csv"
  
  DCPlanData <- data.table(
    read_csv(url(urlfile3), col_names = TRUE, na = c(""), 
             skip_empty_rows = TRUE, col_types = NULL))
  
  DCPlanData <- DCPlanData %>% 
    select(year = fy, ppd_id, plantype,
           ee_contrate_mandatory, er_contrate_fixedrate, 
           planname, primary,
           eligible_eegroups, assets, members_total, actives, inactives, coveredpayroll) %>% 
    replace(is.na(.), 0)
  
  DCPlanData$ppd_id <- as.numeric(DCPlanData$ppd_id)
  DCPlanData$fy <- as.numeric(DCPlanData$fy)
  DCPlanData$er_contrate_fixedrate <- as.numeric(DCPlanData$er_contrate_fixedrate)
  DCPlanData$ee_contrate_mandatory <- as.numeric(DCPlanData$ee_contrate_mandatory)
  DCPlanData$assets <- as.numeric(DCPlanData$assets)
  DCPlanData$members_total <- as.numeric(DCPlanData$members_total)
  DCPlanData$actives <- as.numeric(DCPlanData$actives)
  DCPlanData$inactives <- as.numeric(DCPlanData$inactives)
  
  for(i in (1:length(DCPlanData$members_total))){
  
  DCPlanData$members_total[i] <- max(DCPlanData$members_total[i], (DCPlanData$actives[i]+DCPlanData$inactives[i]))
  
  }
  
  Data$ppd_id <- as.numeric(Data$ppd_id)
  Data$year<- as.numeric(Data$year)
  
  Data <- Data %>% left_join(DCPlanData, by = c("ppd_id", "year"))

  }
  if (isTRUE(treasury)) {
  urlfile <- "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/treasury.csv"
  treasury <- data.table(
    read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL))
  
  colnames(treasury)[2] <- "treasury_30"
  Data <- Data %>% left_join(treasury, by = c("year"))

  }
  
  if (isTRUE(expenditure)) {

    #1. General Fund Exp./Rev. NASBO (State)
    #2. Total Exp./Rev. NASBO (State) --> general funds, other state funds, bonds, and federal funds.
    #3. Total Exp./Rev. Urban (State & Local) --> state and local direct general expenditures (exclude “business-like” activities such as utilities and transfers between state and local governments.)

    library(readxl)
    library(httr)
    urlfile="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/NASBO_Exp_Report_Data_v1.csv"
    NASBO<-read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    NASBO <- setDT(NASBO)
    NASBO <- NASBO %>% select(YEAR, STATE,"TOTAL_CAPI") %>% filter(YEAR>2000)
    #View(NASBO)
    colnames(NASBO)[1] <- "year"
    colnames(NASBO)[2] <- "state"
    Data <- Data %>% left_join(NASBO, by = c("year","state"))
    ####
    urlfile="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/UrbanCensus_ExpRev_2000-2018.csv"
    Urban<-read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    Urban <- setDT(Urban)

    Urban <- Urban %>% select(Year, State,"(R01) Total Revenue", "(E001) Total Expenditure")

    colnames(Urban)[1] <- "year"
    colnames(Urban)[2] <- "state"
     
    Data <- Data %>% left_join(Urban, by = c("year","state"))

  }

  Data <- Data %>% select(year, plan_name = display_name,
                          state, if (isTRUE(source)) {
                            "data_source_name"
                          }, return_1yr = x1_year_investment_return_percentage,
                          ava_return = market_investment_return_mva_basis, actuarial_cost_method_in_gasb_reporting,
                          funded_ratio = actuarial_funded_ratio_percentage, ava = actuarial_value_of_assets_gasb_dollar, #actuarial_value_of_assets_gasb_dollar (PPD)
                          mva = market_value_of_assets_dollar, #mva_smooth = market_assets_reported_for_asset_smoothing,
                          aal = actuarially_accrued_liabilities_dollar,
                          adec1 = actuarially_determined_contribution_dollar,
                          adec2 =   actuarially_required_contribution_paid_dollar,  #actuarially_required_contribution_dollar (PPD)
                          adec_paid_pct = actuarially_required_contribution_paid_percentage,
                          adec_pct = adec_as_a_percent_of_payroll, #instead of employers_projected_actuarial_required_contribution
                          arc_paid_dollar = actuarially_required_contribution_paid_dollar, #NEW
                          adec_paid_dollar = actuarially_determined_contribution_paid_dollar,#NEW
                          statutory = statutory_payment_dollar, statutory_pct = statutory_payment_percentage,
                          amortizaton_method, total_benefit_payments = total_benefits_paid_dollar,
                          benefit_payments = benefit_payments_dollar, refunds = refunds_dollar,
                          admin_exp = administrative_expense_dollar, cost_structure,
                          state_exp_NASBO = TOTAL_CAPI, #gf_rev_NASBO = "TOTAL REV",
                          state.local_exp_Census = "(R01) Total Revenue", state.local_rev_Census = "(E001) Total Expenditure",
                          fund_id = ppd_fund_id, ppd_id = ppd_id, employers = number_of_employers,
                          plans = number_of_plans, asset_valuation_method_for_gasb_reporting,
                          dc_plantype = plantype,  dc_er_pct = er_contrate_fixedrate, #dc_eligble = eligible_eegroups,
                          dc_ee_pct = ee_contrate_mandatory, dc_plan = planname, dc_primary = primary,
                          dc_assets = assets, dc_members = members_total, dc_payroll = coveredpayroll,
                          payroll = covered_payroll_dollar, ee_contribution = employee_contribution_dollar,
                          ee_nc_pct = employee_normal_cost_percentage,
                          er_nc_pct = employer_normal_cost_percentage,total_nc_pct = total_normal_cost_percentage, 
                          er_contribution = employer_contribution_regular_dollar, er_state_contribution = employer_state_contribution_dollar,
                          other_contribution = other_contribution_dollar, other_additions = other_additions_dollar,
                          fy_contribution = fiscal_year_of_contribution, inflation_assum = inflation_rate_assumption,
                          arr = investment_return_assumption_for_gasb_reporting,
                          dr = discount_rate_assumption, number_of_years_remaining_on_amortization_schedule,
                          payroll_growth_assumption, total_amortization_payment_pct = total_amortization_payment_percentage,
                          total_amo_payment = amortization_payment_total_amount, #Added
                          total_contribution = total_contribution_dollar,
                          total_nc_dollar = total_normal_cost_dollar, total_number_of_members,
                          total_proj_adec_pct = total_projected_actuarial_required_contribution_percentage_of_payroll,
                          tpl = total_pension_liability_dollar,
                          npl_pct_down = net_pension_liability_assuming_1_percent_decrease_in_discount_rate, #Added
                          npl = net_pension_liability_dollar, #Added
                          npl_pct_up = net_pension_liability_assuming_1_percent_increase_in_discount_rate, #Added
                          type_of_employees_covered, unfunded_actuarially_accrued_liabilities_dollar,
                          wage_inflation, region, cpi_change, sp_500, treasury_30)

  
  ## Combining ARC & ADEC
  Data$state.local_exp_Census <- as.numeric(Data$state.local_exp_Census)
  Data$state.local_rev_Census <- as.numeric(Data$state.local_exp_Census)
  Data$state_exp_NASBO <- as.numeric(Data$state_exp_NASBO)
  Data$dc_primary <- ifelse(Data$dc_primary == 1, "Yes", "No")
  
  Data$adec1 <- as.numeric(Data$adec1)
  Data$adec2 <- as.numeric(Data$adec2)
  Data$adec_paid_dollar <- as.numeric(Data$adec_paid_dollar)
  Data$arc_paid_dollar <- as.numeric(Data$arc_paid_dollar)
  Data$arc_adec_dollar <- ifelse(is.na(Data$adec1) == TRUE,Data$adec2, Data$adec1)
  Data$arc_adec_paid_dollar <- ifelse(is.na(Data$arc_paid_dollar) == TRUE,
                               ifelse(is.na(Data$statutory_payment_dollar) == TRUE,statutory_payment_dollar, 
                                      Data$adec_paid_dollar), 
                                      Data$arc_paid_dollar)
  
  Data$fy_contribution <- as.numeric(Data$fy_contribution)
  Data$year <- as.numeric(Data$year)
  Data$fy_contribution <- round(Data$fy_contribution, 0)
  Data <- Data %>% filter(year >= fy) #%>% select(-adec1, -adec2)

  #https://www.urban.org/policy-centers/cross-center-initiatives/state-and-local-finance-initiative/projects/state-fiscal-briefs/florida

  if (isTRUE(expenditure)) {
   Data$ava <- as.numeric(Data$ava)
   Data$aal <- as.numeric(Data$aal)
   Data$state_exp_NASBO <- as.numeric(Data$state_exp_NASBO)
   Data$state.local_exp_Census <- as.numeric(Data$state.local_exp_Census)
   Data <- Data %>% group_by(state, year) %>% mutate(ual_exp_NASBO = round((sum(aal)-sum(ava))/(state_exp_NASBO*1000000),2),
                                                     ual_exp_Census = round((sum(aal)-sum(ava))/(state.local_exp_Census*1000),2))
  }

  if (is_null(employee)) {
    employee <- employee
  }
  else if (employee == "teacher") {
    employee <- c("Plan covers teachers")
  }
  else if (employee == "state and local") {
    employee <- c("Plan covers state and local employees")
  }
  else if (employee == "police and fire") {
    employee <- c("Plan covers police and/or fire")
  }
  else if (employee == "state") {
    employee <- c("Plan covers state employees")
  }
  else if (employee == "local") {
    employee <- c("Plan covers local employees")
  }
  else if (employee == "state, local, and teachers") {
    employee <- c("Plan covers state, local and teachers")
  }
  if (is_null(employee)) {
    Data <- data.frame(Data) %>% replace(is.na(.), 0)
  }
  else {
    Data %>% filter(type_of_employees_covered == paste(employee)) %>% replace(is.na(.), 0)
  }
}

#PULL DATA
Data <- pullStateData(2001)
Data <- data.table(filterData2(Data, 2001))

Data <-
  data.table(Data %>% filter(plan_name == "Texas Teacher Retirement System"))


Data$year <- as.numeric(Data$year)
Data$ava <- as.numeric(Data$ava)
Data$aal <- as.numeric(Data$aal)
Data$unfunded_actuarially_accrued_liabilities_dollar <- as.numeric(Data$unfunded_actuarially_accrued_liabilities_dollar)

ual <- data.table(Data$unfunded_actuarially_accrued_liabilities_dollar)
funded <-data.table(Data$funded_ratio)

#Create table skeleton
table <- matrix(NA,2,3)

#Use database numbers to populate/calculate needed values
table[1,1] <- c("Year")
table[1,1] <- as.numeric(Data$year[1])
table[2,1] <- as.numeric(Data[length(Data$year)]$year)

#UAL
table[1,2] <- as.numeric(ual[1])
table[2,2] <- as.numeric(ual[length(ual$V1)])

#Funded ratio
table[1,3] <- as.numeric(funded[1])
table[2,3] <- as.numeric(funded[length(ual$V1)])

table <- data.table(table)
colnames(table) <- c("",
               "UAL", 
               "Funded Ratio")
table$UAL <- as.numeric(table$UAL)
table$`Funded Ratio` <- as.numeric(table$`Funded Ratio`)

#Format data to %/$ for appearance
table[,2] <- scales::dollar(table$UAL)
table[,3] <- scales::percent(table$`Funded Ratio`, accuracy = 0.1)

#View(table)
#Knit the table
knitr::kable(
  table, caption = 'Pension Integrity Project pension database.'
)
```

### Liabilities Growing Faster than Assets (2001-2021) w/ R (linePlot())

```{r area.ual, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial valuation reports.",fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

rm(list = ls())

###Load/install packages
#R.Version()
#https://github.com/ReasonFoundation/pensionviewr
#Create token -> usethis::edit_r_environ() -> restart -> Sys.getenv("GITHUB_PAT")
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
#devtools::install_github(
#  "ANiraula/pensionviewr_private",
#   ref = "master", auth_token = "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")
library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(plyr)
library(dplyr)

###
##Pull PERSI data
##Load list of plans
pl <- planList()


pl <- planList()

#############
pullStateData <- function (FY)
{
  con <- RPostgres::dbConnect(
    RPostgres::Postgres(),
    dbname = "d629vjn37pbl3l",
    host = "ec2-3-209-200-73.compute-1.amazonaws.com",
    port = 5432,
    user = "reason_readonly",
    password = "p88088bd28ea68027ee96c65996f7ea3b56db0e27d7c9928c05edc6c23ef2bc27",
    sslmode = "require")
  
  query <- paste("select * from pull_data_state_only()\nwhere year > '",
                 paste(FY - 1), "'\nand attribute_name in ('1 Year Investment Return Percentage',
                 \n'PPD ID',
                 \n'Number of Employers',
                 \n'Number of Plans',\n'Actuarial Cost Method in GASB Reporting',
                 \n'Employer Normal Cost Percentage',
                 \n'Total Normal Cost Dollar',\n'Actuarial Funded Ratio Percentage',
                 \n'Market Investment Return (MVA Basis)',
                 \n'Actuarial Value of Assets GASB Dollar',
                 \n'Market Value of Assets Dollar',
                 \n'Market Assets Reported for Asset Smoothing',
                 \n'Actuarially Accrued Liabilities Dollar',
                 \n'Total Pension Liability Dollar',
                 \n'Actuarially Determined Contribution Percentage of Payroll',
                 \n'Actuarially Required Contribution Dollar',
                 \n'Actuarially Required Contribution Paid Percentage',
                 \n'Total Employer Contributions',
                 \n'Statutory Payment Dollar',
                 \n'Statutory Payment Percentage',
                 \n'Amortizaton Method',
                 \n'Total Benefits Paid Dollar',
                 \n'Benefit Payments Dollar',
                 \n'Refunds Dollar',
                 \n'Administrative Expense Dollar',
                 \n'Cost Structure',
                 \n'Asset Valuation Method for GASB Reporting',
                 \n'Covered Payroll Dollar',
                 \n'Employee Contribution Dollar',
                 \n'Employee Normal Cost Percentage',
                 \n'Employer Contribution Regular Dollar',
                 \n'Employer Normal Cost Dollar',
                 \n'Employer State Contribution Dollar',
                 \n'ADEC as a Percent of Payroll',
                 \n'Other Contribution Dollar',
                 \n'Other Additions',
                 \n'Fiscal Year of Contribution',
                 \n'Inflation Rate Assumption For GASB Reporting',
                 \n'Investment Return Assumption for GASB Reporting',
                 \n'Discount Rate Assumption',
                 \n'Number of Years Remaining on Amortization Schedule',
                 \n'Payroll Growth Assumption',
                 \n'Unfunded Actuarially Accrued Liabilities Dollar',
                 \n'Total Contribution Dollar',
                 \n'Total Normal Cost Percentage',
                 \n'Net Pension Liability Dollar',
                 \n'Net Pension Liability Assuming 1% Decrease in Discount Rate',
                 \n'Net Pension Liability Assuming 1% Increase in Discount Rate',
                 \n'Total Number Of Members',
                 \n'Total Projected Actuarial Required Contribution Percentage Of Payroll',
                 \n'Actuarially Required Contribution Paid Dollar',
                 \n'Actuarially Determined Contribution Paid Dollar',
                 \n'Type of Employees Covered',
                 \n'Total Amortization Payment Percentage',
                 \n'Wage Inflation')")
  result <- RPostgres::dbSendQuery(con, query)
  all_data <- RPostgres::dbFetch(result) %>% janitor::clean_names()
  RPostgres::dbClearResult(result)
  RPostgres::dbDisconnect(con)
  all_data %>% dplyr::group_by_at(dplyr::vars(-.data$attribute_value)) %>%
    dplyr::mutate(row_id = 1:dplyr::n()) %>% dplyr::ungroup() %>%
    tidyr::pivot_wider(names_from = attribute_name, values_from = attribute_value) %>%
    dplyr::select(-.data$row_id) %>% 
    dplyr::arrange(display_name, year) %>%
    janitor::clean_names()
}

###########

filterAssets2 <- function (data, fy = 2001, plan = NULL) {
  data <- data.frame(data)
  
  data[, 5:83] <- data[, 5:83] %>% mutate_all(as.numeric)
  data <- data %>% replace(is.na(.), 0)
  data$year <- as.numeric(data$year)
  
  assets <- data %>% select(year, display_name, state, contains("percent")) %>%
    
    mutate(private.equity = percent_of_assets_invested_in_private_equity, 
           real.estate =  percent_of_assets_invested_in_real_estate, 
           hedge = percent_of_assets_invested_in_hedge_funds,
           commodities = percent_of_assets_invested_in_commodities,
           other.alternatives = percent_of_assets_invested_in_misc_alternatives + percent_of_assets_invested_in_other_investments,
           equity = percent_of_assets_invested_in_equity_investments_total,
           fixed = percent_of_assets_invested_in_fixed_income, 
           cash = percent_of_assets_invested_in_cash) %>% 
    select( -contains("percent")
    )
  
  
  if (!is.null(plan)) {
    assets <- assets %>% filter(display_name == plan)
  }
  assets$total <- 0
  y <- as.numeric(length(assets$total))
  assets[, 4:11] <- assets[, 4:11] %>% mutate_all(as.numeric)
  for (i in (1:y)) {
    assets$total[i] <- sum(assets[i, 4:11])
  }
  
  assets$total <- as.numeric(assets$total)
  
  
  colnames(assets) <- c("year", "Plan", "State", "Private Equity", 
                        "Real Estate", "Hedge Funds", "Commodities", "Other Alternatives", 
                        "Total Equity", "Fixed Income", "Cash Equivalents", 
                        "Total")
  
  assets <- assets %>% 
    filter(year >= fy) %>% 
    select(-Total)
  
  assets
}

#########
# Filter Downloaded Data -------------------------------------------------------------

filterData2 <- function(Data, fy = 2001,
                        inflation = TRUE,
                        expenditure = TRUE,
                        employee = NULL,
                        sp500 = TRUE,
                        dcData = TRUE,
                        treasury = TRUE,
                        blend.teacher = FALSE,
                        source = FALSE) {
  if (isTRUE(blend.teacher)) {
    blended.teach <- c("Arizona State Retirement System",
                       "Delaware State Employees’ Pension Plan", "District of Columbia Teachers Retirement Fund",
                       "Florida Retirement System", "Employee Retirement System of Hawaii",
                       "Idaho Public Employee Retirement System", "Iowa Public Employees' Retirement System",
                       "Kansas Public Employees' Retirement System", "Public Employees' Retirement System of Mississippi",
                       "Nevada Public Employees Retirement System", "New Hampshire Retirement System",
                       "North Carolina Teachers' and State Employees' Retirement System",
                       "Oregon Public Employees Retirement System", "Rhode Island Employees Retirement System",
                       "South Carolina Retirement Systems", "South Dakota Retirement System",
                       "Tennessee Consolidated Retirement System, Teachers Pension Plan",
                       "Utah Retirement Systems, Noncontributory Retirement System",
                       "Virginia Retirement System", "Wisconsin Retirement System",
                       "Wyoming Retirement System, Public Employees’ Pension Plan",
                       "Maine Public Employees Retirement System (PERS) Defined Benefit Plan",
                       "Maryland State Employees’ Retirement System")
    Data <- data.frame(Data)
    Data <- Data %>% mutate(type_of_employees_covered = case_when(display_name %in%
                                                                  blended.teach ~ "Plan covers state, local and teachers",
                                                                  TRUE ~ type_of_employees_covered))
  }
  Data <- data.frame(Data)
  columns <- c("total_pension_liability_dollar", "wage_inflation",
               "payroll_growth_assumption", "other_contribution_dollar",
               "other_additions_dollar", "x1_year_investment_return_percentage",
               "amortizaton_method", "number_of_years_remaining_on_amortization_schedule",
               "amortization_payment_total_amount",
               "x1_year_investment_return_percentage",
               "total_normal_cost_dollar", "fiscal_year_of_contribution",
               "statutory_payment_dollar", "statutory_payment_percentage",
               "ppd_fund_id", "number_of_employers", "number_of_plans", "ppd_id",
               "discount_rate_assumption", "market_investment_return_mva_basis", 
               "actuarially_determined_contribution_dollar",
               "net_pension_liability_dollar",
               "administrative_expense_dollar",
               "employer_state_contribution_dollar",
               "total_amortization_payment_percentage",
               "type_of_employees_covered",
               "total_contribution_dollar",
               "employer_contribution_regular_dollar",
               "actuarial_cost_method_in_gasb_reporting",
               "net_pension_liability_assuming_1_percent_decrease_in_discount_rate",
               "net_pension_liability_assuming_1_percent_increase_in_discount_rate",
               "actuarially_required_contribution_paid_dollar",
               "actuarially_required_contribution_paid_percentage",
               "total_benefits_paid_dollar",
               "benefit_payments_dollar",
               "refunds_dollar",
               "actuarially_determined_contribution_paid_dollar",
               "cost_structure", "employer_normal_cost_percentage", "actuarial_value_of_assets_dollar",
               "asset_valuation_method_for_gasb_reporting", "inflation_rate_assumption",
               "total_number_of_members", "total_projected_actuarial_required_contribution_percentage_of_payroll",
               "market_assets_reported_for_asset_smoothing")
  columns2 <- c("test")
  for (i in (1:length(columns))) {
    if (sum(colnames(Data) %in% columns[i]) == 0) {
      columns2 <- rbind(columns2, columns[i])
    }
  }
  columns2 <- as.character(columns2 <- columns2[2:length(columns2)])
  cols <- matrix(NA, length(Data[, 1]), length(columns2))
  colnames(cols) <- columns2
  Data <- cbind(Data, cols)
  Data <- data.frame(Data)
  Data <- Data %>% arrange(state, display_name, year)
  Data$year <- as.numeric(Data$year)
  if (isTRUE(inflation)) {
    library(readxl)
    library(httr)
    url1 <- "https://github.com/ReasonFoundation/databaseR/raw/master/files/CPI_by_Region_DOL.xlsx"
    GET(url1, write_disk(tf <- tempfile(fileext = ".xlsx")))
    cpi <- read_excel(tf, sheet = 1)
    regions <- read_excel(tf, sheet = 2)
    cpi <- data.table(cpi)
    regions <- data.table(regions)
    cpi$cpi_change <- NA
    for (i in (2:length(cpi$region))) {
      cpi$cpi_change[i] <- (cpi$cpi[i]/cpi$cpi[i - 1]) -
        1
    }
    Data <- Data %>% left_join(regions, by = "state")
    Data <- Data %>% left_join(cpi, by = c("year", "region"))
    Data <- Data %>% select(-cpi)
  }
  
  if (isTRUE(sp500)) {
  urlfile2 = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/S%26P500.csv"
  

  SP500 <- data.table(
    read_csv(url(urlfile2), col_names = TRUE, na = c(""), 
                    skip_empty_rows = TRUE, col_types = NULL))

    Data <- Data %>% left_join(SP500, by = c("year"))
  
  }
  
  if (isTRUE(dcData)) {
    
  #Data <- data.table(pullStateData(2001))
   
  urlfile3 = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/DCPlanData.csv"
  
  DCPlanData <- data.table(
    read_csv(url(urlfile3), col_names = TRUE, na = c(""), 
             skip_empty_rows = TRUE, col_types = NULL))
  
  DCPlanData <- DCPlanData %>% 
    select(year = fy, ppd_id, plantype,
           ee_contrate_mandatory, er_contrate_fixedrate, 
           planname, primary,
           eligible_eegroups, assets, members_total, actives, inactives, coveredpayroll) %>% 
    replace(is.na(.), 0)
  
  DCPlanData$ppd_id <- as.numeric(DCPlanData$ppd_id)
  DCPlanData$fy <- as.numeric(DCPlanData$fy)
  DCPlanData$er_contrate_fixedrate <- as.numeric(DCPlanData$er_contrate_fixedrate)
  DCPlanData$ee_contrate_mandatory <- as.numeric(DCPlanData$ee_contrate_mandatory)
  DCPlanData$assets <- as.numeric(DCPlanData$assets)
  DCPlanData$members_total <- as.numeric(DCPlanData$members_total)
  DCPlanData$actives <- as.numeric(DCPlanData$actives)
  DCPlanData$inactives <- as.numeric(DCPlanData$inactives)
  
  for(i in (1:length(DCPlanData$members_total))){
  
  DCPlanData$members_total[i] <- max(DCPlanData$members_total[i], (DCPlanData$actives[i]+DCPlanData$inactives[i]))
  
  }
  
  Data$ppd_id <- as.numeric(Data$ppd_id)
  Data$year<- as.numeric(Data$year)
  
  Data <- Data %>% left_join(DCPlanData, by = c("ppd_id", "year"))

  }
  if (isTRUE(treasury)) {
  urlfile <- "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/treasury.csv"
  treasury <- data.table(
    read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL))
  
  colnames(treasury)[2] <- "treasury_30"
  Data <- Data %>% left_join(treasury, by = c("year"))

  }
  
  if (isTRUE(expenditure)) {

    #1. General Fund Exp./Rev. NASBO (State)
    #2. Total Exp./Rev. NASBO (State) --> general funds, other state funds, bonds, and federal funds.
    #3. Total Exp./Rev. Urban (State & Local) --> state and local direct general expenditures (exclude “business-like” activities such as utilities and transfers between state and local governments.)

    library(readxl)
    library(httr)
    urlfile="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/NASBO_Exp_Report_Data_v1.csv"
    NASBO<-read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    NASBO <- setDT(NASBO)
    NASBO <- NASBO %>% select(YEAR, STATE,"TOTAL_CAPI") %>% filter(YEAR>2000)
    #View(NASBO)
    colnames(NASBO)[1] <- "year"
    colnames(NASBO)[2] <- "state"
    Data <- Data %>% left_join(NASBO, by = c("year","state"))
    ####
    urlfile="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/UrbanCensus_ExpRev_2000-2018.csv"
    Urban<-read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    Urban <- setDT(Urban)

    Urban <- Urban %>% select(Year, State,"(R01) Total Revenue", "(E001) Total Expenditure")

    colnames(Urban)[1] <- "year"
    colnames(Urban)[2] <- "state"
     
    Data <- Data %>% left_join(Urban, by = c("year","state"))

  }

  Data <- Data %>% select(year, plan_name = display_name,
                          state, if (isTRUE(source)) {
                            "data_source_name"
                          }, return_1yr = x1_year_investment_return_percentage,
                          ava_return = market_investment_return_mva_basis, actuarial_cost_method_in_gasb_reporting,
                          funded_ratio = actuarial_funded_ratio_percentage, ava = actuarial_value_of_assets_gasb_dollar, #actuarial_value_of_assets_gasb_dollar (PPD)
                          mva = market_value_of_assets_dollar, #mva_smooth = market_assets_reported_for_asset_smoothing,
                          aal = actuarially_accrued_liabilities_dollar,
                          adec1 = actuarially_determined_contribution_dollar,
                          adec2 =   actuarially_required_contribution_paid_dollar,  #actuarially_required_contribution_dollar (PPD)
                          adec_paid_pct = actuarially_required_contribution_paid_percentage,
                          adec_pct = adec_as_a_percent_of_payroll, #instead of employers_projected_actuarial_required_contribution
                          arc_paid_dollar = actuarially_required_contribution_paid_dollar, #NEW
                          adec_paid_dollar = actuarially_determined_contribution_paid_dollar,#NEW
                          statutory = statutory_payment_dollar, statutory_pct = statutory_payment_percentage,
                          amortizaton_method, total_benefit_payments = total_benefits_paid_dollar,
                          benefit_payments = benefit_payments_dollar, refunds = refunds_dollar,
                          admin_exp = administrative_expense_dollar, cost_structure,
                          state_exp_NASBO = TOTAL_CAPI, #gf_rev_NASBO = "TOTAL REV",
                          state.local_exp_Census = "(R01) Total Revenue", state.local_rev_Census = "(E001) Total Expenditure",
                          fund_id = ppd_fund_id, ppd_id = ppd_id, employers = number_of_employers,
                          plans = number_of_plans, asset_valuation_method_for_gasb_reporting,
                          dc_plantype = plantype,  dc_er_pct = er_contrate_fixedrate, #dc_eligble = eligible_eegroups,
                          dc_ee_pct = ee_contrate_mandatory, dc_plan = planname, dc_primary = primary,
                          dc_assets = assets, dc_members = members_total, dc_payroll = coveredpayroll,
                          payroll = covered_payroll_dollar, ee_contribution = employee_contribution_dollar,
                          ee_nc_pct = employee_normal_cost_percentage,
                          er_nc_pct = employer_normal_cost_percentage,total_nc_pct = total_normal_cost_percentage, 
                          er_contribution = employer_contribution_regular_dollar, er_state_contribution = employer_state_contribution_dollar,
                          other_contribution = other_contribution_dollar, other_additions = other_additions_dollar,
                          fy_contribution = fiscal_year_of_contribution, inflation_assum = inflation_rate_assumption,
                          arr = investment_return_assumption_for_gasb_reporting,
                          dr = discount_rate_assumption, number_of_years_remaining_on_amortization_schedule,
                          payroll_growth_assumption, total_amortization_payment_pct = total_amortization_payment_percentage,
                          total_amo_payment = amortization_payment_total_amount, #Added
                          total_contribution = total_contribution_dollar,
                          total_nc_dollar = total_normal_cost_dollar, total_number_of_members,
                          total_proj_adec_pct = total_projected_actuarial_required_contribution_percentage_of_payroll,
                          tpl = total_pension_liability_dollar,
                          npl_pct_down = net_pension_liability_assuming_1_percent_decrease_in_discount_rate, #Added
                          npl = net_pension_liability_dollar, #Added
                          npl_pct_up = net_pension_liability_assuming_1_percent_increase_in_discount_rate, #Added
                          type_of_employees_covered, unfunded_actuarially_accrued_liabilities_dollar,
                          wage_inflation, region, cpi_change, sp_500, treasury_30)

  
  ## Combining ARC & ADEC
  Data$state.local_exp_Census <- as.numeric(Data$state.local_exp_Census)
  Data$state.local_rev_Census <- as.numeric(Data$state.local_exp_Census)
  Data$state_exp_NASBO <- as.numeric(Data$state_exp_NASBO)
  Data$dc_primary <- ifelse(Data$dc_primary == 1, "Yes", "No")
  
  Data$adec1 <- as.numeric(Data$adec1)
  Data$adec2 <- as.numeric(Data$adec2)
  Data$adec_paid_dollar <- as.numeric(Data$adec_paid_dollar)
  Data$arc_paid_dollar <- as.numeric(Data$arc_paid_dollar)
  Data$arc_adec_dollar <- ifelse(is.na(Data$adec1) == TRUE,Data$adec2, Data$adec1)
  Data$arc_adec_paid_dollar <- ifelse(is.na(Data$arc_paid_dollar) == TRUE,
                               ifelse(is.na(Data$statutory_payment_dollar) == TRUE,statutory_payment_dollar, 
                                      Data$adec_paid_dollar), 
                                      Data$arc_paid_dollar)
  
  Data$fy_contribution <- as.numeric(Data$fy_contribution)
  Data$year <- as.numeric(Data$year)
  Data$fy_contribution <- round(Data$fy_contribution, 0)
  Data <- Data %>% filter(year >= fy) #%>% select(-adec1, -adec2)

  #https://www.urban.org/policy-centers/cross-center-initiatives/state-and-local-finance-initiative/projects/state-fiscal-briefs/florida

  if (isTRUE(expenditure)) {
   Data$ava <- as.numeric(Data$ava)
   Data$aal <- as.numeric(Data$aal)
   Data$state_exp_NASBO <- as.numeric(Data$state_exp_NASBO)
   Data$state.local_exp_Census <- as.numeric(Data$state.local_exp_Census)
   Data <- Data %>% group_by(state, year) %>% mutate(ual_exp_NASBO = round((sum(aal)-sum(ava))/(state_exp_NASBO*1000000),2),
                                                     ual_exp_Census = round((sum(aal)-sum(ava))/(state.local_exp_Census*1000),2))
  }

  if (is_null(employee)) {
    employee <- employee
  }
  else if (employee == "teacher") {
    employee <- c("Plan covers teachers")
  }
  else if (employee == "state and local") {
    employee <- c("Plan covers state and local employees")
  }
  else if (employee == "police and fire") {
    employee <- c("Plan covers police and/or fire")
  }
  else if (employee == "state") {
    employee <- c("Plan covers state employees")
  }
  else if (employee == "local") {
    employee <- c("Plan covers local employees")
  }
  else if (employee == "state, local, and teachers") {
    employee <- c("Plan covers state, local and teachers")
  }
  if (is_null(employee)) {
    Data <- data.frame(Data) %>% replace(is.na(.), 0)
  }
  else {
    Data %>% filter(type_of_employees_covered == paste(employee)) %>% replace(is.na(.), 0)
  }
}

#PULL DATA
Data <- pullStateData(2001)
Data <- filterData2(Data, 2001)
#View(Data)
Data <-
  data.table(Data %>% filter(plan_name == "Texas Teacher Retirement System"))

Data$unfunded_actuarially_accrued_liabilities_dollar <- as.numeric(Data$unfunded_actuarially_accrued_liabilities_dollar)

#Manually calculating 2021 AVA (AAL - UAL)
#Data$ava[21] <- Data$aal[21] - Data$unfunded_actuarially_accrued_liabilities_dollar[21]

#Data<- Data %>% 
#  group_by(year) %>%
#  filter(!is.na(ava) & !is.na(aal)) %>%
#  transmute(ava = sum(ava),
#            aal = sum(aal)) %>%
#filter(year < 2020 & !duplicated(year))
       
Data$year <- as.numeric(Data$year)
Data <- Data %>% select(year, ava, aal)
#Set to data.frame for visualization

Data <- data.frame(Data)
Data$year <- as.numeric(Data$year)

#View(Data)
data <- Data
#View(data)
#####Modified linePlot

ualPlot <- function (data, title = NULL, caption = FALSE, grid = FALSE, ticks = TRUE, font = NULL, 
  yaxisMin = 0, yaxisMax = NULL, yaxisSeq = 5, yaxisScale = 100, 
  format = NULL, str = 20, labelY = NULL){ 
  
  plotTheme <- ggplot2::theme(   panel.grid = element_blank(),
                                 panel.border = element_blank(),
                                 axis.line = element_line(colour = "black"),
                                 plot.margin = margin(0,0.5,0,0, "cm"),
                                 axis.text.y = element_text(size=12, color = "black"),
                                 axis.text.x = element_text(size=12, color = "black", angle = 0, hjust = 0.5, vjust = -1),
                                 axis.title = element_text(size = 12, face = "bold"),
                                 legend.text = element_text(size = 12),
                                 legend.title = element_blank(),
                                 text = element_text(family = "Calibri"))
  

{
  reasontheme::set_reason_theme(style = "slide")
  x <- length(data$year)
  data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
  
      data <- data.table(
        data %>% select(year, ava, aal)
      )

  graph <- as.data.frame(data)
  lineColors <- c(
    palette_reason$Orange,
    palette_reason$SatBlue, 
    palette_reason$Yellow,
    palette_reason$LightGrey, 
    palette_reason$LightGreen)
    data <- as.data.frame(data)
    
  options(repr.plot.width = 1, repr.plot.height = 0.75)
  ## Removing "melt" to long format function
  ## Adding explicitly each 2 geom_line & 2 geom_area 
  ## Using "show.legend = FALSE" to remove legends in "geom_area"
  
  ggplot2::ggplot(graph)  + 
    ggplot2::geom_area(ggplot2::aes(x = year, y = yaxisScale * 
    graph$aal, fill = "aal"), show.legend = FALSE, alpha = 0.5) + 
    ggplot2::geom_area(ggplot2::aes(x = year, y = yaxisScale * 
    graph$ava, fill = "ava"), show.legend = FALSE) + 
    ggplot2::geom_line(ggplot2::aes(x = year, y = yaxisScale * 
    graph$aal, colour = str_wrap(factor("Actuarial Accrued Liability"), 
    str)), size = 1.5) + 
    ggplot2::geom_line(ggplot2::aes(x = year, y = yaxisScale * 
    graph$ava, colour = str_wrap(factor("Actuarial Value of Assets"), 
    str)), size = 1.5) + 
    ggplot2::geom_hline(yintercept = 0, 
    color = "black")+
    ggplot2::scale_fill_manual(values = c(palette_reason$SpaceGrey, "white")) +
    ggplot2::scale_colour_manual(values = lineColors) +
    ggplot2::scale_y_continuous(breaks = seq(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    }
    else {
      max(graph$value) * yaxisScale * 1.2
    }, by = yaxisSeq), limits = c(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    } else {
      max(graph$value) * yaxisScale * 1.2
    }), labels = scales::dollar_format(prefix = "$", scale = 1, largest_with_cents = 1), expand = c(0, 0)) + ggplot2::scale_x_continuous(breaks = seq(min(graph$year), 
    max(graph$year), by = 2),expand = c(0, 0)) + labs(x = element_blank(), 
    y = labelY) + theme(legend.text = element_text(size = 12)) + 
    theme(legend.direction = "vertical", legend.box = "horizontal", 
      legend.position = 
        c(0.32, 0.09)) + labs(title = paste(title), caption = ifelse(isTRUE(caption), 
    paste("reason.org/pensions"), paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) + ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    plotTheme+
    ggplot2::theme(text = element_text(family = if (!is_null(font)) {
      paste(font)
    }
    else {
      paste("Arial")
    }, size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid), 
    paste(palette_reason$SpaceGrey), "white"), size = (1)))
  }
}

#View(Data$actuarial_value_of_assets_gasb_dollar)
area.ual <- ualPlot(Data, title = NULL, caption = FALSE, grid = FALSE,
                 ticks = TRUE, font = "Calibri",
                  yaxisMin = 0, yaxisMax = 25, yaxisSeq = 2.5,
                  yaxisScale = 1/10000000000, format = "$", str = 60,
                  labelY = "Actuarial Liability & Actuarial Assets (in $Billions)")

area.ual
```

### Causes of Pension Debt (2001-2021) w/ R (custom Plotly-Image)

```{r, dpi=400, echo = FALSE, caption = "Source: Pension Integrity Project analysis of SCRS actuarial valuation reports.",fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}
     ########## Arkansas PERS Dashboard ##########
##Data: Manually Collected
##By: Anil, Jordan, Swaroop

### Clean Global Environment ###
rm(list = ls())

#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
### Load Packages ###
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
#install.packages("data.table")
library(pensionviewr)
library(tseries)
library(data.table)
library(openxlsx)
library(readr)
library(rsconnect)
library(ggplot2)
library(tidyverse)
library(shiny)
library(shinyWidgets)
library(shinydashboard)
library(htmlwidgets)
library(DT)
library(plotly)
library(plyr)
library(dplyr)
#library(orca)
library(png)

###### glPlot() Function #####

palette_reason <- list(Orange="#FF6633",
                       LightOrange="#FF9900",
                       DarkGrey="#333333", 
                       LightGrey= "#CCCCCC", 
                       SpaceGrey ="#A69FA1",
                       DarkBlue="#0066CC", 
                       GreyBlue= "#6699CC", 
                       Yellow= "#FFCC33",
                       LightBlue = "#66B2FF", 
                       SatBlue = "#3366CC", 
                       Green = "#669900",LightGreen = "#00CC66", Red = "#CC0000",LightRed="#FF0000")

url = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/apps/SCRS_GL.csv" 
urlfile=url
data <- read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)

data <- as.data.table(data)# convert to data.table
data <-  data %>%
replace(is.na(.), 0)
    ## Draft for New Gain/Loss bar chart
    #data2 <- data
    #for(i in (2:data[,.N])){
    #data2[i,2: length(data)] <- data2[i,2: length(data)]+data2[(i-1),2: length(data)]
    #}
    #

  #[2] Calculate Total Gain/Loss for each column (i.e. Net Change to UAL over the years)
    y = data[,lapply(.SD,sum),.SDcols=colnames(data)]
    y = y[,!1]# sum values by each column
    y = t(y)/1000000#Saving needed columns and transposing table for graphics
###### Saving 2001-21 G/L for automation later
    inv <- round(y[1],2)
    assum <- round(y[2],2)
    amo <- round(y[3],2)
    demo <- round(y[4],2)
    cola <- round(y[5],2)
    payroll <- round(y[6],2)

#################
glPlot <- function(database = FALSE, data = NULL,
      url = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/apps/SCRS_GL.csv",
      interactive = TRUE,
      fileName = "GainLoss.png",
      title = "<b>Causes of Arkansas ERS Pension Debt (2001-2019)<b>",
      caption = FALSE,
      yaxisScale = 1e-09,
      yaxisMax = 4.5,
      yaxisTick = 0.5,
      lab1 = "Investment<br>Returns",
      lab2 = "Changes to<br>Actuarial<br>Methods &<br>Assumptions",
      lab3 = "Negative<br>Amortization",
      lab4 = "Deviations from<br>Demographic<br>Assumptions",
      lab5 = "COLA<br>Given",
      lab6 = "Gains From<br>Pay<br>Increases<br>Not Given",
      lab7 = NULL,
      lab8 = NULL,
      lab9 = NULL){

  #[1] Load Gain/Loss data from the provided url
  if(!isTRUE(database)){
  urlfile=url
  data <- read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)

  data <- as.data.table(data)# convert to data.table
   data <-  data %>%
    replace(is.na(.), 0)

    ## Draft for New Gain/Loss bar chart
    #data2 <- data
    #for(i in (2:data[,.N])){
    #data2[i,2: length(data)] <- data2[i,2: length(data)]+data2[(i-1),2: length(data)]
    #}
    #


  #[2] Calculate Total Gain/Loss for each column (i.e. Net Change to UAL over the years)
    y = data[,lapply(.SD,sum),.SDcols=colnames(data)]/yaxisScale
    y = y[,!1]# sum values by each column
    y = t(y)#Saving needed columns and transposing table for graphics
}
  #[3] Combine gain/loss data & categories to create interactive Waterfall chart w/ plotly
  #  x = list(lab1, lab2, lab3, lab4, lab5, lab6, lab7,  lab8,  lab9)

     x = list(lab1, lab2, lab3, if (!is_null(lab4)) {
    paste(lab4)
  }, if (!is_null(lab5)) {
    paste(lab5)
  }, if (!is_null(lab6)) {
    paste(lab6)
  }, if (!is_null(lab7)) {
    paste(lab7)
  }, if (!is_null(lab8)) {
    paste(lab8)
  }, if (!is_null(lab9)) {
    paste(lab9)
  }else{NULL})

    num <- sum(
      sum(is.null(x[[5]]))+sum(is.null(x[[6]]))+sum(is.null(x[[7]]))+sum(is.null(x[[8]]))+sum(is.null(x[[9]]))
      )

    x <- x[1:5]

 data <- data.frame(x = factor(x, levels = x), y)
 data <- data %>% dplyr::mutate(measure = dplyr::case_when(.data$y >
    0 ~ "relative", .data$y < 0 ~ "negative"))

    data[length(data[,3]),]$measure <- "total"


    #  m <- list(
    #  l = 50,
    #  r = 0,
    #  b = 0,
    #  t = 50,
    #  pad = 4
    #  )

    #[4] Visualizing with Plotly

    fig <- plot_ly( data,
                    type = "waterfall",
                    measure = ~measure,
                    x = ~x,
                    textposition = "outside",
                    y= ~y,
                    decreasing = list(marker = list(color = palette_reason$Green)),
                    increasing = list(marker = list(color = palette_reason$Red)),
                    totals = list(marker = list(color = palette_reason$Orange)),
                    connector = list(line = list(color= palette_reason$SpaceGrey, width = 1)))

    fig <- fig %>%
      layout(title = paste0(title),
             xaxis = list(title = "",tickfont = list(size = 11, face = "bold")),
             yaxis = list(title = "<b>Change in Unfunded Liability (in $Billions)<b>",
                          titlefont = list(size = 12), range = c(0,yaxisMax),
                          showgrid = FALSE,
                          tick0 = 0,
                          dtick = yaxisTick,
                          ticklen = 2,
                          linecolor = '#636363',
                          linewidth = 0.45),
             barmode = 'stack',
             autosize = F,
             showlegend = F)

      #ADD caption
      if(isTRUE(caption)){
      fig <- fig %>%
                   layout(annotations = list(yref = 'paper', xref = "x", showarrow = F,
                    y = 0, x = 5, text = "reason.org/pensions",
                    xanchor='right', yanchor='auto', xshift=0, yshift=0,
                    font=list(size=10, color="black")))}

    #`Save` as a `static` png file
    #OR `show` as a `interactive` Plotly chart
    #if(!isTRUE(interactive)){
    #Save Plotly as a Static PNG on a local computer (to reference in rmarkdown later)
    #https://github.com/plotly/orca
   # orca(fig, paste0(fileName), width =  7 * 300, height = 4 * 300)}else{fig}
     if(!isTRUE(interactive)){
    #Save Plotly as a Static PNG on a local computer (to reference in rmarkdown later)
    #https://github.com/plotly/orca
    orca(fig, paste0(fileName), width = 860, height = 530)}else{fig}
}

#Code to save Static/Interactive graph

#Code to show Interactive graph
fig <- glPlot(url = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/Rdecks/Tx/TxTRS_GL.csv",
              interactive = T,
     fileName = "TxTRS_GainLoss.png",
     title = "",
     caption = F,
     yaxisScale = 1000000000,
     yaxisMax = 60,
     yaxisTick = 6,
     lab1 = "Investment<br>Returns",
     lab2 = "Changes to<br>Actuarial<br>Methods &<br>Assumptions",
     lab3 = "Negative<br>Amortization",
     lab4 = "Deviations from<br>Demographic and<br>Pay Increase<br>Assumptions and<br>Other",
     lab5 = "Net Change to<br>Unfunded<br>Liability")

#Uncomment "fig" below*
fig
```

![](TxTRS_GainLoss.png)

### Driving Factors Jeopardizing SCRS Resiliency

-   **Deviations from Investment Return Assumptions** have been the largest contributor to the unfunded liability growth, adding **$`r inv`** billion from 2001 to 2021.

    </p>

-   **Changes to Actuarial Methods and Assumptions** – including assumed rate of return - have revealed roughly **$`r assum`** billion in additional unfunded liability since 2001.

    </p>

-   **Extended Amortization Timetables and low Statutory Contributions** in the past have resulted in interest on SCRS debt exceeding the actual debt payments (negative amortization) since 2001, adding a net **$`r amo`** billion to the unfunded liabilities. 

    </p>

-  **Deviations from Demographic Assumptions** – including deviations from assumed rates of withdrawal, retirement, and mortality — added **$`r demo`** billion to the debt since 2001.

    </p>

-   **Ad-Hoc Cost-of-Living-Adjustments** given before 2012 added **$`r cola*100`** million to unfunded liabilities since 2001.

    </p>

### Make up of Pension Contributions w/ R (flextable())

```{r}

rm(list=ls())

library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(dplyr)
library(plyr)
library(DT)
library(scales)


palette_reason <- list(Orange="#FF6633",
                       LightOrange="#FF9900",
                       DarkGrey="#333333", 
                       LightGrey= "#CCCCCC", 
                       SpaceGrey ="#A69FA1",
                       DarkBlue="#0066CC", 
                       GreyBlue= "#6699CC", 
                       Yellow= "#FFCC33",
                       LightBlue = "#66B2FF", 
                       SatBlue = "#3366CC", 
                       Green = "#669900",LightGreen = "#00CC66", Red = "#CC0000",LightRed="#FF0000")

pullStateData <- function (FY)
{
  con <- RPostgres::dbConnect(
    RPostgres::Postgres(),
    dbname = "d629vjn37pbl3l",
    host = "ec2-3-209-200-73.compute-1.amazonaws.com",
    port = 5432,
    user = "reason_readonly",
    password = "p88088bd28ea68027ee96c65996f7ea3b56db0e27d7c9928c05edc6c23ef2bc27",
    sslmode = "require")
  
  query <- paste("select * from pull_data_state_only()\nwhere year > '",
                 paste(FY - 1), "'\nand attribute_name in ('1 Year Investment Return Percentage',\n'PPD Fund ID',\n'Number of Employers',\n'Number of Plans',\n'Actuarial Cost Method in GASB Reporting',\n'Employer Normal Cost Percentage',\n'Total Normal Cost Dollar',\n'Actuarial Funded Ratio Percentage',\n'Market Investment Return (MVA Basis)',\n'Actuarial Value of Assets GASB Dollar',\n'Market Value of Assets Dollar',\n'Market Assets Reported for Asset Smoothing',\n'Actuarially Accrued Liabilities Dollar',\n'Total Pension Liability Dollar',\n'Actuarially Determined Contribution Percentage of Payroll',\n'Actuarially Required Contribution Dollar',\n'Actuarially Required Contribution Paid Percentage',\n'Total Employer Contributions',\n'Statutory Payment Dollar',\n'Statutory Payment Percentage',\n'Amortizaton Method',\n'Total Benefits Paid Dollar',\n'Benefit Payments Dollar',\n'Refunds Dollar',\n'Administrative Expense Dollar',\n'Cost Structure',\n'Asset Valuation Method for GASB Reporting',\n'Covered Payroll Dollar',\n'Employee Contribution Dollar',\n'Employee Normal Cost Percentage',\n'Employer Contribution Regular Dollar',\n'Employer Normal Cost Dollar',\n'Employer State Contribution Dollar',\n'ADEC as a Percent of Payroll',\n'Other Contribution Dollar',\n'Other Additions',\n'Fiscal Year of Contribution',\n'Inflation Rate Assumption For GASB Reporting',\n'Investment Return Assumption for GASB Reporting',\n'Discount Rate Assumption',\n'Number of Years Remaining on Amortization Schedule',\n'Payroll Growth Assumption',\n'Unfunded Actuarially Accrued Liabilities Dollar',\n'Total Contribution Dollar',\n'Total Normal Cost Percentage',\n'Net Pension Liability Dollar',\n'Net Pension Liability Assuming 1% Decrease in Discount Rate',\n'Net Pension Liability Assuming 1% Increase in Discount Rate',\n'Total Number Of Members',\n'Total Projected Actuarial Required Contribution Percentage Of Payroll',\n'Actuarially Required Contribution Paid Dollar',\n'Actuarially Determined Contribution Paid Dollar',\n'Type of Employees Covered',\n'Total Amortization Payment Percentage',\n'Wage Inflation')")
  result <- RPostgres::dbSendQuery(con, query)
  all_data <- RPostgres::dbFetch(result) %>% janitor::clean_names()
  RPostgres::dbClearResult(result)
  RPostgres::dbDisconnect(con)
  all_data %>% dplyr::group_by_at(dplyr::vars(-.data$attribute_value)) %>%
    dplyr::mutate(row_id = 1:dplyr::n()) %>% dplyr::ungroup() %>%
    tidyr::pivot_wider(names_from = attribute_name, values_from = attribute_value) %>%
    dplyr::select(-.data$row_id) %>% dplyr::arrange(display_name,
                                                    year) %>% janitor::clean_names()
}

#############
#############

filterData2 <- function(Data, fy = 2001,
                       inflation = TRUE,
                       expenditure = TRUE,
                       employee = NULL,
                       blend.teacher = FALSE,
                       source = FALSE) {
  if (isTRUE(blend.teacher)) {
    blended.teach <- c("Arizona State Retirement System",
                       "Delaware State Employees’ Pension Plan", "District of Columbia Teachers Retirement Fund",
                       "Florida Retirement System", "Employee Retirement System of Hawaii",
                       "Idaho Public Employee Retirement System", "Iowa Public Employees' Retirement System",
                       "Kansas Public Employees' Retirement System", "Public Employees' Retirement System of Mississippi",
                       "Nevada Public Employees Retirement System", "New Hampshire Retirement System",
                       "North Carolina Teachers' and State Employees' Retirement System",
                       "Oregon Public Employees Retirement System", "Rhode Island Employees Retirement System",
                       "South Carolina Retirement Systems", "South Dakota Retirement System",
                       "Tennessee Consolidated Retirement System, Teachers Pension Plan",
                       "Utah Retirement Systems, Noncontributory Retirement System",
                       "Virginia Retirement System", "Wisconsin Retirement System",
                       "Wyoming Retirement System, Public Employees’ Pension Plan",
                       "Maine Public Employees Retirement System (PERS) Defined Benefit Plan",
                       "Maryland State Employees’ Retirement System")
    Data <- data.frame(Data)
    Data <- Data %>% mutate(type_of_employees_covered = case_when(display_name %in%
                                                                    blended.teach ~ "Plan covers state, local and teachers",
                                                                  TRUE ~ type_of_employees_covered))
  }
  Data <- data.frame(Data)
  columns <- c("total_pension_liability_dollar", "wage_inflation",
               "payroll_growth_assumption", "other_contribution_dollar",
               "other_additions_dollar", "x1_year_investment_return_percentage",
               "amortizaton_method", "number_of_years_remaining_on_amortization_schedule",
               "amortization_payment_total_amount",
               "total_normal_cost_dollar", "fiscal_year_of_contribution",
               "statutory_payment_dollar", "statutory_payment_percentage",
               "ppd_fund_id", "number_of_employers", "number_of_plans",
               "discount_rate_assumption", "market_investment_return_mva_basis", 
               "actuarially_determined_contribution_dollar",
               "net_pension_liability_dollar",
               "net_pension_liability_assuming_1_percent_decrease_in_discount_rate",
               "net_pension_liability_assuming_1_percent_increase_in_discount_rate",
               "actuarially_required_contribution_paid_dollar",
               "actuarially_determined_contribution_paid_dollar",
               "cost_structure", "employer_normal_cost_percentage", "actuarial_value_of_assets_dollar",
               "asset_valuation_method_for_gasb_reporting", "inflation_rate_assumption",
               "total_number_of_members", "total_projected_actuarial_required_contribution_percentage_of_payroll",
               "market_assets_reported_for_asset_smoothing")
  columns2 <- c("test")
  for (i in (1:length(columns))) {
    if (sum(colnames(Data) %in% columns[i]) == 0) {
      columns2 <- rbind(columns2, columns[i])
    }
  }
  columns2 <- as.character(columns2 <- columns2[2:length(columns2)])
  cols <- matrix(NA, length(Data[, 1]), length(columns2))
  colnames(cols) <- columns2
  Data <- cbind(Data, cols)
  Data <- data.frame(Data)
  Data <- Data %>% arrange(state, display_name, year)
  Data$year <- as.numeric(Data$year)
  if (isTRUE(inflation)) {
    library(readxl)
    library(httr)
    url1 <- "https://github.com/ReasonFoundation/databaseR/raw/master/files/CPI_by_Region_DOL.xlsx"
    GET(url1, write_disk(tf <- tempfile(fileext = ".xlsx")))
    cpi <- read_excel(tf, sheet = 1)
    regions <- read_excel(tf, sheet = 2)
    cpi <- data.table(cpi)
    regions <- data.table(regions)
    cpi$cpi.change <- NA
    for (i in (2:length(cpi$region))) {
      cpi$cpi.change[i] <- (cpi$cpi[i]/cpi$cpi[i - 1]) -
        1
    }
    Data <- Data %>% left_join(regions, by = "state")
    Data <- Data %>% left_join(cpi, by = c("year", "region"))
    Data <- Data %>% select(-cpi)
  }

  if (isTRUE(expenditure)) {

    #1. General Fund Exp./Rev. NASBO (State)
    #2. Total Exp./Rev. NASBO (State) --> general funds, other state funds, bonds, and federal funds.
    #3. Total Exp./Rev. Urban (State & Local) --> state and local direct general expenditures (exclude “business-like” activities such as utilities and transfers between state and local governments.)

    library(readxl)
    library(httr)
    urlfile="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/NASBO_Exp_Report_Data_v1.csv"
    NASBO<-read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    NASBO <- setDT(NASBO)
    NASBO <- NASBO %>% select(YEAR, STATE,"TOTAL_CAPI") %>% filter(YEAR>2000)
    #View(NASBO)
    colnames(NASBO)[1] <- "year"
    colnames(NASBO)[2] <- "state"
    Data <- Data %>% left_join(NASBO, by = c("year","state"))
    ####
    urlfile="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/UrbanCensus_ExpRev_2000-2018.csv"
    Urban<-read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    Urban <- setDT(Urban)

    Urban <- Urban %>% select(Year, State,"(R01) Total Revenue", "(E001) Total Expenditure")

    colnames(Urban)[1] <- "year"
    colnames(Urban)[2] <- "state"
     
    Data <- Data %>% left_join(Urban, by = c("year","state"))

  }


  Data <- Data %>% select(year, plan_name = display_name,
                          state, if (isTRUE(source)) {
                            "data_source_name"
                          }, return_1yr = x1_year_investment_return_percentage,
                          ava_return = market_investment_return_mva_basis, actuarial_cost_method_in_gasb_reporting,
                          funded_ratio = actuarial_funded_ratio_percentage, ava = actuarial_value_of_assets_gasb_dollar, #actuarial_value_of_assets_gasb_dollar (PPD)
                          mva = market_value_of_assets_dollar, mva_smooth = market_assets_reported_for_asset_smoothing,
                          aal = actuarially_accrued_liabilities_dollar,
                          adec1 = actuarially_determined_contribution_dollar,
                          adec2 =   actuarially_required_contribution_paid_dollar,  #actuarially_required_contribution_dollar (PPD)
                          adec_paid_pct = actuarially_required_contribution_paid_percentage,
                          adec_pct = adec_as_a_percent_of_payroll, #instead of employers_projected_actuarial_required_contribution
                          arc_paid_dollar = actuarially_required_contribution_paid_dollar, #NEW
                          adec_paid_dollar = actuarially_determined_contribution_paid_dollar,#NEW
                          statutory = statutory_payment_dollar, statutory_pct = statutory_payment_percentage,
                          amortizaton_method, total_benefit_payments = total_benefits_paid_dollar,
                          benefit_payments = benefit_payments_dollar, refunds = refunds_dollar,
                          admin_exp = administrative_expense_dollar, cost_structure,
                          state_exp_NASBO = TOTAL_CAPI, #gf_rev_NASBO = "TOTAL REV",
                          state.local_exp_Census = "(R01) Total Revenue", state.local_rev_Census = "(E001) Total Expenditure",
                          fund_id = ppd_fund_id, employers = number_of_employers,
                          plans = number_of_plans, asset_valuation_method_for_gasb_reporting,
                          payroll = covered_payroll_dollar, ee_contribution = employee_contribution_dollar,
                          ee_nc_pct = employee_normal_cost_percentage,
                          er_nc_pct = employer_normal_cost_percentage,total_nc_pct = total_normal_cost_percentage, 
                          er_contribution = employer_contribution_regular_dollar, er_state_contribution = employer_state_contribution_dollar,
                          other_contribution = other_contribution_dollar, other_additions = other_additions_dollar,
                          fy_contribution = fiscal_year_of_contribution, inflation_assum = inflation_rate_assumption,
                          arr = investment_return_assumption_for_gasb_reporting,
                          dr = discount_rate_assumption, number_of_years_remaining_on_amortization_schedule,
                          payroll_growth_assumption, total_amortization_payment_pct = total_amortization_payment_percentage,
                          total_amo_payment = amortization_payment_total_amount, #Added
                          total_contribution = total_contribution_dollar,
                          total_nc_dollar = total_normal_cost_dollar, total_number_of_members,
                          total_proj_adec_pct = total_projected_actuarial_required_contribution_percentage_of_payroll,
                          tpl = total_pension_liability_dollar,
                          npl_pct_down = net_pension_liability_assuming_1_percent_decrease_in_discount_rate, #Added
                          npl = net_pension_liability_dollar, #Added
                          npl_pct_up = net_pension_liability_assuming_1_percent_increase_in_discount_rate, #Added
                          type_of_employees_covered, unfunded_actuarially_accrued_liabilities_dollar,
                          wage_inflation, region, cpi.change)

  
  ## Combining ARC & ADEC
  Data$arc_adec_dollar <- ifelse(is.na(Data$adec1) == TRUE,Data$adec2, Data$adec1)
  Data$arc_adec_paid_dollar <- ifelse(is.na(Data$arc_paid_dollar) == TRUE, Data$adec_paid_dollar, Data$arc_paid_dollar)
  
  Data$fy_contribution <- as.numeric(Data$fy_contribution)
  Data$year <- as.numeric(Data$year)
  Data$fy_contribution <- round(Data$fy_contribution, 0)
  Data <- Data %>% filter(year >= fy) #%>% select(-adec1, -adec2)

  #https://www.urban.org/policy-centers/cross-center-initiatives/state-and-local-finance-initiative/projects/state-fiscal-briefs/florida

  if (isTRUE(expenditure)) {
   Data$ava <- as.numeric(Data$ava)
   Data$aal <- as.numeric(Data$aal)
   Data$state_exp_NASBO <- as.numeric(Data$state_exp_NASBO)
   Data$state.local_exp_Census <- as.numeric(Data$state.local_exp_Census)
   Data <- Data %>% group_by(state, year) %>% mutate(ual_exp_NASBO = round((sum(aal)-sum(ava))/(state_exp_NASBO*1000000),2),
                                                     ual_exp_Census = round((sum(aal)-sum(ava))/(state.local_exp_Census*1000),2))
  }

  if (is_null(employee)) {
    employee <- employee
  }
  else if (employee == "teacher") {
    employee <- c("Plan covers teachers")
  }
  else if (employee == "state and local") {
    employee <- c("Plan covers state and local employees")
  }
  else if (employee == "police and fire") {
    employee <- c("Plan covers police and/or fire")
  }
  else if (employee == "state") {
    employee <- c("Plan covers state employees")
  }
  else if (employee == "local") {
    employee <- c("Plan covers local employees")
  }
  else if (employee == "state, local, and teachers") {
    employee <- c("Plan covers state, local and teachers")
  }
  if (is_null(employee)) {
    Data <- data.frame(Data)
  }
  else {
    Data %>% filter(type_of_employees_covered == paste(employee))
  }
}

###
##Pull PERSI data
##Load list of plans
pl <- planList()

#PULL DATA
Data <- pullStateData(2001)
Data <- filterData2(Data,2001)
Data <- Data %>% filter(year == 2021)

#View(Data)
Data <- Data %>% filter(plan_name == "South Carolina Retirement Systems")
#View(Data)
plan.name <- c("SCRS")

#Create table skeleton
table <- matrix(NA,7,3)
table[3:7,1] <- c("Total Employee", 
                  "Total Employer", 
                  "Employer (Debt Amortization)", 
                  "Employer (Normal Cost)", 
                   paste0("Total ", plan.name, " Contributions"))

#Use database numbers to populate/calculate needed values
table[2,2] <- c("% of payroll")
table[2,3] <- c("$ Value")
table[3,2] <- as.numeric(Data$ee_nc_pct)
table[3,3] <- as.numeric(Data$ee_contribution)
table[6,2] <- as.numeric(Data$er_nc_pct)
table[6,3] <- as.numeric(table[6,2]) * as.numeric(Data$payroll)
table[5,2] <- as.numeric(Data$statutory_pct)-as.numeric(Data$er_nc_pct)
table[5,3] <- as.numeric(table[5,2]) * as.numeric(Data$payroll)
table[4,2] <- sum(as.numeric(table[5:6,2]))
table[4,3] <- sum(as.numeric(table[5:6,3]))
table[7,2] <- as.numeric(Data$total_nc_pct)+as.numeric(table[5,2])
table[7,3] <- as.numeric(table[7,2])* as.numeric(Data$payroll)

table <- data.table(table)
colnames(table) <- c("Name", "Payroll", "Value")
table <- table[3:7,]
table$Value <- as.numeric(table$Value)
table$Payroll <- as.numeric(table$Payroll)

#Format data to %/$ for appearance
table[,3] <- scales::dollar(table$Value)
table[,2] <- scales::percent(table$Payroll, accuracy = 0.1)
colnames(table) <- c("", "% of Payroll", "$ Value")

#View(table)
#Knit the table
#knitr::kable(
#  table, caption = 'Pension Integrity Project pension database.'
#)

library(flextable)
library(officer)
colnames(table)[1] <- "Contribution Type"
#https://davidgohel.github.io/flextable/reference/index.html


table <-  table[1:5,1:3] %>% 
  tibble::rownames_to_column() %>% 
  select(-"rowname") %>%
  flextable() %>%
  set_header_labels(rowname = "")

table <- add_header_row(table, values = "FY2023 Contributions", colwidths = 3)

#Modify table style using "flextable"      
 table <- table %>%
  #theme_zebra() %>% 
    autofit() %>% 
    border_inner_h() %>% 
    border_outer() %>%
    border_inner_v() %>%
    border_inner_v(part = "header") %>%
    font(fontname = "Arial", part = "all") %>%
    align(part = "all", align = "center") %>%
    align(i = 3:4, align = "right") %>%
    italic(i = 3:4, j = NULL, italic = TRUE, part = "body") %>%
    bold(part = "all", bold = 4) %>%
    color(color = "black") %>%
    color(color = "white", part = "header") %>%
    bg(bg = c("#d3d8dd","#d3d8dd","#d3d8dd","#d3d8dd","#919daa"), part = "body") %>%
    bg(bg = c("#101010"), part = "header") %>%
    width(j = 1, width = 1.5)

 ## Set boder style
 head_border = fp_border(color= palette_reason$Orange, width = 2)
 inner_border = fp_border(color= "white", width = 1)
 
 ##Add border style to table

 table <- border_inner(table, part="all", border = inner_border )
 table <- border_outer(table, part="all", border = inner_border )
 table <- hline_bottom(table, part="header", border = head_border )
 table <-  fontsize(table, size = 18, part = "all")
 table <-  fontsize(table, size = 12, i = 3:4)
 table <- width(table, j = 1, width = 2.5)
 table <- width(table, j = 1:3, width = 2.2)
 
table
```

### How a Pension Plan is Funded w/ Image

![](HowFunded.png)

### A History of Investment Returns (2001-2021) w/ R (linePlot())

```{r graph, dpi = 400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial valuation reports.", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}
### linePlot ###
## Data: Database + Manual(AVA returns)
## Base: linePlot() function in `pensionviewr`
# By: Anil, Swaroop, and Jen

##linePlot() function parameters:

#data = data in data.frame, tibble, or data.table format,
#yaxisMin & yaxisMax = Y-axis mininum and maximum values
#yaxisSeq = set sequency of Major breaks
#yaxisScale = 100 for percentages
#format = set Y-axis format to either "%", "$", or empty
#str = set number of srings at which to cut legend text (default is 20),
#labelY = title of Y-axis,
#lab1 - lab5 = character string of line titles/names (default is 0 Lines)

rm(list=ls())

library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(dplyr)
library(plyr)
library(DT)
library(scales)

###################
#Using 2 New Functions to download and filter datat from datatabase
Data <- pullStateData(2001)
Data <- filterData(Data, 2001)
Data<- Data %>% filter (plan_name == "South Carolina Retirement Systems")
#View(Data)
Data$year <- as.numeric(Data$year)
#Set to data.frame for visualization
Data <- data.frame(Data)
 
# UAL4 <- data.table(UAL4[, Tr30 := tr30[(n-UAL4[!is.na(Actual_Return),.N]):last]])
###############
#Adding AVA returns (Arkansas ERS example*)
Data$year <- as.numeric(Data$year)
Data <- Data %>% select(year, return_1yr, ava_return, arr, dr)
Data$year <- as.numeric(Data$year)

#### Manually put in 2021 data

#Data[21,] <- data.frame(2021, 0.286, 0.101, 0.0725,0.0725)

#####Modified linePlot
#####Modified linePlot
linePlot <- function (data, title = NULL, caption = FALSE, grid = FALSE, 
  treasury = FALSE, inv.returns = TRUE, ticks = TRUE, font = NULL, 
  yaxisMin = 0, yaxisMax = NULL, yaxisSeq = 5, yaxisScale = 100, 
  format = NULL, str = 20, labelY = NULL, lab1 = NULL, lab2 = NULL, 
  lab3 = NULL, lab4 = NULL, lab5 = NULL) 
{
  reasontheme::set_reason_theme(style = "slide")
  
  plotTheme <- ggplot2::theme(   panel.grid.major = element_blank(),
                                 panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                 plot.margin = margin(0,0.5,0,0, "cm"),
                                 axis.text.y = element_text(size=12, color = "black"),
                                 axis.text.x = element_text(size=12, color = "black", angle = 0, hjust = 0.5, vjust = -1),
                                 axis.title = element_text(size = 12, face = "bold"),
                                 legend.text = element_text(size = 12),
                                 legend.title = element_blank(),
                                 text = element_text(family = "Calibri"))
  
  x <- length(data$year)
  data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
  if (isTRUE(treasury)) {
    urlfile <- "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/treasury.csv"
    treasury <- read_csv(url(urlfile), col_names = TRUE, 
      na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    treasury$year <- as.numeric(treasury$year)
    treasury <- treasury %>% filter(year>2000 & year < 2020)
    data$year <- as.numeric(data$year)
    treasury <- data.table(treasury %>% filter(year > min(data$year - 
      1)))
    data <- data %>% select(year, arr)
    data <- data.table(data)
    data <- cbind(data, treasury[, 2])
    data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
    data <- as.data.table(data)
    data$alt.discount <- NA
    diff <- (data[year == min(data$year)]$arr - data[year == 
      min(data$year)]$X30.treasury)
    data$alt.discount <- data$X30.treasury + diff
  }
  geomean <- function(x) {
    x <- as.vector(na.omit(x))
    x <- x + 1
    exp(mean(log(x))) - 1
  }
  if (isTRUE(inv.returns)) {
    data$return_1yr <- as.numeric(data$return_1yr)
    returns <- data$return_1yr
    last <- length(returns)
    rolling <- matrix(NA, last, 1)
    rolling[last] <- as.numeric(geomean(returns[(last - 
      9):last]))
    for (i in 1:(last - 10)) {
      rolling[last - i] <- geomean(returns[(last - 9 - 
        i):(last - i)])
    }
    rolling <- data.table(rolling)
    returns[(last - 9):last]
    returns[(last - 9 + 1):(last - 1)]
    data <- data.table(cbind(data, rolling))
    data <- data %>% select(year, return_1yr, ava_return, 
      arr, V1)
  }
  colnames(data) <- c("year", if (!is_null(lab1)) {
    paste(lab1)
  }, if (!is_null(lab2)) {
    paste(lab2)
  }, if (!is_null(lab3)) {
    paste(lab3)
  }, if (!is_null(lab4)) {
    paste(lab4)
  }, if (!is_null(lab5)) {
    paste(lab5)
  })
  
  data <- as.data.table(data)
  graph <- data.table(melt(data, id.vars = "year"))
  lineColors <- c(
    palette_reason$Orange,palette_reason$Yellow,palette_reason$SatBlue, 
    palette_reason$LightGrey, 
    palette_reason$LightGreen)
  options(repr.plot.width = 1, repr.plot.height = 0.75)
  ggplot2::ggplot(graph, ggplot2::aes(x = year, y = yaxisScale * 
    value, group = variable)) + ggplot2::geom_line(ggplot2::aes(colour = str_wrap(factor(variable), 
    str)), size = 1.5) + ggplot2::geom_hline(yintercept = 0, 
    color = "black") + ggplot2::scale_colour_manual(values = lineColors) + 
    ggplot2::scale_y_continuous(breaks = seq(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    }
    else {
      max(graph$value) * yaxisScale * 1.2
    }, by = yaxisSeq), limits = c(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    } else {
      max(graph$value) * yaxisScale * 1.2
    }), labels = function(b) {
      if (format == "%") {
        paste0(round(b, 0), "%")
      }
      else if (format == "$") {
        paste0("$", round(b, 0))
      }
      else {
        paste0(format, round(b, 0))
      }
    }, expand = c(0, 0)) + ggplot2::scale_x_continuous(breaks = seq(min(graph$year), 
    max(graph$year), by = 2), expand = c(0, 0)) + labs(x = element_blank(), 
    y = labelY) + theme(legend.text = element_text(size = 12)) + 
    theme(legend.direction = "vertical", legend.box = "horizontal", 
      legend.position = if (isTRUE(treasury)) {
        c(0.1, 1)
      }
      else {
        c(0.73, 0.09)
      }) + labs(title = paste(title), caption = ifelse(isTRUE(caption), 
    paste("reason.org/pensions"), paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) + ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    ggplot2::theme(text = element_text(family = if (!is_null(font)) {
      paste(font)
    }
    else {
      paste("Arial")
    }, size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid), 
    paste(palette_reason$SpaceGrey), "white"), size = (1))) + plotTheme
}


#Inv. Returns      
graph <- linePlot(Data, title = "", 
                  caption = FALSE, 
                  inv.returns = TRUE, 
                  treasury = FALSE,
                  font = "Calibri", 
                  yaxisMin = -24, yaxisMax = 36, yaxisSeq = 4,
                  yaxisScale = 100, format = "%", str = 60,
                  labelY = "", 
                  lab1 = "Market Valued Returns (Actual)", 
                  lab2 = "Actuarially Valued Investment Return (Smoothed by Plan)", 
                  lab3 = "Assumed Rate of Return", 
                  lab4 = "10-Year Geometric Rolling Average")

#Alternative DR vs. 30-Year Treasury
#graph <- linePlot(Data, title = "", inv.returns = FALSE, treasury = TRUE,
#                  font = "Calibri", yaxisMin = 0, yaxisMax = 9, yaxisSeq = 1,
#                  yaxisScale = 100, format = "%", str = 60,
#                  labelY = "", lab1 = "Actual Discount Rate", 
#                  lab2 = "30-Year Treasury Bond Yield Rate", 
#                  lab3 = "Alternative Discount Rate")
#graph
#Example w/ AVA vs. AAL
#Data <- Data %>% select(year, ava, aal)
#graph <- linePlot(Data, title = "", inv.returns = FALSE, treasury = FALSE,
#                  font = "Calibri",
#                  yaxisMin = 0, yaxisMax = 21, yaxisSeq = 3,
#                  yaxisScale = 1/1000000000, format = "$", str = 60,
#                  labelY = "AVA vs. AAL", lab1 = "Actuarial Value of Assets", 
#                  lab2 = "Actuarial Accrued Liabilities")

graph
```

### Investment Returns vs. Assumptions w/ R (flextable)

```{r}

rm(list=ls())

library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(dplyr)
library(plyr)
library(DT)
library(scales)
library(kableExtra)

###
##Pull PERSI data
##Load list of plans
pl <- planList()

Data <- pullStateData(2001)
Data <- filterData(Data, 2001)
Data<- Data %>% filter (plan_name == "South Carolina Retirement Systems")
#View(Data)
Data$year <- as.numeric(Data$year)
#Set to data.frame for visualization
Data <- data.frame(Data)
#View(Data)
# UAL4 <- data.table(UAL4[, Tr30 := tr30[(n-UAL4[!is.na(Actual_Return),.N]):last]])
###############
#Adding AVA returns (Arkansas ERS example*)



Data$year <- as.numeric(Data$year)
Data <- Data %>% select(year, return_1yr, ava_return, arr, dr)
Data$year <- as.numeric(Data$year)

#Data[21,] <- data.frame(2021, 0.286, 0.101, 0.0725,0.0725)

data <- Data
    data$return_1yr <- as.numeric(data$return_1yr)
    returns <- data$return_1yr
    returns <- as.numeric(returns)
    last <- length(returns)

      geomean <- function(x) {
    x <- as.vector(na.omit(x))
    x <- x + 1
    exp(mean(log(x))) - 1
}

gmean.5 <- geomean(returns[(last -4):last])
gmean.10 <- geomean(returns[(last -9):last])
gmean.15 <- geomean(returns[(last -14):last])
gmean.20 <- geomean(returns[(last -19):last])


 data$ava_return <- as.numeric(data$ava_return)
    ava.returns <- data$ava_return 
    
ava.gmean.5 <- geomean(ava.returns[(last -4):last])
ava.gmean.10 <- geomean(ava.returns[(last -9):last])
ava.gmean.15 <- geomean(ava.returns[(last -14):last])
ava.gmean.20 <- geomean(ava.returns[(last -19):last])

plan.name <- c("SCRS")

#Create table skeleton
table <- matrix(NA,4,3)
table[1:4,1] <- c("20-Years (2002-2021)", 
               "15-Years (2007-2021)", 
               "10-Years (2012-2021)", 
               "5-Years (2017-2021)")

#Use database numbers to populate/calculate needed values

table[1:4,2] <- c(round(gmean.20,3),round(gmean.15,3), round(gmean.10,3), round(gmean.5,3))
table[1:4,3] <- c( round(ava.gmean.20,3), round(ava.gmean.15,3), round(ava.gmean.10,3),round(ava.gmean.5,3))

table<-  data.frame(table)

table[1:4,2] <- scales::percent(as.numeric(table[1:4,2], accuracy = 0.1))
table[1:4,3] <- scales::percent(as.numeric(table[1:4,3], accuracy = 0.1) )

colnames(table) <- c("", "Average Market Valued Returns","Average Actuarially Valued Returns")

#View(table)
#Knit the table
#knitr::kable(
#  table, caption = 'Pension Integrity Project pension database.'
#)

library(flextable)
library(officer)
colnames(table)[1] <- "Year"
#https://davidgohel.github.io/flextable/reference/index.html

#Modify table style using "flextable"      
 table <-  table[1:4,1:3] %>% 
  tibble::rownames_to_column() %>% 
  select(-"rowname") %>%
  flextable() %>%
  set_header_labels(rowname = "") %>%
  #theme_zebra() %>% 
    autofit() %>% 
    border_inner_h() %>% 
    border_outer() %>%
    border_inner_v() %>%
    border_inner_v(part = "header") %>%
    font(fontname = "Arial", part = "all") %>%
    align(part = "all", align = "center") %>%
    bold(part = "all", bold = 4) %>%
    color(color = "black") %>%
    color(color = "white", part = "header") %>%
    bg(bg = c("#919daa","#d3d8dd"), part = "body") %>%
    bg(bg = c("#101010"), part = "header") %>%
    width(j = 1, width = 1.5)

 
 ## Set boder style
 head_border = fp_border(color= palette_reason$Orange, width = 2)
 inner_border = fp_border(color= "white", width = 1)
 
 ##Add border style to table

 table <- border_inner(table, part="all", border = inner_border )
 table <- border_outer(table, part="all", border = inner_border )
 table <- hline_bottom(table, part="header", border = head_border )
 table <-  fontsize(table, size = 18, part = "all")
 table <- width(table, j = 1, width = 3)
 table <- width(table, j = 2:3, width = 2)
 table
 
```

### S&P500 vs. Funded Ratio (2001-2020) w/ R (areaPlot())

```{r sp500, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial valuation reports.", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

rm(list=ls())
###Load/install packages
#R.Version()
#https://github.com/ReasonFoundation/pensionviewr
#Create token -> usethis::edit_r_environ() -> restart -> Sys.getenv("GITHUB_PAT")
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(dplyr)
library(plyr)

###
##Pull PERSI data
##Load list of plans
pl <- planList()

#PULL DATA
Data <- pullStateData(2001)
Data <- filterData(Data,2001)
Data <- Data %>% filter(year < 2022)

Data <- Data %>% filter(plan_name == "South Carolina Retirement Systems")
Data$year <- as.numeric(Data$year)
Data$ava <- as.numeric(Data$ava)
Data$aal <- as.numeric(Data$aal)

############
areaPlot <- function(data, title = NULL, caption = FALSE, grid = FALSE, 
                     yaxisScale = 1e-06, 
                     maxYear = 2021,
                     labelY = "Unfunded Accrued Actuarial Liabilities (Millions)",
                     ticks = TRUE, sp500 = FALSE, font) 
{
  
  
  plotTheme <- ggplot2::theme(   panel.grid.major = element_blank(),
                                 panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                 plot.margin = margin(0,0,0,0, "cm"),
                                 axis.text.y = element_text(size=12, color = "black"),
                                 axis.text.x = element_text(size=12, color = "black", angle = 0, hjust = 0.5, vjust = -1),
                                 axis.title = element_text(size = 12, face = "bold"),
                                 legend.text = element_text(size = 12),
                                 legend.title = element_blank(),
                                 text = element_text(family = "Calibri"))
  
  if (isTRUE(sp500)) {
    urlfile2 = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/S%26P500.csv"
    SP500 <- read_csv(url(urlfile2), col_names = TRUE, na = c(""), 
      skip_empty_rows = TRUE, col_types = NULL)
    SP500 <- SP500 %>% filter(year >= min(data$year) & year < (maxYear+1))
    data <- cbind(data, SP500[, 2])
    graph <- data.frame(data %>% select(year, SP500 = sp_500, 
      funded_ratio) %>% tidyr::drop_na())
  }
  else {
    data <- as.data.table(data)
    data <- data %>% filter(year < (maxYear+1))
    data$uaal <- (data$aal - data$ava)
    data <- data %>% dplyr::filter(data$uaal != 0)
    extrapo <- stats::approx(data$year, data$uaal, n = 10000)
    extrapo2 <- stats::approx(data$year, data$funded_ratio, 
      n = 10000)
    graph <- data.frame(year = extrapo$x, uaal = extrapo$y, 
      funded_ratio = extrapo2$y) %>% tidyr::drop_na()
    graph <- graph %>% dplyr::mutate(sign = dplyr::case_when(.data$uaal >= 
      0 ~ "positive", .data$uaal < 0 ~ "negative"))
  }
  graph$funded_ratio <- as.numeric(graph$funded_ratio)
  graph$year <- as.numeric(graph$year)
  if (!isTRUE(sp500)) {
    graph$uaal <- as.numeric(graph$uaal)
  }
  y_minimum <- as.numeric(min(if (!isTRUE(sp500)) {
    min(graph$uaal,0)
  } else {
    0
  }))
  y_maximum <- as.numeric(max(if (!isTRUE(sp500)) {
    graph$uaal
  } else {
    graph$SP500
  }))
  reasontheme::set_reason_theme(style = "slide")
  
  #annotation <- data.frame(
  # x = c(2004, 2018),
  # y = c(10/yaxisScale, 20/yaxisScale),
  # label = c(paste("FYE 2001:",round(data.table(Data$ava/Data$aal)[1]*100,1),"%"), "2020 FR")
  # )
  
  ggplot2::ggplot(graph, ggplot2::aes(x = graph$year)) + ggplot2::geom_area(ggplot2::aes(y = if (!isTRUE(sp500)) {
    graph$uaal
  }
  else {
    graph$SP500
  }, fill = if (!isTRUE(sp500)) {
    graph$sign
  }
  else {
    palette_reason$Orange
  })) + ggplot2::geom_line(ggplot2::aes(y = graph$funded_ratio * 
    (y_maximum)), color = palette_reason$GreyBlue, size = 1.5) + 
    ggplot2::labs(y = if (!isTRUE(sp500)) {
      labelY
    }
    else {
      "S&P500 Index"
    }, x = NULL) + ggplot2::scale_fill_manual(values = if (!isTRUE(sp500)) {
    c(negative = paste(palette_reason$Green), positive = paste(palette_reason$Red))
  }
  else {
    c(paste(palette_reason$Yellow))
  }) + ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 10), 
    labels = scales::dollar_format(prefix = if (!isTRUE(sp500)) {
      "$"
    }
    else {
      ""
    }, scale = if (!isTRUE(sp500)) {
      (yaxisScale)
    }
    else {
      1
    }, largest_with_cents = if (!isTRUE(sp500)) {
      1
    }
    else {
      0.001
    }), limits = c(y_minimum, y_maximum * 1.2), sec.axis = ggplot2::sec_axis(~./(y_maximum/100), 
      breaks = scales::pretty_breaks(n = 10), name = "Funded Ratio", 
      labels = function(b) {
        paste0(round(b, 0), "%")
      }), expand = c(0, 0)) + geom_hline(yintercept = 0, 
    linetype = "solid", color = "black", size = 0.5) + labs(title = paste(title), 
    caption = ifelse(isTRUE(caption), paste("reason.org/pensions"), 
      paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) + ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(plot.margin = margin(0, 0,0,0, "cm"))+
    ggplot2::theme(panel.border = element_blank(),axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    coord_cartesian(expand = FALSE, xlim = c(min(graph$year), 
      max(graph$year)), ylim = c(y_minimum, y_maximum * 
      1.202)) + ggplot2::scale_x_continuous(breaks = round(seq(min(graph$year), 
    maxYear, by = 2), 1), expand = c(0, 0)) + ggplot2::theme(legend.position = "none") + 
    ggplot2::theme(text = element_text(family = paste(font), 
      size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid),
    paste(palette_reason$SpaceGrey), "white"), size = (1)))+ plotTheme 
  # + geom_text(data=annotation, aes(x=x, y=y, label=label),
  #         color="black", 
  #         size=5 , angle=0, fontface="bold" )
}

sp500 <- areaPlot (Data, title = "" , 
                   caption = FALSE, 
                   grid = FALSE, 
                   ticks = FALSE, 
                   maxYear = 2021,
                   sp500 = TRUE, 
                   font = "Calibri")

sp500
```

### New Normal: The Market Has Changed

The "new normal" for the institutional investing, despite the post-COVID rebound, suggests that achieving even a 6% average rate of return is optimistic.

</p>

1.  Over the past two decades there has been a steady change in the nature of the institutional investment returns.

    -   30-year Treasury yields have fallen from around 8% in the 1990s to consistently less or around 3% today.

    -   Globally, interest rates are at the ultralow historic levels, while market liquidity continues to be restrained by financial regulations.

        </p>

2.  McKinsey & Co. forecast the returns to equities will be 20% to 50% lower over the next two decades compared to the previous three decades.

    -   Using their forecast, the best-case scenario for a 60/40 portfolio of equities and bonds is likely to earn less than a 5% return.

        </p>

3.  As SCRS waits for the continual "rebound" its unfunded liabilities continue to grow.


### Probability Analysis w/ R (flextable())

```{r table, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project Monte Carlo model based on SCRS asset allocation and reported expected returns by asset class. Forecasts of returns by asset class generally by BNYM, JPMC, BlackRock, Research Affiliates, and Horizon Actuarial Services were matched to the SCRS specific asset class. Probability estimates are approximate as they are based on the aggregated return by asset class. For complete methodology contact Reason Foundation.", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

rm(list = ls())
start_time <- Sys.time()
library("readxl")
library(tidyverse)
library(ggridges)
library(ggplot2)
library(scales)
#setwd("/Users/anilniraula/databaseR")
#

palette_reason <- list(Orange="#FF6633",
                       LightOrange="#FF9900",
                       DarkGrey="#333333", 
                       LightGrey= "#CCCCCC", 
                       SpaceGrey ="#A69FA1",
                       DarkBlue="#0066CC", 
                       GreyBlue= "#6699CC", 
                       Yellow= "#FFCC33",
                       LightBlue = "#66B2FF", 
                       SatBlue = "#3366CC", 
                       Green = "#669900",LightGreen = "#00CC66", Red = "#CC0000",LightRed="#FF0000")

##############
#user can change these values
FileName <- "SCRS_Return_Data.xlsx"
NumberofYears <- 20
NumberofSimulations <- 100000

Percentiles <- c(5,10,25,50,75,90,95)
Probabilities <- c(9,8,7.0,6.5,6,5.5,5)
FundARR <- 0.07
#
#Field List has list of asset classes for each bank to look up for returns and correlations
TemplateData <- read_excel(FileName, sheet = "FieldList")

#Each Bank has its own tab, get tab list
Tabs <- excel_sheets(FileName)

#Set default return matrix for which the avg is calculated
ReturnMatrix <- TemplateData[,1:4]

#clean it up
ReturnMatrix[,3:4] <- as.double(0)

#Set default correlation matrix for average
CorrelationMatrix <- matrix(0, nrow = nrow(TemplateData), ncol = nrow(TemplateData))
#
#Initialize Tabs
#initialize the summary tab
SummaryTab <- c('Bank Name','20-year geometric avg return (mean)',
                '20-year geometric avg return (median)',
                'Standard deviation of 20-year avg returns',
                'Annual arithmetic avg return',
                'Standard deviation of annual returns')

#Initialize Percentile Tab based on start,end and gap
PercentileTab <- c('Percentile')
for (i in 1:length(Percentiles)){
  textlabel <- c(paste(as.character(Percentiles[i]),"th percentile"))
  PercentileTab <- rbind(PercentileTab,textlabel)
}

#Initialize Probability Tab based on start,end and gap
ProbabilityTab <- c('Return')
for (i in 1:length(Probabilities)){
  textlabel <- c(paste(as.character(Probabilities[i]),"%"))
  ProbabilityTab <- rbind(ProbabilityTab,textlabel)
}
#
#We need to calculate Arithmetic return from assumed geometric return
GeomArithReturn <- function(ArithReturn, Variance){
  GeomArithReturn <- ArithReturn - ((Variance*Variance)/(2*(1+ArithReturn)))
}

#use a bisection method to solve for arithmetic return
GetArithReturn <- function(Variance, Target){
  Signal <- 'Add'
  Increment <- 0.1
  ArithReturn <- 0.1
  Check <- 'Fail'
  Difference <- Target - GeomArithReturn(ArithReturn,Variance)
  
  while (Check != 'Pass'){
    if((Difference < 0) && (Signal == 'Add')){
      Increment <- -0.5*Increment
      Signal <- 'Subtract'
    } else if ((Difference > 0) && (Signal == 'Subtract')) {
      Increment <- -0.5*Increment
      Signal <- 'Add'
    }
    
    ArithReturn <- ArithReturn + Increment
    Difference <- Target - GeomArithReturn(ArithReturn,Variance)
    if(abs(Difference) < 1e-6){
      Check <-'Pass'
    }
  }
  
  return(ArithReturn)
}
#
#
#View(read_excel(FileName, sheet = Tabs[9]))

#Go through each tab. Each tab is each bank
#First Tab is FieldList, so start at 2
for (i in 2:(length(Tabs))){
  TabData <- read_excel(FileName, sheet = Tabs[i])
  
  #For each bank, get field list and tab data
  #For fund details and Historical, dont do the correlation matrix calculation
  if((Tabs[i] != 'Plan Assumptions') && (Tabs[i] != 'Historical')){
    #initialize the return matrix and get fieldlist for each bank
    FieldList <- TemplateData[,grep(Tabs[i],colnames(TemplateData))]
    ReturnMatrix[,1] <- FieldList
    
    for (j in 1:nrow(FieldList)){
      #Get row index for asset class
      RowIndex <- which(TabData[,1] == as.character(FieldList[j,1]))
      #Volatility
      ReturnMatrix[j,3] <- as.double(TabData[RowIndex,4])
   
      #Returns
      ReturnMatrix[j,4] <- as.double(TabData[RowIndex,3])
      
      #Because it's a square matrix, you can iterate through nrow(FielList) for the column part
      for (k in 1:nrow(FieldList)){
        ColIndex <- which(colnames(TabData) == as.character(FieldList[k,1]))
        CorrelationMatrix[j,k] <- as.double(TabData[RowIndex,ColIndex])
      }
    }
  }
  
  #View(AnnualVolatility*2)
  #Do this for each bank and for each component of the output - summary, percentile, probabilities
  #For Fund details, the volatility for the whole is given, no need for calc
  if(Tabs[i] == 'Plan Assumptions'){
    AnnualVolatility <- HorizonVol
    AnnualMeanReturn <- GetArithReturn(HorizonVol, FundARR)
  } else if(Tabs[i] == 'Historical'){
    AnnualVolatility <- sd(as.matrix(TabData[,2]))
    AnnualMeanReturn <- mean(as.matrix(TabData[,2]))
  } else {
    AnnualMeanReturn <- sum(ReturnMatrix[,2]*ReturnMatrix[,4])
    #Convert to Matrix for later operations
    WeightVolatility <- as.matrix(ReturnMatrix[,2]*ReturnMatrix[,3])
    Matrix1 <- CorrelationMatrix %*% WeightVolatility
    AnnualVariance <- t(WeightVolatility) %*% Matrix1
    AnnualVolatility <- sqrt(AnnualVariance)
    
    if(Tabs[i] == 'Horizon10'){
      HorizonVol <- AnnualVolatility
    }
  }
  
  #set.seed is for fixing the simulation to avoid too much variance
  set.seed(1234)
  georeturn <- function(return) {
    georeturn <- prod(1+return)^(1/length(return)) - 1
    return(georeturn)
  }
  
  #simulate the returns
  randomreturn <- rnorm(NumberofYears, mean = AnnualMeanReturn, sd = AnnualVolatility)
  georeturnsim <- replicate(n = NumberofSimulations,georeturn(rnorm(NumberofYears, mean =       AnnualMeanReturn, sd = AnnualVolatility)))
  
  #Simulation Data for Ridgeline plot later
  Temp <- as.data.frame(georeturnsim)
  Temp[,2] <- Tabs[i]
  Temp[,3] <- AnnualMeanReturn
  colnames(Temp) <- c('Data', 'Plan Name', 'Mean Return')
  
  if(i == 2){
    SimulationData <- Temp
  } else {
    SimulationData <- rbind(SimulationData, Temp)
  }
  #View(SummaryTab)
  #Summary Tab
  BankSummaryData <- c(Tabs[i],mean(georeturnsim),
                       median(georeturnsim),
                       sd(georeturnsim),
                       AnnualMeanReturn,
                       AnnualVolatility)
  SummaryTab <- rbind(SummaryTab,BankSummaryData)
  #View(SummaryTab)
  #Percentile Tab
  BankPercentile <- c(Tabs[i])
  for (p in 1:length(Percentiles)){
    ReturnPerc <- quantile(georeturnsim, (Percentiles[p]/100), na.rm = TRUE)
    BankPercentile <- rbind(BankPercentile,ReturnPerc)
  }
  PercentileTab <- cbind(PercentileTab,BankPercentile)
  
  #Probability Tab
  BankProbability <- c(Tabs[i])
  for (p in 1:length(Probabilities)){
    ReturnPercent <- sum(georeturnsim >= (Probabilities[p]/100)) / NumberofSimulations
    BankProbability <- rbind(BankProbability,ReturnPercent)
  }
  ProbabilityTab <- cbind(ProbabilityTab,BankProbability)
}
SummaryTab <- t(SummaryTab)

#Reorder the capital assumption sources
SimulationData <- SimulationData %>% 
  arrange(`Mean Return`) %>% 
  mutate(`Plan Name` = factor(`Plan Name`, levels = unique(`Plan Name`), ordered = T)) 
#Plot the distribution of simulated expected returns

#ggsave("AvgReturn Distribution.png", width = 6, height = 4, dpi = 800)  

#Write to csv file

#write_excel_csv(as.data.frame(SummaryTab), 'AvgSummary.csv',col_names = FALSE)
#write_excel_csv(as.data.frame(PercentileTab), 'AvgPercentiles.csv',col_names = FALSE)
#write_excel_csv(as.data.frame(ProbabilityTab), 'AvgReturn Probabilities.csv',col_names = FALSE)

#Cal run time
#end_time <- Sys.time()
#print(end_time - start_time)


#########

library(flextable)
library(officer)

table <- data.frame(ProbabilityTab)
table <- table[2:8,2:9]
table <- table %>% mutate_all(as.numeric) %>%
  mutate_all(scales::percent)

table <- rbind(ProbabilityTab[1,2:9],table)
table <- cbind(ProbabilityTab[1:8,1],table)
colnames(table) <- ProbabilityTab[1,]
table <- table[-1,]

table <- table %>% select("Return", 
                "Plan Assumptions",
                "Historical",
                "Research Affiliates",
                "JP Morgan",
                "BNY Mellon",
                "Horizon10",
                "Horizon20",
                "BlackRock")

colnames(table) <- c("Possible Rates of Return",
                     "Based on SCRS Assumptions",
                     "SCRS Historical Returns",
                     "Research Affiliates 10-Year Forecast",
                     "JP Morgan 10-15 Year Forecast",
                     "BNY Mellon 10-Year Forecast",
                     "Horizon 10-Year Market Forecast",
                     "Horizon 20-Year Market Forecast",
                     "BlackRock 20-Year Forecast")
#colnames(table)[1] <- "Year"
#https://davidgohel.github.io/flextable/reference/index.html

#Modify table style using "flextable"      
table <-  table[1:8,1:9] %>% 
  tibble::rownames_to_column() %>% 
  select(-"rowname") %>%
  flextable() %>%
  set_header_labels(rowname = "") %>%
  #theme_zebra() %>% 
  autofit() %>% 
  border_inner_h() %>% 
  border_outer() %>%
  border_inner_v() %>%
  border_inner_v(part = "header") %>%
  font(fontname = "Arial", part = "all") %>%
  align(part = "all", align = "center") %>%
  bold(part = "all", bold = 4) %>%
  color(color = "black") %>%
  color(color = "white", part = "header") %>%
  bg(bg = c("#919daa","#d3d8dd"), part = "body") %>%
  bg(bg = c("#101010"), part = "header") %>%
  width(j = 1, width = 1.5)

## Set boder style
head_border = fp_border(color= palette_reason$Orange, width = 2)
inner_border = fp_border(color= "white", width = 1)

##Add border style to table

table <- border_inner(table, part="all", border = inner_border )
table <- border_outer(table, part="all", border = inner_border )
table <- hline_bottom(table, part="header", border = head_border )
#table <- vline(table, j = 1, border = "std_border") %>%
table <-  fontsize(table, size = 13, part = "all")
table <-  fontsize(table, size = 13, i = 1:8)
table <-  fontsize(table, size = 13, i = 3)
table <- width(table, j = 1:9, width = 1)

table
```

### SCRS Unfunded Liability Sensitivity to DR Changes 2021 w/ R (flextable())

```{r}

rm(list=ls())

library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(dplyr)
library(plyr)
library(DT)
library(scales)

pullStateData <- function (FY)
{
  con <- RPostgres::dbConnect(
    RPostgres::Postgres(),
    dbname = "d629vjn37pbl3l",
    host = "ec2-3-209-200-73.compute-1.amazonaws.com",
    port = 5432,
    user = "reason_readonly",
    password = "p88088bd28ea68027ee96c65996f7ea3b56db0e27d7c9928c05edc6c23ef2bc27",
    sslmode = "require")
  
  query <- paste("select * from pull_data_state_only()\nwhere year > '",
                 paste(FY - 1), "'\nand attribute_name in ('1 Year Investment Return Percentage',\n'PPD Fund ID',\n'Number of Employers',\n'Number of Plans',\n'Actuarial Cost Method in GASB Reporting',\n'Employer Normal Cost Percentage',\n'Total Normal Cost Dollar',\n'Actuarial Funded Ratio Percentage',\n'Market Investment Return (MVA Basis)',\n'Actuarial Value of Assets GASB Dollar',\n'Market Value of Assets Dollar',\n'Market Assets Reported for Asset Smoothing',\n'Actuarially Accrued Liabilities Dollar',\n'Total Pension Liability Dollar',\n'Actuarially Determined Contribution Percentage of Payroll',\n'Actuarially Required Contribution Dollar',\n'Actuarially Required Contribution Paid Percentage',\n'Total Employer Contributions',\n'Statutory Payment Dollar',\n'Statutory Payment Percentage',\n'Amortizaton Method',\n'Total Benefits Paid Dollar',\n'Benefit Payments Dollar',\n'Refunds Dollar',\n'Administrative Expense Dollar',\n'Cost Structure',\n'Asset Valuation Method for GASB Reporting',\n'Covered Payroll Dollar',\n'Employee Contribution Dollar',\n'Employee Normal Cost Percentage',\n'Employer Contribution Regular Dollar',\n'Employer Normal Cost Dollar',\n'Employer State Contribution Dollar',\n'ADEC as a Percent of Payroll',\n'Other Contribution Dollar',\n'Other Additions',\n'Fiscal Year of Contribution',\n'Inflation Rate Assumption For GASB Reporting',\n'Investment Return Assumption for GASB Reporting',\n'Discount Rate Assumption',\n'Number of Years Remaining on Amortization Schedule',\n'Payroll Growth Assumption',\n'Unfunded Actuarially Accrued Liabilities Dollar',\n'Total Contribution Dollar',\n'Total Normal Cost Percentage',\n'Net Pension Liability Dollar',\n'Net Pension Liability Assuming 1% Decrease in Discount Rate',\n'Net Pension Liability Assuming 1% Increase in Discount Rate',\n'Total Number Of Members',\n'Total Projected Actuarial Required Contribution Percentage Of Payroll',\n'Actuarially Required Contribution Paid Dollar',\n'Actuarially Determined Contribution Paid Dollar',\n'Type of Employees Covered',\n'Total Amortization Payment Percentage',\n'Wage Inflation')")
  result <- RPostgres::dbSendQuery(con, query)
  all_data <- RPostgres::dbFetch(result) %>% janitor::clean_names()
  RPostgres::dbClearResult(result)
  RPostgres::dbDisconnect(con)
  all_data %>% dplyr::group_by_at(dplyr::vars(-.data$attribute_value)) %>%
    dplyr::mutate(row_id = 1:dplyr::n()) %>% dplyr::ungroup() %>%
    tidyr::pivot_wider(names_from = attribute_name, values_from = attribute_value) %>%
    dplyr::select(-.data$row_id) %>% dplyr::arrange(display_name,
                                                    year) %>% janitor::clean_names()
}

#############
#############

filterData2 <- function(Data, fy = 2001,
                       inflation = TRUE,
                       expenditure = TRUE,
                       employee = NULL,
                       blend.teacher = FALSE,
                       source = FALSE) {
  if (isTRUE(blend.teacher)) {
    blended.teach <- c("Arizona State Retirement System",
                       "Delaware State Employees’ Pension Plan", "District of Columbia Teachers Retirement Fund",
                       "Florida Retirement System", "Employee Retirement System of Hawaii",
                       "Idaho Public Employee Retirement System", "Iowa Public Employees' Retirement System",
                       "Kansas Public Employees' Retirement System", "Public Employees' Retirement System of Mississippi",
                       "Nevada Public Employees Retirement System", "New Hampshire Retirement System",
                       "North Carolina Teachers' and State Employees' Retirement System",
                       "Oregon Public Employees Retirement System", "Rhode Island Employees Retirement System",
                       "South Carolina Retirement Systems", "South Dakota Retirement System",
                       "Tennessee Consolidated Retirement System, Teachers Pension Plan",
                       "Utah Retirement Systems, Noncontributory Retirement System",
                       "Virginia Retirement System", "Wisconsin Retirement System",
                       "Wyoming Retirement System, Public Employees’ Pension Plan",
                       "Maine Public Employees Retirement System (PERS) Defined Benefit Plan",
                       "Maryland State Employees’ Retirement System")
    Data <- data.frame(Data)
    Data <- Data %>% mutate(type_of_employees_covered = case_when(display_name %in%
                                                                    blended.teach ~ "Plan covers state, local and teachers",
                                                                  TRUE ~ type_of_employees_covered))
  }
  Data <- data.frame(Data)
  columns <- c("total_pension_liability_dollar", "wage_inflation",
               "payroll_growth_assumption", "other_contribution_dollar",
               "other_additions_dollar", "x1_year_investment_return_percentage",
               "amortizaton_method", "number_of_years_remaining_on_amortization_schedule",
               "amortization_payment_total_amount",
               "total_normal_cost_dollar", "fiscal_year_of_contribution",
               "statutory_payment_dollar", "statutory_payment_percentage",
               "ppd_fund_id", "number_of_employers", "number_of_plans",
               "discount_rate_assumption", "market_investment_return_mva_basis", 
               "actuarially_determined_contribution_dollar",
               "net_pension_liability_dollar",
               "net_pension_liability_assuming_1_percent_decrease_in_discount_rate",
               "net_pension_liability_assuming_1_percent_increase_in_discount_rate",
               "actuarially_required_contribution_paid_dollar",
               "actuarially_determined_contribution_paid_dollar",
               "cost_structure", "employer_normal_cost_percentage", "actuarial_value_of_assets_dollar",
               "asset_valuation_method_for_gasb_reporting", "inflation_rate_assumption",
               "total_number_of_members", "total_projected_actuarial_required_contribution_percentage_of_payroll",
               "market_assets_reported_for_asset_smoothing")
  columns2 <- c("test")
  for (i in (1:length(columns))) {
    if (sum(colnames(Data) %in% columns[i]) == 0) {
      columns2 <- rbind(columns2, columns[i])
    }
  }
  columns2 <- as.character(columns2 <- columns2[2:length(columns2)])
  cols <- matrix(NA, length(Data[, 1]), length(columns2))
  colnames(cols) <- columns2
  Data <- cbind(Data, cols)
  Data <- data.frame(Data)
  Data <- Data %>% arrange(state, display_name, year)
  Data$year <- as.numeric(Data$year)
  if (isTRUE(inflation)) {
    library(readxl)
    library(httr)
    url1 <- "https://github.com/ReasonFoundation/databaseR/raw/master/files/CPI_by_Region_DOL.xlsx"
    GET(url1, write_disk(tf <- tempfile(fileext = ".xlsx")))
    cpi <- read_excel(tf, sheet = 1)
    regions <- read_excel(tf, sheet = 2)
    cpi <- data.table(cpi)
    regions <- data.table(regions)
    cpi$cpi.change <- NA
    for (i in (2:length(cpi$region))) {
      cpi$cpi.change[i] <- (cpi$cpi[i]/cpi$cpi[i - 1]) -
        1
    }
    Data <- Data %>% left_join(regions, by = "state")
    Data <- Data %>% left_join(cpi, by = c("year", "region"))
    Data <- Data %>% select(-cpi)
  }

  if (isTRUE(expenditure)) {

    #1. General Fund Exp./Rev. NASBO (State)
    #2. Total Exp./Rev. NASBO (State) --> general funds, other state funds, bonds, and federal funds.
    #3. Total Exp./Rev. Urban (State & Local) --> state and local direct general expenditures (exclude “business-like” activities such as utilities and transfers between state and local governments.)

    library(readxl)
    library(httr)
    urlfile="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/NASBO_Exp_Report_Data_v1.csv"
    NASBO<-read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    NASBO <- setDT(NASBO)
    NASBO <- NASBO %>% select(YEAR, STATE,"TOTAL_CAPI") %>% filter(YEAR>2000)
    #View(NASBO)
    colnames(NASBO)[1] <- "year"
    colnames(NASBO)[2] <- "state"
    Data <- Data %>% left_join(NASBO, by = c("year","state"))
    ####
    urlfile="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/UrbanCensus_ExpRev_2000-2018.csv"
    Urban<-read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    Urban <- setDT(Urban)

    Urban <- Urban %>% select(Year, State,"(R01) Total Revenue", "(E001) Total Expenditure")

    colnames(Urban)[1] <- "year"
    colnames(Urban)[2] <- "state"
     
    Data <- Data %>% left_join(Urban, by = c("year","state"))

  }


  Data <- Data %>% select(year, plan_name = display_name,
                          state, if (isTRUE(source)) {
                            "data_source_name"
                          }, return_1yr = x1_year_investment_return_percentage,
                          ava_return = market_investment_return_mva_basis, actuarial_cost_method_in_gasb_reporting,
                          funded_ratio = actuarial_funded_ratio_percentage, ava = actuarial_value_of_assets_gasb_dollar, #actuarial_value_of_assets_gasb_dollar (PPD)
                          mva = market_value_of_assets_dollar, mva_smooth = market_assets_reported_for_asset_smoothing,
                          aal = actuarially_accrued_liabilities_dollar,
                          adec1 = actuarially_determined_contribution_dollar,
                          adec2 =   actuarially_required_contribution_paid_dollar,  #actuarially_required_contribution_dollar (PPD)
                          adec_paid_pct = actuarially_required_contribution_paid_percentage,
                          adec_pct = adec_as_a_percent_of_payroll, #instead of employers_projected_actuarial_required_contribution
                          arc_paid_dollar = actuarially_required_contribution_paid_dollar, #NEW
                          adec_paid_dollar = actuarially_determined_contribution_paid_dollar,#NEW
                          statutory = statutory_payment_dollar, statutory_pct = statutory_payment_percentage,
                          amortizaton_method, total_benefit_payments = total_benefits_paid_dollar,
                          benefit_payments = benefit_payments_dollar, refunds = refunds_dollar,
                          admin_exp = administrative_expense_dollar, cost_structure,
                          state_exp_NASBO = TOTAL_CAPI, #gf_rev_NASBO = "TOTAL REV",
                          state.local_exp_Census = "(R01) Total Revenue", state.local_rev_Census = "(E001) Total Expenditure",
                          fund_id = ppd_fund_id, employers = number_of_employers,
                          plans = number_of_plans, asset_valuation_method_for_gasb_reporting,
                          payroll = covered_payroll_dollar, ee_contribution = employee_contribution_dollar,
                          ee_nc_pct = employee_normal_cost_percentage,
                          er_nc_pct = employer_normal_cost_percentage,total_nc_pct = total_normal_cost_percentage, 
                          er_contribution = employer_contribution_regular_dollar, er_state_contribution = employer_state_contribution_dollar,
                          other_contribution = other_contribution_dollar, other_additions = other_additions_dollar,
                          fy_contribution = fiscal_year_of_contribution, inflation_assum = inflation_rate_assumption,
                          arr = investment_return_assumption_for_gasb_reporting,
                          dr = discount_rate_assumption, number_of_years_remaining_on_amortization_schedule,
                          payroll_growth_assumption, total_amortization_payment_pct = total_amortization_payment_percentage,
                          total_amo_payment = amortization_payment_total_amount, #Added
                          total_contribution = total_contribution_dollar,
                          total_nc_dollar = total_normal_cost_dollar, total_number_of_members,
                          total_proj_adec_pct = total_projected_actuarial_required_contribution_percentage_of_payroll,
                          tpl = total_pension_liability_dollar,
                          npl_pct_down = net_pension_liability_assuming_1_percent_decrease_in_discount_rate, #Added
                          npl = net_pension_liability_dollar, #Added
                          npl_pct_up = net_pension_liability_assuming_1_percent_increase_in_discount_rate, #Added
                          type_of_employees_covered, unfunded_actuarially_accrued_liabilities_dollar,
                          wage_inflation, region, cpi.change)

  
  ## Combining ARC & ADEC
  Data$arc_adec_dollar <- ifelse(is.na(Data$adec1) == TRUE,Data$adec2, Data$adec1)
  Data$arc_adec_paid_dollar <- ifelse(is.na(Data$arc_paid_dollar) == TRUE, Data$adec_paid_dollar, Data$arc_paid_dollar)
  
  Data$fy_contribution <- as.numeric(Data$fy_contribution)
  Data$year <- as.numeric(Data$year)
  Data$fy_contribution <- round(Data$fy_contribution, 0)
  Data <- Data %>% filter(year >= fy) #%>% select(-adec1, -adec2)

  #https://www.urban.org/policy-centers/cross-center-initiatives/state-and-local-finance-initiative/projects/state-fiscal-briefs/florida

  if (isTRUE(expenditure)) {
   Data$ava <- as.numeric(Data$ava)
   Data$aal <- as.numeric(Data$aal)
   Data$state_exp_NASBO <- as.numeric(Data$state_exp_NASBO)
   Data$state.local_exp_Census <- as.numeric(Data$state.local_exp_Census)
   Data <- Data %>% group_by(state, year) %>% mutate(ual_exp_NASBO = round((sum(aal)-sum(ava))/(state_exp_NASBO*1000000),2),
                                                     ual_exp_Census = round((sum(aal)-sum(ava))/(state.local_exp_Census*1000),2))
  }

  if (is_null(employee)) {
    employee <- employee
  }
  else if (employee == "teacher") {
    employee <- c("Plan covers teachers")
  }
  else if (employee == "state and local") {
    employee <- c("Plan covers state and local employees")
  }
  else if (employee == "police and fire") {
    employee <- c("Plan covers police and/or fire")
  }
  else if (employee == "state") {
    employee <- c("Plan covers state employees")
  }
  else if (employee == "local") {
    employee <- c("Plan covers local employees")
  }
  else if (employee == "state, local, and teachers") {
    employee <- c("Plan covers state, local and teachers")
  }
  if (is_null(employee)) {
    Data <- data.frame(Data)
  }
  else {
    Data %>% filter(type_of_employees_covered == paste(employee))
  }
}

###
##Pull PERSI data
##Load list of plans
pl <- planList()

#PULL DATA
Data <- pullStateData(2001)
Data <- filterData2(Data,2001)
Data <- Data %>% filter(year == 2021)

#View(Data)
Data <- Data %>% filter(plan_name == "South Carolina Retirement Systems")
#View(Data)
plan.name <- c("SCRS")

Data$year <- as.numeric(Data$year)
Data$mva <- as.numeric(Data$mva)
Data$aal <- as.numeric(Data$aal)
Data$unfunded_actuarially_accrued_liabilities_dollar <- as.numeric(Data$unfunded_actuarially_accrued_liabilities_dollar)

#####
Data$ual <- Data$aal - Data$mva
Data$funded_ratio <- Data$mva/Data$aal

Data$npl_pct_up <- 16067117000
sensitivity <- Data %>% select(npl_pct_up, npl,npl_pct_down, mva) %>% mutate_all(as.numeric)
Data <- Data %>% select(year, dr, ual,funded_ratio,aal,mva,total_nc_pct,ee_nc_pct) %>% mutate_all(as.numeric)

### Rediscount function
reDiscount <- function(data, sensitivity){
  
  sens <- sensitivity %>% mutate_all(as.numeric)
  sens$aal <- as.numeric(data$aal)
  sens$total_nc_pct <- as.numeric(data$total_nc_pct)
  sens <- sens %>% mutate(tpl_pct_down = npl_pct_down+mva,
                          tpl_pct_up = npl_pct_up+mva,
                          tpl = npl + mva,
                          aal.duration = ((tpl_pct_down/tpl_pct_up)^(0.5)-1)*100,
                          aal.convexity = ((tpl_pct_down*tpl_pct_up)/(tpl^2)-1)*100,
                          aal.dr1 = aal*((1+aal.duration/100))^(1)*((1+aal.convexity/100))^((1)^2/2),
                          aal.dr2 = aal*((1+aal.duration/100))^(2)*((1+aal.convexity/100))^((2)^2/2),
                          aal.dr3 = aal*((1+aal.duration/100))^(3)*((1+aal.convexity/100))^((3)^2/2),
                          nc.dr1 = total_nc_pct*(1+aal.duration*2/100)^(1),
                          nc.dr2 = total_nc_pct*(1+aal.duration*2/100)^(2),
                          nc.dr3 = total_nc_pct*(1+aal.duration*2/100)^(3))
  sens
}

redisc <- reDiscount(Data, sensitivity)
#Create table skeleton
table <- matrix(NA,4,4)

#Use database numbers to populate/calculate needed values
table[1:4,1] <- c(seq(as.numeric(Data$dr),0.04, by = -0.01))
table[1:4,4] <- c(redisc$aal, redisc$aal.dr1,redisc$aal.dr2,redisc$aal.dr3)
table[1:4,3] <- c(as.numeric(table[1:4,4])-Data$mva)
table[1:4,2] <- c(as.numeric(Data$mva)/as.numeric(table[1:4,4]))
table <- data.frame(table)


colnames(table) <- c("Discount Rate", 
                  "Funded Ratio (MVA)", 
                  "Unfunded Liability (MVA)", 
                  "Actuarial Accrued Liability")

#Format data to %/$ for appearance
table[1:4,1] <- scales::percent(table$`Discount Rate`, accuracy = 0.1)
table[1:4,2] <- scales::percent(table$`Funded Ratio (MVA)`, accuracy = 0.1)
table[1:4,3] <- scales::dollar(round(table$`Unfunded Liability (MVA)`/1000000000,1))
table[1:4,4] <- scales::dollar(round(table$`Actuarial Accrued Liability`/1000000000,1))



#View(table)
#Knit the table
#knitr::kable(
#  table, caption = 'Pension Integrity Project pension database.'
#)

library(flextable)
library(officer)

#https://davidgohel.github.io/flextable/reference/index.html


table <-  table[1:4,1:4] %>% 
  tibble::rownames_to_column() %>% 
  select(-"rowname") %>%
  flextable() %>%
  set_header_labels(rowname = "")

#table <- add_header_row(table, values = "FY2023 Contributions", colwidths = 3)

#Modify table style using "flextable"      
 table <- table %>%
  #theme_zebra() %>% 
    autofit() %>% 
    border_inner_h() %>% 
    border_outer() %>%
    border_inner_v() %>%
    border_inner_v(part = "header") %>%
    font(fontname = "Arial", part = "all") %>%
    align(part = "all", align = "center") %>%
    align(j = 3:4, align = "right") %>%
    italic(j = 3:4, italic = TRUE, part = "body") %>%
    bold(part = "all", bold = 4) %>%
    color(color = "black") %>%
    color(color = "white", part = "header") %>%
    bg(bg = c("#919daa","#d3d8dd","#919daa","#d3d8dd"), part = "body") %>%
    bg(bg = c("#101010"), part = "header")

 ## Set boder style
 head_border = fp_border(color= palette_reason$Orange, width = 2)
 inner_border = fp_border(color= "white", width = 1)
 
 ##Add border style to table

 table <- border_inner(table, part="all", border = inner_border )
 table <- border_outer(table, part="all", border = inner_border )
 table <- hline_bottom(table, part="header", border = head_border )
 table <-  fontsize(table, size = 18, part = "all")
 table <- width(table, j = 1:4, width = 2)
 
table
```

### Debt Interest vs. Unfunded Liability Payments (2001-2021) w/ R (w/ barPlot())

```{r net.amo, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial valuation reports.", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

barPlot <- function (data = NULL, net.amo = FALSE, contributions = FALSE, 
  compound.gl = TRUE, gl.url = "https://raw.githubusercontent.com/ReasonFoundation/GraphicsR/master/PERSI_GL2.csv", 
  str = 25, stochastic = FALSE, stochastic.url = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/perctest2.csv", 
  stochastic.alpha = 0.4, Ymax = 25, Ymin = 0, Ybreak = 5, 
  yaxisScale = 1/1e+09, interactive = FALSE, font = "Calibri", 
  lab1 = "Investment Experience", lab2 = "Benefit Changes", 
  lab3 = "Changes to Actuarial Methods & Assumptions", lab4 = "Deviations from Demographic Assumptions", 
  lab5 = "Negative Amortization", lab6 = "Gains From Pay Increases Not Given", 
  lab7 = "Net Change to Unfunded Liability", lab8 = NULL, 
  lab9 = NULL) 
{
  if (!is.null(data)) {
    reason.data <- data
  }
  plotTheme <- ggplot2::theme(panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
    plot.margin = margin(0.5, 0.5, 0, 0, "cm"), axis.text.y = element_text(size = 12, 
      color = "black"), axis.text.x = element_text(size = 12, 
      color = "black", angle = 0, hjust = 0.5, vjust = -1), 
      legend.spacing.x = unit(0.1, 'cm'),
    axis.title = element_text(size = 12, face = "bold"), 
    legend.text = element_text(size = 12,margin = margin(t = 1)), legend.title = element_blank(), 
    text = element_text(family = "Calibri"))
  
  if (isTRUE(net.amo)) {
    if (is_null(reason.data$interest_on_debt_dollar)) {
      reason.data$interest_on_debt_dollar <- 0
      n <- length(reason.data$interest_on_debt_dollar)
      for (i in (1:n)) {
        reason.data$interest_on_debt_dollar[i] <- (reason.data$unfunded_actuarially_accrued_liabilities_dollar[i] + 
          reason.data$total_nc[i]) * reason.data$investment_return_assumption_for_gasb_reporting[i] - 
          (reason.data$total_contribution_dollar[i] * 
            reason.data$investment_return_assumption_for_gasb_reporting[i]) * 
            0.5
      }
    }
    reason.data$total_amortization_payment_percentage <- as.numeric(reason.data$total_amortization_payment_percentage)
    reason.data$payroll2 <- as.numeric(reason.data$payroll2)
    reason.data$interest_on_debt_dollar <- as.numeric(reason.data$interest_on_debt_dollar)
    reason.data$net.amo <- 0
    reason.data$amo.payments <- 0
    reason.data$amo.payments <- if (sum(!is.na(reason.data$amortization_payment_total_amount) != 0)) {
      reason.data$amortization_payment_total_amount
    }
    else {
      reason.data$total_amortization_payment_percentage * 
        reason.data$payroll2
    }
    
    
    reason.data$net.amo <- -(reason.data$amo.payments+
      reason.data$interest_on_debt_dollar)
    

    reason.data <- data.table(reason.data %>% select(year, 
      interest_on_debt_dollar, amo.payments, net.amo))
    # reason.data$over <- ifelse(reason.data$net.amo > 0, 
    #   reason.data$net.amo, NA)
    # reason.data$net.amo <- ifelse(reason.data$net.amo < 
    #   0, reason.data$net.amo, NA)
    reason.data$amo.payments <- -(reason.data$amo.payments)
    reason.data <- data.table(reason.data)

    colnames(reason.data) <- c("year", "Interest Accrued on Unfunded Liabilities", 
      "Contributions Towards Unfunded Liabilities", "Net Amortization: Contributions Above/Below Interest on Unfunded Liabilities")
    
    reason.data <- melt(reason.data, vars = "Net Amortization: Contributions Above/Below Interest on Unfunded Liabilities")
    
    reason.data <- data.frame(reason.data[22:84, ])

    x <- data.table(seq(2001, 2021, by = 1))
    x <- rbind(x, x, x)
    reason.data <- cbind(x, reason.data)
    reason.data <- data.frame(reason.data)
    graph <- ggplot(reason.data, aes(x = V1, y = value, 
      fill = variable)) + geom_bar(stat = "identity", 
      position = position_dodge(width = 0.9), width = 0.8) + 
      theme(panel.grid.major.y = element_line(colour = "white", 
        size = 3)) + scale_y_continuous(labels = function(x) paste0("$", 
      x/yaxisScale), name = if (isTRUE(net.amo)) {
      "Unfunded Liability Payments (in $Millions)"
    }
    else {
      "Employer Contributions v. ADC (in $Millions)"
    }, breaks = seq(Ymin, Ymax, by = Ybreak), limits = c(Ymin, 
      Ymax), expand = c(0, 0)) + ggplot2::geom_hline(yintercept = 0, 
      color = "black") + scale_fill_manual(values = c(palette_reason$SatBlue, 
      palette_reason$Orange, palette_reason$LightBlue, palette_reason$Green)) + 
      ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
        color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
      color = "black")) + scale_x_continuous(labels = function(x) paste0(x, 
      ""), name = "", breaks = seq(2001, 2022, by = 2), 
      limits = c(2001, 2022), expand = c(0, 0)) + theme_bw() + theme(axis.line = element_line(), panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(), panel.border = element_blank(), 
      panel.background = element_blank()) + theme(legend.position = c(0.45, 
      0.9)) + plotTheme 
  }
  else if (isTRUE(contributions)) {
    reason.data <- reason.data %>% select(year, actuarially_required_contribution_dollar, 
      actuarially_required_contribution_paid_percentage, 
      employer_contribution_regular_dollar)
    reason.data <- reason.data %>% transmute(year = year, 
      adec = actuarially_required_contribution_dollar, 
      adec_paid = actuarially_required_contribution_dollar * 
        actuarially_required_contribution_paid_percentage, 
      adec_unpaid = actuarially_required_contribution_dollar - 
        (actuarially_required_contribution_dollar * 
          actuarially_required_contribution_paid_percentage))
    reason.data <- data.frame(reason.data)
    graph <- ggplot(reason.data) + 
      
      geom_col(aes(x = year, 
      y = adec, fill = "Contributions Not Made"), position = "stack", width = 0.5) + 
      
      geom_col(aes(x = year, y = ifelse((adec_paid > adec), 
        adec_paid, 0), fill = "Excess Contributions"), 
        position = "stack", width = 0.5) + 
      
      geom_col(aes(x = year, 
      y = ifelse((adec_paid <= adec), adec_paid, adec), 
      fill = "Actual Contributions"), position = "stack", width = 0.5) + 
      
      geom_line(aes(x = year, y = adec, color = "Actuarially Determined Contribution"), 
        fill = palette_reason$Yellow, size = 1) + theme(panel.grid.major.y = element_line(colour = "white", 
      size = 3)) + scale_y_continuous(labels = function(x) paste0("$", 
      x/yaxisScale), name = if (isTRUE(net.amo)) {
      "Unfunded Liability Payments (in $Millions)"
    }
    else {
      "Employer Contributions v. ADC (in $Millions)"
    }, breaks = seq(Ymin, Ymax, by = Ybreak), limits = c(Ymin, 
      Ymax), expand = c(0, 0)) + scale_fill_manual(values = c(palette_reason$SpaceGrey, 
      palette_reason$Red, palette_reason$Green, palette_reason$Yellow)) + 
      scale_color_manual(values = c(palette_reason$Yellow)) + 
      ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
        color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
      color = "black")) + scale_x_continuous(labels = function(x) paste0(x, 
      ""), name = "", breaks = seq(2001, 2020, by = 2), 
      limits = c(2000, 2021), expand = c(0, 0)) + theme_bw() + theme(axis.line = element_line(), panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(), panel.border = element_blank(), 
      panel.background = element_blank()) + theme(legend.position = c(0.25, 
      0.8))+ plotTheme 
  }
  else if (isTRUE(stochastic)) {
    data_perc <- read_csv(url(stochastic.url), col_names = TRUE, 
      na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    data_perc <- data.frame(data_perc)
    data_perc <- as.numeric(data_perc)
    data_perc[, 2:4] <- data_perc[, 2:4] * 100
    data_perc <- data.frame(data_perc)
    graph <- ggplot(data_perc, aes(x = year, y = `25`)) + 
      geom_col(aes(x = year, y = `75`, fill = "Range of Reasonable Outcomes"), 
        alpha = stochastic.alpha) + 
      geom_col(aes(x = year, y = `25`), fill = "white") + 
      geom_line(aes(x = year, y = `50`, color = "Median"), size = 2) + 
      scale_fill_manual(values = c(palette_reason$DarkBlue, "white", palette_reason$Orange)) + 
      theme(panel.grid.major.y = element_line(colour = "white", 
      size = 3)) + scale_y_continuous(labels = function(x) paste0(x, 
      "%"), breaks = seq(Ymin, Ymax, by = Ybreak), limits = c(Ymin, 
      Ymax), name = "Employer Contribution, ADC Basis (% of Payroll)", 
      expand = c(0, 0)) + scale_color_manual(values = c(palette_reason$Orange)) + 
      ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
        color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
      color = "black")) + scale_x_continuous(labels = function(x) paste0(x, 
      ""), name = "", breaks = seq(2020, 2051, by = 2), 
      limits = c(2020, 2051), expand = c(0, 0)) + theme_bw() +
      theme(axis.line = element_line(), panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(), panel.border = element_blank(), 
      panel.background = element_blank()) + theme(legend.position = c(0.25, 
      0.8))+ plotTheme 
  }
  else if (isTRUE(compound.gl)) {
    urlfile = gl.url
    data <- read_csv(url(urlfile), col_names = TRUE, na = c(""), 
      skip_empty_rows = TRUE, col_types = NULL)
    data <- as.data.table(data)
    data <- data %>% replace(is.na(.), 0)
    data <- data.frame(data)
    data2 <- data.frame(data)
    for (i in (2:(length(data[, 1])))) {
      data2[i, 2:length(data)] <- data2[i, 2:length(data)] + 
        data2[(i - 1), 2:length(data)]
    }
    data2 <- data.table(data2 %>% mutate_all(as.numeric))
    reason.data <- data.frame(data2)
    colnames(reason.data) <- c("year", lab1, lab2, lab3, 
      lab4, lab5, lab6, if (!is_null(lab7)) {
        paste(lab7)
      }, if (!is_null(lab8)) {
        paste(lab8)
      }, if (!is_null(lab9)) {
        paste(lab9)
      })
    names <- colnames(reason.data)
    graph <- ggplot(reason.data) + geom_col(aes(x = year, 
      y = reason.data[, 2] * yaxisScale, fill = str_wrap(as.character(names[2]), 
        str)), position = "stack") + geom_col(aes(x = year, 
      y = reason.data[, 3] * yaxisScale, fill = str_wrap(as.character(names[3]), 
        str)), position = "stack") + geom_col(aes(x = year, 
      y = reason.data[, 4] * yaxisScale, fill = str_wrap(as.character(names[4]), 
        str)), position = "stack") + geom_col(aes(x = year, 
      y = reason.data[, 5] * yaxisScale, fill = str_wrap(as.character(names[5]), 
        str)), position = "stack") + geom_col(aes(x = year, 
      y = reason.data[, 6] * yaxisScale, fill = str_wrap(as.character(names[6]), 
        str)), position = "stack") + geom_line(aes(x = year, 
      y = reason.data[, length(names)] * yaxisScale, color = str_wrap(paste(last(names)), 
        str)), size = 1.25) + ggplot2::geom_hline(yintercept = 0, 
      color = "black") + scale_fill_manual(values = c(palette_reason$LightRed, 
      palette_reason$Orange, palette_reason$LightOrange, 
      palette_reason$Green, palette_reason$Red, palette_reason$Yellow, 
      palette_reason$SatBlue)) + scale_color_manual(values = c("black")) + 
      theme_bw() + theme(axis.line = element_line(), 
      panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
      panel.border = element_blank(), panel.background = element_blank()) + 
      theme(legend.position = "right") + theme(legend.title = element_blank()) + 
      labs(x = element_blank(), y = "Compound Unfunded Actuarial Liability (in $ Billions)") + 
      ggplot2::scale_x_continuous(breaks = seq(min(reason.data$year), 
        max(reason.data$year), by = 2), expand = c(0, 
        0)) + ggplot2::scale_y_continuous(labels = function(x) paste0("$", 
      x), breaks = seq(Ymin, Ymax, by = Ybreak), limits = c(Ymin, 
      Ymax), expand = c(0, 0)) + if (!is.null(lab7)) {
      geom_col(aes(x = year, y = reason.data[, 7] * yaxisScale, 
        fill = str_wrap(as.character(names[7]), str)), 
        position = "stack") + plotTheme
    }
    else if (!is.null(lab7) & !is.null(lab8)) {
      geom_col(aes(x = year, y = reason.data[, 7] * yaxisScale, 
        fill = str_wrap(as.character(names[7]), str)), 
        position = "stack") + geom_col(aes(x = year, 
        y = reason.data[, 8] * yaxisScale, fill = str_wrap(as.character(names[8]), 
          str)), position = "stack")
    }
    else if (!is.null(lab7) & !is.null(lab8) & !is.null(lab9)) {
      geom_col(aes(x = year, y = reason.data[, 7] * yaxisScale, 
        fill = str_wrap(as.character(names[7]), str)), 
        position = "stack") + geom_col(aes(x = year, 
        y = reason.data[, 8] * yaxisScale, fill = str_wrap(as.character(names[8]), 
          str)), position = "stack") + geom_col(aes(x = year, 
        y = reason.data[, 9] * yaxisScale, fill = str_wrap(as.character(names[9]), 
          str)), position = "stack")
    }
  }
  if (isTRUE((interactive))) {
    graph <- ggplotly(graph)
  }
  graph
}
###Load/install packages

#To install `reasontheme` & `pensionviewr` packages you first want to load `devtools`
#install.packages('devtools')
#library(devtools)

#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
library(reasontheme)
library(pensionviewr)
#library(janitor)
library(grid)
library(tidyverse)
#library(openxlsx)
library(tseries)
library(plyr)
#library(ggplot2)
library(data.table)
library(openxlsx)
#library(readr)
library(rsconnect)
library(base64enc)
#Shiny
library(shiny)
library(shinyWidgets)
#library(shinyFiles)
library(DT)
library(plotly)
library(rlang)
library(purrr)
library(rpart)
library(vip)

#View(pl <- planList())
#x <- pullStateData(2001)
#view <- masterView("Reason", TRUE)
#View(view)

##1. See what G/L columns consistently have data/most data
#Pull, but not use, "actuarial_experience_dollar" (aggregated)
##2. If Interest_on_Debt is not available? Calculate?
##3. If "amortization_payment_total_amount"is not available? Calculate?
##4. Do Excel G/L matches Database results & UAL change?

####
#Some columns are not filled (especially demographic (e.g. mortality, new entrants, disability, payroll))
#Look into the Code aggregating Survival, Mortality, Survival, Disability data for actives, retired, inactives, total
#Compare Net Change to UAL vs. Actual UAL change for 5-10 plans

#Pull plan-specific data from the database
pl <- planList()
reason.data <- pullData(pl, "South Carolina Retirement Systems") %>% filter(year > 2000 & !duplicated(year))
#View(reason.data)
#(2002-2020)

#reason.data <- pullData(pl, "Louisiana State Employees Retirement System")# (2002-2019)
#reason.data <- pullData(pl, "New Mexico Public Employees Retirement Association")# (2002-2019)
#reason.data <- pullData(pl, "Teachers’ Retirement System of Louisiana")# (2002-2019)
#reason.data <- pullData(pl, "Arizona Public Safety Personnel Retirement System") (2002-2019)
#reason.data <- pullData(pl, "Georgia Teachers Retirement System")# (2002-2018)

#### Create a list of all Gain/Loss columns we have ####

reason.data <- data.table(reason.data)
#reason.data <- reason.data[,lapply(.SD,function(x){ifelse(is.na(x),0,x)})]
#View(reason.data)
## Make sure all column numbers are numeric
reason.data[,4:(length(reason.data)-1)] <- data.table(reason.data[,4:(length(reason.data)-1)]) %>% dplyr::mutate_all(as.numeric)
reason.data$year <- as.numeric(reason.data$year)
reason.data$contribution_rate_effective_fy[1:3] <- 2003:2005
reason.data$fiscal_year_of_contribution <- reason.data$contribution_rate_effective_fy

#### Add Net Amortization ####
#(Interest on Debt + Amortization Payments)
#Code alternative way>> 
#Amo. contribution % * Future Payroll
# View(reason.data$interest_on_debt_dollar)
# View(reason.data$amortization_payment_total_amount)

####### Estimate Future Payroll
future.payroll <- reason.data[year >= fiscal_year_of_contribution[1]]$covered_payroll_dollar
future.payroll <- t(cbind(t(future.payroll),reason.data[year == 2020]$covered_payroll_dollar*(1+0.03)))#Use assumed payroll growth rate
future.payroll <- t(cbind(t(future.payroll),reason.data[year == 2021]$covered_payroll_dollar*(1+0.03)))#Use assumed payroll growth rate
reason.data$payroll2 <- future.payroll

### Calculating Total Normal Cost $ amount
reason.data$total_nc <-
reason.data$total_normal_cost_percentage * reason.data$covered_payroll_dollar

reason.data <- reason.data %>% replace(is.na(.), 0)

### Net Amo
net.amo <- barPlot(
  data = reason.data, 
  net.amo = TRUE, 
  contributions = FALSE, 
  compound.gl = FALSE,
  gl.url = "https://raw.githubusercontent.com/ReasonFoundation/GraphicsR/master/PERSI_GL2.csv",
  str = 25,
  stochastic = FALSE, 
  stochastic.url = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/perctest2.csv",
  Ymax = 2000000000,
  Ymin = -500000000,
  Ybreak = 250000000,
  yaxisScale = 1000000, 
  interactive = FALSE,
  lab1 = "Investment Experience", 
  lab2 = "Benefit Changes",
  lab3 = "Changes to Actuarial Methods & Assumptions",
  lab4 = "Deviations from Demographic Assumptions",
  lab5 = "Negative Amortization",
  lab6 = "Gains From Pay Increases Not Given",
  lab7 = "Net Change to Unfunded Liability",
  lab8 = NULL,
  lab9 = NULL)

net.amo

### ADEC
#barPlot(reason.data, net.amo = FALSE, contributions = TRUE, yaxisScale = 1000000)
#ggsave(filesave)
```

### ADEC Contribution History (2001-2021) w/ R (barPlot())

```{r contributions, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial valuation reports.", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

barPlot <- function (data = NULL, net.amo = FALSE, contributions = FALSE, 
  compound.gl = TRUE, gl.url = "https://raw.githubusercontent.com/ReasonFoundation/GraphicsR/master/PERSI_GL2.csv", 
  str = 25, stochastic = FALSE, stochastic.url = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/perctest2.csv", 
  stochastic.alpha = 0.4, Ymax = 25, Ymin = 0, Ybreak = 5, 
  yaxisScale = 1/1e+09, interactive = FALSE, font = "Calibri", 
  lab1 = "Investment Experience", lab2 = "Benefit Changes", 
  lab3 = "Changes to Actuarial Methods & Assumptions", lab4 = "Deviations from Demographic Assumptions", 
  lab5 = "Negative Amortization", lab6 = "Gains From Pay Increases Not Given", 
  lab7 = "Net Change to Unfunded Liability", lab8 = NULL, 
  lab9 = NULL) 
{
  if (!is.null(data)) {
    reason.data <- data
  }
  plotTheme <- ggplot2::theme(panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
    plot.margin = margin(0.5, 0.5, 0, 0, "cm"), axis.text.y = element_text(size = 12, 
      color = "black"), axis.text.x = element_text(size = 12, 
      color = "black", angle = 0, hjust = 0.5, vjust = -1), 
      legend.spacing.x = unit(0.1, 'cm'),
    axis.title = element_text(size = 12, face = "bold"), 
    legend.text = element_text(size = 12,margin = margin(t = 1)), legend.title = element_blank(), 
    text = element_text(family = "Calibri"))
  
  if (isTRUE(net.amo)) {
    if (is_null(reason.data$interest_on_debt_dollar)) {
      reason.data$interest_on_debt_dollar <- 0
      n <- length(reason.data$interest_on_debt_dollar)
      for (i in (1:n)) {
        reason.data$interest_on_debt_dollar[i] <- (reason.data$unfunded_actuarially_accrued_liabilities_dollar[i] + 
          reason.data$total_nc[i]) * reason.data$investment_return_assumption_for_gasb_reporting[i] - 
          (reason.data$total_contribution_dollar[i] * 
            reason.data$investment_return_assumption_for_gasb_reporting[i]) * 
            0.5
      }
    }
    reason.data$total_amortization_payment_percentage <- as.numeric(reason.data$total_amortization_payment_percentage)
    reason.data$payroll2 <- as.numeric(reason.data$payroll2)
    reason.data$interest_on_debt_dollar <- as.numeric(reason.data$interest_on_debt_dollar)
    reason.data$net.amo <- 0
    reason.data$amo.payments <- 0
    reason.data$amo.payments <- if (sum(!is.na(reason.data$amortization_payment_total_amount) != 0)) {
      reason.data$amortization_payment_total_amount
    }
    else {
      reason.data$total_amortization_payment_percentage * 
        reason.data$payroll2
    }
    reason.data$net.amo <- as.numeric(reason.data$amo.payments - 
      reason.data$interest_on_debt_dollar)
    reason.data <- data.table(reason.data %>% select(year, 
      interest_on_debt_dollar, amo.payments, net.amo))
    # reason.data$over <- ifelse(reason.data$net.amo > 0, 
    #   reason.data$net.amo, NA)
    # reason.data$net.amo <- ifelse(reason.data$net.amo < 
    #   0, reason.data$net.amo, NA)
    reason.data <- data.table(reason.data)
    colnames(reason.data) <- c("year", "Interest Accrued on Unfunded Liabilities", 
      "Unfunded Liability Payments", "Net Amo.")
    reason.data <- melt(reason.data, vars = "net.amo")
    reason.data <- data.frame(reason.data[21:100, ])
    x <- data.table(seq(2001, 2020, by = 1))
    x <- rbind(x, x, x)
    reason.data <- cbind(x, reason.data)
    reason.data <- data.frame(reason.data)
    graph <- ggplot(reason.data, aes(x = V1, y = value, 
      fill = variable)) + geom_bar(stat = "identity", 
      position = position_dodge(width = 0.9), width = 0.8) + 
      theme(panel.grid.major.y = element_line(colour = "white", 
        size = 3)) + scale_y_continuous(labels = function(x) paste0("$", 
      x/yaxisScale), name = if (isTRUE(net.amo)) {
      "Unfunded Liability Payments (in $Millions)"
    }
    else {
      "Employer Contributions v. ADC (in $Millions)"
    }, breaks = seq(Ymin, Ymax, by = Ybreak), limits = c(Ymin, 
      Ymax), expand = c(0, 0)) + ggplot2::geom_hline(yintercept = 0, 
      color = "black") + scale_fill_manual(values = c(palette_reason$SatBlue, 
      palette_reason$SpaceGrey, palette_reason$Red, palette_reason$Green)) + 
      ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
        color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
      color = "black")) + scale_x_continuous(labels = function(x) paste0(x, 
      ""), name = "", breaks = seq(2001, 2021, by = 2), 
      limits = c(2001, 2021), expand = c(0, 0)) + theme_bw() + theme(axis.line = element_line(), panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(), panel.border = element_blank(), 
      panel.background = element_blank()) + theme(legend.position = c(0.25, 
      0.8)) + plotTheme 
  }
  else if (isTRUE(contributions)) {
   
    reason.data <- Data %>% transmute(year = year, 
      adec = arc_adec_dollar, 
      adec_paid = statutory,
      adec_unpaid = (adec - adec_paid))

 
reason.data[1:3,3:4] <-  reason.data[1:3,2]
 
    reason.data <- data.frame(reason.data)
   
    
    graph <- ggplot(reason.data) + 
      
      geom_col(aes(x = year, 
      y = adec, fill = "Contributions Not Made"), position = "stack", width = 0.5) + 
      
      geom_col(aes(x = year, y = ifelse((adec_paid > adec), 
        adec_paid, 0), fill = "Excess Contributions"), 
        position = "stack", width = 0.5) + 
      
      geom_col(aes(x = year, 
      y = ifelse((adec_paid <= adec), adec_paid, adec), 
      fill = "Actual Contributions"), position = "stack", width = 0.5) + 
      
      geom_line(aes(x = year, y = adec, color = "Actuarially Determined Contribution"), 
        fill = palette_reason$Yellow, size = 1) + theme(panel.grid.major.y = element_line(colour = "white", 
      size = 3)) + scale_y_continuous(labels = function(x) paste0("$", 
      x/yaxisScale), name = if (isTRUE(net.amo)) {
      "Unfunded Liability Payments (in $Millions)"
    }
    else {
      "Employer Contributions v. ADC (in $Millions)"
    }, breaks = seq(Ymin, Ymax, by = Ybreak), limits = c(Ymin, 
      Ymax), expand = c(0, 0)) + scale_fill_manual(values = c(palette_reason$SpaceGrey, 
      palette_reason$Red, palette_reason$Green, palette_reason$Yellow)) + 
      scale_color_manual(values = c(palette_reason$Yellow)) + 
      ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
        color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
      color = "black")) + scale_x_continuous(labels = function(x) paste0(x, 
      ""), name = "", breaks = seq(2001, 2022, by = 2), 
      limits = c(2000, 2022), expand = c(0, 0)) + theme_bw() + theme(axis.line = element_line(), panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(), panel.border = element_blank(), 
      panel.background = element_blank()) + theme(legend.position = c(0.25, 
      0.8))+ plotTheme 
  }
  else if (isTRUE(stochastic)) {
    data_perc <- read_csv(url(stochastic.url), col_names = TRUE, 
      na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    data_perc <- data.frame(data_perc)
    data_perc[, c(1:8)] <- sapply(data_perc[, c(1:8)], as.numeric)
    data_perc[, 2:8] <- data_perc[, 2:8] * 100
    data_perc <- data.frame(data_perc)
    graph <- ggplot(data_perc, aes(x = year, y = X25perc)) + 
      geom_col(aes(x = year, y = X75perc, fill = "Range of Reasonable Outcomes"), 
        alpha = stochastic.alpha) + 
      geom_col(aes(x = year, y = X25perc), fill = "white") + 
      geom_line(aes(x = year, y = X50perc, color = "Median"), size = 2) + 
      scale_fill_manual(values = c(palette_reason$DarkBlue, "white", palette_reason$Orange)) + 
      theme(panel.grid.major.y = element_line(colour = "white", 
      size = 3)) + scale_y_continuous(labels = function(x) paste0(x, 
      "%"), breaks = seq(Ymin, Ymax, by = Ybreak), limits = c(Ymin, 
      Ymax), name = "Employer Contribution, ADC Basis (% of Payroll)", 
      expand = c(0, 0)) + scale_color_manual(values = c(palette_reason$Orange)) + 
      ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
        color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
      color = "black")) + scale_x_continuous(labels = function(x) paste0(x, 
      ""), name = "", breaks = seq(2020, 2051, by = 2), 
      limits = c(2020, 2051), expand = c(0, 0)) + theme_bw() +
      theme(axis.line = element_line(), panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(), panel.border = element_blank(), 
      panel.background = element_blank()) + theme(legend.position = c(0.25, 
      0.8))+ plotTheme 
  }
  else if (isTRUE(compound.gl)) {
    urlfile = gl.url
    data <- read_csv(url(urlfile), col_names = TRUE, na = c(""), 
      skip_empty_rows = TRUE, col_types = NULL)
    data <- as.data.table(data)
    data <- data %>% replace(is.na(.), 0)
    data <- data.frame(data)
    data2 <- data.frame(data)
    for (i in (2:(length(data[, 1])))) {
      data2[i, 2:length(data)] <- data2[i, 2:length(data)] + 
        data2[(i - 1), 2:length(data)]
    }
    data2 <- data.table(data2 %>% mutate_all(as.numeric))
    reason.data <- data.frame(data2)
    colnames(reason.data) <- c("year", lab1, lab2, lab3, 
      lab4, lab5, lab6, if (!is_null(lab7)) {
        paste(lab7)
      }, if (!is_null(lab8)) {
        paste(lab8)
      }, if (!is_null(lab9)) {
        paste(lab9)
      })
    names <- colnames(reason.data)
    graph <- ggplot(reason.data) + geom_col(aes(x = year, 
      y = reason.data[, 2] * yaxisScale, fill = str_wrap(as.character(names[2]), 
        str)), position = "stack") + geom_col(aes(x = year, 
      y = reason.data[, 3] * yaxisScale, fill = str_wrap(as.character(names[3]), 
        str)), position = "stack") + geom_col(aes(x = year, 
      y = reason.data[, 4] * yaxisScale, fill = str_wrap(as.character(names[4]), 
        str)), position = "stack") + geom_col(aes(x = year, 
      y = reason.data[, 5] * yaxisScale, fill = str_wrap(as.character(names[5]), 
        str)), position = "stack") + geom_col(aes(x = year, 
      y = reason.data[, 6] * yaxisScale, fill = str_wrap(as.character(names[6]), 
        str)), position = "stack") + geom_line(aes(x = year, 
      y = reason.data[, length(names)] * yaxisScale, color = str_wrap(paste(last(names)), 
        str)), size = 1.25) + ggplot2::geom_hline(yintercept = 0, 
      color = "black") + scale_fill_manual(values = c(palette_reason$LightRed, 
      palette_reason$Orange, palette_reason$LightOrange, 
      palette_reason$Green, palette_reason$Red, palette_reason$Yellow, 
      palette_reason$SatBlue)) + scale_color_manual(values = c("black")) + 
      theme_bw() + theme(axis.line = element_line(), 
      panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
      panel.border = element_blank(), panel.background = element_blank()) + 
      theme(legend.position = "right") + theme(legend.title = element_blank()) + 
      labs(x = element_blank(), y = "Compound Unfunded Actuarial Liability (in $ Billions)") + 
      ggplot2::scale_x_continuous(breaks = seq(min(reason.data$year), 
        max(reason.data$year), by = 2), expand = c(0, 
        0)) + ggplot2::scale_y_continuous(labels = function(x) paste0("$", 
      x), breaks = seq(Ymin, Ymax, by = Ybreak), limits = c(Ymin, 
      Ymax), expand = c(0, 0)) + if (!is.null(lab7)) {
      geom_col(aes(x = year, y = reason.data[, 7] * yaxisScale, 
        fill = str_wrap(as.character(names[7]), str)), 
        position = "stack") + plotTheme
    }
    else if (!is.null(lab7) & !is.null(lab8)) {
      geom_col(aes(x = year, y = reason.data[, 7] * yaxisScale, 
        fill = str_wrap(as.character(names[7]), str)), 
        position = "stack") + geom_col(aes(x = year, 
        y = reason.data[, 8] * yaxisScale, fill = str_wrap(as.character(names[8]), 
          str)), position = "stack")
    }
    else if (!is.null(lab7) & !is.null(lab8) & !is.null(lab9)) {
      geom_col(aes(x = year, y = reason.data[, 7] * yaxisScale, 
        fill = str_wrap(as.character(names[7]), str)), 
        position = "stack") + geom_col(aes(x = year, 
        y = reason.data[, 8] * yaxisScale, fill = str_wrap(as.character(names[8]), 
          str)), position = "stack") + geom_col(aes(x = year, 
        y = reason.data[, 9] * yaxisScale, fill = str_wrap(as.character(names[9]), 
          str)), position = "stack")
    }
  }
  if (isTRUE((interactive))) {
    graph <- ggplotly(graph)
  }
  graph
}

#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
library(reasontheme)
library(pensionviewr)
#library(janitor)
library(grid)
library(tidyverse)
#library(openxlsx)
library(tseries)
library(plyr)
#library(ggplot2)
library(data.table)
library(openxlsx)
#library(readr)
library(rsconnect)
library(base64enc)
#Shiny
library(shiny)
library(shinyWidgets)
#library(shinyFiles)
library(DT)
library(plotly)
library(rlang)
library(purrr)
library(rpart)
library(vip)

#View(pl <- planList())
#x <- pullStateData(2001)
#view <- masterView("Reason", TRUE)
#View(view)

##1. See what G/L columns consistently have data/most data
#Pull, but not use, "actuarial_experience_dollar" (aggregated)
##2. If Interest_on_Debt is not available? Calculate?
##3. If "amortization_payment_total_amount"is not available? Calculate?
##4. Do Excel G/L matches Database results & UAL change?

####
#Some columns are not filled (especially demographic (e.g. mortality, new entrants, disability, payroll))
#Look into the Code aggregating Survival, Mortality, Survival, Disability data for actives, retired, inactives, total
#Compare Net Change to UAL vs. Actual UAL change for 5-10 plans

#Pull plan-specific data from the database
pl <- planList()
reason.data <- pullData(pl, "South Carolina Retirement Systems") %>% filter(year > 2000 & !duplicated(year))# (2002-2020)

#reason.data <- pullData(pl, "Louisiana State Employees Retirement System")# (2002-2019)
#reason.data <- pullData(pl, "New Mexico Public Employees Retirement Association")# (2002-2019)
#reason.data <- pullData(pl, "Teachers’ Retirement System of Louisiana")# (2002-2019)
#reason.data <- pullData(pl, "Arizona Public Safety Personnel Retirement System") (2002-2019)
#reason.data <- pullData(pl, "Georgia Teachers Retirement System")# (2002-2018)
#View(reason.data)
#### Create a list of all Gain/Loss columns we have ####



reason.data <- data.table(reason.data)

reason.data <- reason.data %>% select(year, display_name, state, adec1 = actuarially_determined_contribution_dollar,
                          adec2 =   actuarially_required_contribution_paid_dollar,  #actuarially_required_contribution_dollar (PPD)
                          adec_paid_pct = actuarially_required_contribution_paid_percentage,
                          adec_pct = adec_as_a_percent_of_payroll, #instead of employers_projected_actuarial_required_contribution
                          arc_paid_dollar = actuarially_required_contribution_paid_dollar, #NEW
                          adec_paid_dollar = actuarially_determined_contribution_paid_dollar,#NEW
                          statutory = statutory_payment_dollar, statutory_pct = statutory_payment_percentage)

Data <- reason.data
Data$arc_adec_dollar <- ifelse(is.na(Data$adec1) == TRUE,Data$adec2, Data$adec1)
Data$arc_adec_paid_dollar <- ifelse(is.na(Data$arc_paid_dollar) == TRUE, Data$adec_paid_dollar, Data$arc_paid_dollar)

Data <- data.table(Data)
#View(Data)
#reason.data <- reason.data[,lapply(.SD,function(x){ifelse(is.na(x),0,x)})]
#View(reason.data)
## Make sure all column numbers are numeric
#View(Data)
Data[,4:(length(Data)-1)] <- data.table(Data[,4:(length(Data)-1)]) %>% dplyr::mutate_all(as.numeric)
Data$year <- as.numeric(Data$year)

# reason.data$employer_contribution_regular_dollar <- 0
#        reason.data[year > 2000]$employer_contribution_regular_dollar <-
#          PPD[PlanName == "Oklahoma PERS" & fy > 2000]$contrib_ER_regular

contributions <- barPlot(
  data = Data, 
  net.amo = FALSE, 
  contributions = TRUE, 
  compound.gl = FALSE,
  gl.url = "https://raw.githubusercontent.com/ReasonFoundation/GraphicsR/master/PERSI_GL2.csv",
  str = 25,
  stochastic = FALSE, 
  stochastic.url = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/perctest2.csv",
  Ymax = 2000000000,
  Ymin = 0,
  Ybreak = 200000000,
  yaxisScale = 1000000, 
  interactive = FALSE,
  lab1 = "Investment Experience", 
  lab2 = "Benefit Changes",
  lab3 = "Changes to Actuarial Methods & Assumptions",
  lab4 = "Deviations from Demographic Assumptions",
  lab5 = "Negative Amortization",
  lab6 = "Gains From Pay Increases Not Given",
  lab7 = "Net Change to Unfunded Liability",
  lab8 = NULL,
  lab9 = NULL)

contributions
```

### SCRS Amortization Period (2001-2021) custom R

```{r amo.period, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial valuation reports.", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

rm(list = ls())

###Load/install packages
#R.Version()
#https://github.com/ReasonFoundation/pensionviewr
#Create token -> usethis::edit_r_environ() -> restart -> Sys.getenv("GITHUB_PAT")
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
#devtools::install_github(
#  "ANiraula/pensionviewr_private",
#   ref = "master", auth_token = "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")
library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(plyr)
library(dplyr)

###
##Pull PERSI data
##Load list of plans

pl <- planList()
reason.data <- pullData(pl, "South Carolina Retirement Systems") %>% filter(year > 2000 & !duplicated(year))

Data <- data.frame(
  reason.data %>% select(year, number_of_years_remaining_on_amortization_schedule)
)
	
colnames(Data)[2] <- "amo.period"
Data$amo.period <- as.numeric(Data$amo.period)
Data$year <- as.numeric(Data$year)

########areaPlot


  
  plotTheme <- ggplot2::theme(   panel.grid.major = element_blank(),
                                 panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                 plot.margin = margin(0,0.5,0,0, "cm"),
                                 axis.text.y = element_text(size=12, color = "black"),
                                 axis.text.x = element_text(size=12, color = "black", angle = 0, hjust = 0.5, vjust = -1),
                                 axis.title = element_text(size = 12, face = "bold"),
                                 legend.text = element_text(size = 12),
                                 legend.title = element_blank(),
                                 text = element_text(family = "Calibri"))
  

    data <- as.data.table(Data)
    
  reasontheme::set_reason_theme(style = "slide")
  data <- data.frame(data)
  #annotation <- data.frame(
  # x = c(2004, 2018),
  # y = c(10/yaxisScale, 20/yaxisScale),
  # label = c(paste("FYE 2001:",round(data.table(Data$ava/Data$aal)[1]*100,1),"%"), "2020 FR")
  # )
  
  amo.period <- ggplot2::ggplot(data, ggplot2::aes(x = year)) + 
    ggplot2::geom_line(ggplot2::aes(y = amo.period), color = palette_reason$SatBlue, size = 1, linetype =  "dashed") + 
    ggplot2::scale_y_continuous(breaks = seq(0, 40, by = 4),limits = c(0, 40.5), expand = c(0, 0))+
    ggplot2::theme(axis.ticks.x = element_line(size = 0.5, color = "black")) +
    ggplot2::theme(panel.border = element_blank(), axis.ticks.y = element_line(size = 0.5, color = "black")) + 
    ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 13, face = "bold")) + labs(x = element_blank(), y = "Amortization Period")+
    ggplot2::geom_hline(yintercept = 20,color = "black")+
    ggplot2::scale_x_continuous(breaks = seq(2001, 2021, by = 2), expand = c(0, 0)) + 
    ggplot2::theme(legend.position = "none") + plotTheme 
  # + geom_text(data=annotation, aes(x=x, y=y, label=label),
  #         color="black", 
  #         size=5 , angle=0, fontface="bold" )
####

amo.period

#debt <- areaPlot(Data, title = "", caption = FALSE, grid = F, ticks = F, sp500 = TRUE)
#debt
```

### Change in Risk-Free Rate vs. Discount Rate (2001-2021) w/ R (linePlot())

```{r treasury, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial valuation reports.", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

rm(list=ls())
###Load/install packages
#R.Version()
#https://github.com/ReasonFoundation/pensionviewr
#Create token -> usethis::edit_r_environ() -> restart -> Sys.getenv("GITHUB_PAT")
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(dplyr)
library(plyr)
### linePlot ###
## Data: Database + Manual(AVA returns)
## Base: linePlot() function in `pensionviewr`
# By: Anil, Swaroop, and Jen

##linePlot() function parameters:

#data = data in data.frame, tibble, or data.table format,
#yaxisMin & yaxisMax = Y-axis mininum and maximum values
#yaxisSeq = set sequency of Major breaks
#yaxisScale = 100 for percentages
#format = set Y-axis format to either "%", "$", or empty
#str = set number of srings at which to cut legend text (default is 20),
#labelY = title of Y-axis,
#lab1 - lab5 = character string of line titles/names (default is 0 Lines)

###################
#Using 2 New Functions to download and filter datat from datatabase
Data <- pullStateData(2001)
Data <- filterData(Data, 2001)

pl <- planList()
#filter for PERSI
Data<- Data %>% filter (plan_name == "South Carolina Retirement Systems")
#View(Data)

Data$year <- as.numeric(Data$year)
Data <- Data %>% select(year, arr)
#Set to data.frame for visualization
Data <- data.frame(Data)
Data$year <- as.numeric(Data$year)
#View(Data)
data <- Data
#####Modified linePlot

linePlot <- function (data, title = NULL, caption = FALSE, grid = FALSE, 
  treasury = FALSE, inv.returns = TRUE, ticks = TRUE, font = NULL, 
  yaxisMin = 0, yaxisMax = NULL, yaxisSeq = 5, yaxisScale = 100, 
  format = NULL, str = 20, labelY = NULL, lab1 = NULL, lab2 = NULL, 
  lab3 = NULL, lab4 = NULL, lab5 = NULL){ 
  
  plotTheme <- ggplot2::theme(   panel.grid.major = element_blank(),
                                 panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                 plot.margin = margin(0, 0.5,0,0, "cm"),
                                 axis.text.y = element_text(size=12, color = "black"),
                                 axis.text.x = element_text(size=12, color = "black", angle = 0, hjust = 0.5, vjust = -1),
                                 axis.title = element_text(size = 12, face = "bold"),
                                 legend.text = element_text(size = 12),
                                 legend.title = element_blank(),
                                 text = element_text(family = "Calibri"))

{
  reasontheme::set_reason_theme(style = "slide")
  x <- length(data$year)
  data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
  if (isTRUE(treasury)) {
    urlfile <- "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/treasury.csv"
    treasury <- read_csv(url(urlfile), col_names = TRUE, 
      na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    treasury$year <- as.numeric(treasury$year)
    treasury <- treasury %>% filter(year>2000 & year < 2022)
    data$year <- as.numeric(data$year)
    treasury <- data.table(treasury %>% filter(year >= min(data$year)))
    data <- data %>% select(year, arr)
    data <- data.table(data)
    data <- cbind(data, treasury[, 2])
    data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
    data <- as.data.table(data)
    data$alt.discount <- NA
    diff <- (data[year == min(data$year)]$arr - data[year == 
      min(data$year)]$X30.treasury)
    data$alt.discount <- data$X30.treasury + diff
    
  }
  geomean <- function(x) {
    x <- as.vector(na.omit(x))
    x <- x + 1
    exp(mean(log(x))) - 1
  }
  if (isTRUE(inv.returns)) {
    data$return_1yr <- as.numeric(data$return_1yr)
    returns <- data$return_1yr
    last <- length(returns)
    rolling <- matrix(NA, last, 1)
    rolling[last] <- as.numeric(geomean(returns[(last - 
      9):last]))
    for (i in 1:(last - 10)) {
      rolling[last - i] <- geomean(returns[(last - 9 - 
        i):(last - i)])
    }
    rolling <- data.table(rolling)
    returns[(last - 9):last]
    returns[(last - 9 + 1):(last - 1)]
    data <- data.table(cbind(data, rolling))
    data <- data %>% select(year, return_1yr, ava_return, 
      arr, V1)
  }
  colnames(data) <- c("year", if (!is_null(lab1)) {
    paste(lab1)
  }, if (!is_null(lab2)) {
    paste(lab2)
  }, if (!is_null(lab3)) {
    paste(lab3)
  }, if (!is_null(lab4)) {
    paste(lab4)
  }, if (!is_null(lab5)) {
    paste(lab5)
  })
  
  data <- as.data.table(data)
  graph <- data.table(melt(data, id.vars = "year"))
  lineColors <- c(
    palette_reason$Orange,
    palette_reason$Yellow,
    palette_reason$SatBlue, 
    palette_reason$LightGrey, 
    palette_reason$LightGreen)
  options(repr.plot.width = 1, repr.plot.height = 0.75)
  ggplot2::ggplot(graph, ggplot2::aes(x = year, y = yaxisScale * 
    value, group = variable)) + ggplot2::geom_line(ggplot2::aes(colour = str_wrap(factor(variable), 
    str)), size = 1.5) + ggplot2::geom_hline(yintercept = 0, 
    color = "black") + ggplot2::scale_colour_manual(values = lineColors) + 
    ggplot2::scale_y_continuous(breaks = seq(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    }
    else {
      max(graph$value) * yaxisScale * 1.2
    }, by = yaxisSeq), limits = c(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    } else {
      max(graph$value) * yaxisScale * 1.2
    }), labels = function(b) {
      if (format == "%") {
        paste0(round(b, 0), "%")
      }
      else if (format == "$") {
        paste0("$", round(b, 0))
      }
      else {
        paste0(format, round(b, 0))
      }
    }, expand = c(0, 0)) + ggplot2::scale_x_continuous(breaks = seq(min(graph$year), 
    max(graph$year), by = 2), expand = c(0, 0)) + labs(x = element_blank(), 
    y = labelY) + theme(legend.text = element_text(size = 12)) + 
    theme(legend.direction = "vertical", legend.box = "horizontal", 
      legend.position = if (isTRUE(treasury)) {
        c(0.1, 1)
      }
      else {
        c(0.32, 0.09)
      }) + labs(title = paste(title), caption = ifelse(isTRUE(caption), 
    paste("reason.org/pensions"), paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) + ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    plotTheme+
    ggplot2::theme(text = element_text(family = if (!is_null(font)) {
      paste(font)
    }
    else {
      paste("Arial")
    }, size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid), 
    paste(palette_reason$SpaceGrey), "white"), size = (1)))
  }
}

treasury <- linePlot(Data, title = NULL, caption = FALSE, grid = FALSE, 
                  treasury = TRUE, inv.returns = FALSE, ticks = TRUE, font = "Calibri",
                  yaxisMin = 0, yaxisMax = 9, yaxisSeq = 1,
                  yaxisScale = 100, format = "%", str = 60,
                  labelY = "Discount Rate or 30-Year Treasury Yield", lab1 = "Actual Discount Rate",
                  lab2 = "30-Year Treasury Bond Yield Rate", 
                  lab3 = "Alternative Discount Rate Scenario", 
                  lab4 = NULL, lab5 = NULL)

treasury
```

### Actual Change in Payroll vs. Assumption (2001-2021) w/ R (linePlot())

```{r payroll, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial valuation reports. Actual payroll does not include payroll for members in ORP or working retirees.", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

pl <- planList()

#PULL DATA

###################
#Using 2 New Functions to download and filter datat from datatabase
Data <- pullStateData(2001)
Data <- filterData(Data, 2001)

pl <- planList()
#filter for PERSI
Data<- Data %>% filter (plan_name == "South Carolina Retirement Systems")

Data$payroll <- as.numeric(Data$payroll)
Data$payroll_growth_assumption <- as.numeric(Data$payroll_growth_assumption)
payroll.growth <- Data$payroll_growth_assumption[1]
Data <- Data %>% select(year, payroll, payroll_growth_assumption)
Data <- data.table(Data) 

Data$payroll_growth_assumption[1] <- Data$payroll[1]
for(i in (2:length(Data$payroll_growth_assumption))){
  Data$payroll_growth_assumption[i] <- Data$payroll_growth_assumption[i-1]*(1+payroll.growth)
  
}
#View(DPF.data)
# UAL4 <- data.table(UAL4[, Tr30 := tr30[(n-UAL4[!is.na(Actual_Return),.N]):last]])
###############
#Adding AVA returns (Arkansas ERS example*)

Data <- data.frame(Data)
#View(Data)

linePlot <- function(data, title = NULL, caption = FALSE, grid = FALSE, 
  treasury = FALSE, inv.returns = TRUE, ticks = TRUE, font = NULL, 
  yaxisMin = 0, yaxisMax = NULL, yaxisSeq = 5, yaxisScale = 100, 
  format = NULL, str = 20, labelY = NULL, lab1 = NULL, lab2 = NULL, 
  lab3 = NULL, lab4 = NULL, lab5 = NULL) 
{
  reasontheme::set_reason_theme(style = "slide")
  
   plotTheme <- ggplot2::theme(   panel.grid.major = element_blank(),
                                 panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                 plot.margin = margin(0, 0.5,0,0, "cm"),
                                 axis.text.y = element_text(size=12, color = "black"),
                                 axis.text.x = element_text(size=12, color = "black", angle = 0, hjust = 0.5, vjust = -1),
                                 axis.title = element_text(size = 12, face = "bold"),
                                 legend.text = element_text(size = 12),
                                 legend.title = element_blank(),
                                 text = element_text(family = "Calibri"))
   
  x <- length(data$year)
  data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
  if (isTRUE(treasury)) {
    urlfile <- "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/treasury.csv"
    treasury <- read_csv(url(urlfile), col_names = TRUE, 
    na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    treasury$year <- as.numeric(treasury$year)
    treasury <- treasury %>% filter(year>2000 & year < 2022)
    data$year <- as.numeric(data$year)
    treasury <- data.table(treasury %>% filter(year > min(data$year - 
      1)))
    data <- data %>% select(year, arr)
    data <- data.table(data)
    data <- cbind(data, treasury[, 2])
    data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
    data <- as.data.table(data)
    data$alt.discount <- NA
    diff <- (data[year == min(data$year)]$arr - data[year == 
      min(data$year)]$X30.treasury)
    data$alt.discount <- data$X30.treasury + diff
  }
  geomean <- function(x) {
    x <- as.vector(na.omit(x))
    x <- x + 1
    exp(mean(log(x))) - 1
  }
  if (isTRUE(inv.returns)) {
    data$return_1yr <- as.numeric(data$return_1yr)
    returns <- data$return_1yr
    last <- length(returns)
    rolling <- matrix(NA, last, 1)
    rolling[last] <- as.numeric(geomean(returns[(last - 
      9):last]))
    for (i in 1:(last - 10)) {
      rolling[last - i] <- geomean(returns[(last - 9 - 
        i):(last - i)])
    }
    rolling <- data.table(rolling)
    returns[(last - 9):last]
    returns[(last - 9 + 1):(last - 1)]
    data <- data.table(cbind(data, rolling))
    data <- data %>% select(year, return_1yr, ava_return, 
      arr, V1)
  }
  colnames(data) <- c("year", if (!is_null(lab1)) {
    paste(lab1)
  }, if (!is_null(lab2)) {
    paste(lab2)
  }, if (!is_null(lab3)) {
    paste(lab3)
  }, if (!is_null(lab4)) {
    paste(lab4)
  }, if (!is_null(lab5)) {
    paste(lab5)
  })
  
  data <- as.data.table(data)
  graph <- data.table(melt(data, id.vars = "year"))
  lineColors <- c(palette_reason$Yellow, palette_reason$SatBlue, 
    palette_reason$SatBlue, palette_reason$LightGrey, palette_reason$LightGreen)
  options(repr.plot.width = 1, repr.plot.height = 0.75)
  ggplot2::ggplot(graph, ggplot2::aes(x = year, y = yaxisScale * 
    value, group = variable)) + ggplot2::geom_line(ggplot2::aes(colour = str_wrap(factor(variable), 
    str)), size = 1.5) + ggplot2::geom_hline(yintercept = 0, 
    color = "black") + ggplot2::scale_colour_manual(values = lineColors) + 
    
    
    ggplot2::scale_y_continuous(breaks = seq(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    }
    else {
      max(graph$value) * yaxisScale * 1.2
    }, by = yaxisSeq), limits = c(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    } else {
      max(graph$value) * yaxisScale * 1.2
    }),  labels = scales::dollar_format(prefix = if (format == "$"){
      "$"
    }
    else {
      ""
    }, scale = 1, largest_with_cents = 1), expand = c(0, 0)) + ggplot2::scale_x_continuous(breaks = seq(min(graph$year), 
    max(graph$year), by = 2), expand = c(0, 0)) + labs(x = element_blank(), 
    y = labelY) + theme(legend.text = element_text(size = 10)) + 
    theme(legend.direction = "vertical", legend.box = "horizontal", 
      legend.position = if (isTRUE(treasury)) {
        c(0.1, 1)
      }
      else {
        c(0.33, 0.09)
      }) + labs(title = paste(title), caption = ifelse(isTRUE(caption), 
    paste("reason.org/pensions"), paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) + ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    ggplot2::theme(text = element_text(family = "Calibri", size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid), 
    paste(palette_reason$SpaceGrey), "white"), size = (1)))+plotTheme
}


payroll <- linePlot(Data, title = NULL, caption = FALSE, grid = FALSE, 
                  treasury = FALSE, inv.returns = FALSE, ticks = TRUE, font = "Calibri",
                  yaxisMin = 0, yaxisMax = 14000, yaxisSeq = 1400,
                  yaxisScale = 1/1000000, format = "$", str = 60,
                  labelY = "Payroll in $Millions", lab1 = "Actual Payroll Growth",
                  lab2 = "Projected Payroll Growth Based on 2001 Assumption")

payroll
```

### Actual Inflation vs. Assumption (2001-2020) w/ R (linePlot())

```{r inflation, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial valuation reports.", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

rm(list=ls())
###Load/install packages
#R.Version()
#https://github.com/ReasonFoundation/pensionviewr
#Create token -> usethis::edit_r_environ() -> restart -> Sys.getenv("GITHUB_PAT")
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(dplyr)
library(plyr)
pl <- planList()

#PULL DATA
###################
#Using 2 New Functions to download and filter datat from datatabase
Data <- pullStateData(2001)
Data <- filterData(Data, 2001)

Data<- Data %>% filter(plan_name == "South Carolina Retirement Systems") %>% filter(!duplicated(year))
Data$year <- as.numeric(Data$year)
Data <- data.frame(Data)

#### Load & Merge CPI data (by region)
library(readxl)
library(httr)
      
      url1 <- "https://github.com/ReasonFoundation/databaseR/raw/master/files/CPI_by_Region_DOL.xlsx"
      GET(url1, write_disk(tf <- tempfile(fileext = ".xlsx")))
      
      cpi <- read_excel(tf, sheet = 1)
      regions <- read_excel(tf, sheet = 2)
      
      cpi <- data.table(cpi)
      regions <- data.table(regions)
      
      #View(cpi)
      #View(regions)
      
      cpi$cpi.change <- NA
      
      for (i in (2:length(cpi$region))){
        
        cpi$cpi.change[i] <- (cpi$cpi[i]/cpi$cpi[i-1])-1 
        
      }
      
      ### Merge State -> Regions
      Data <- Data %>% left_join(regions, by = "state")
      Data <-  Data %>% mutate(region = region.x) %>%
        select(-region.y, -region.x)
        
      ### Merge Regions -> CPI
      
      Data <-  Data %>% left_join(cpi, by = c("year", "region"))
      Data <-  Data %>% select(-cpi)
      #View(Data$region.) 
      #filter for PERSI
      
urlfile="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/ppd-data-latest_Q1_2021.csv"
PPD <- read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
PPD <- setDT(PPD)
#View(colnames(PPD))
#PPD$AdministeringGovt
#Remove Colorado State and Shool plan
#PPD <- PPD[PlanName != "Colorado State and School"]
PPD <- data.table(PPD[AdministeringGovt == 0] %>%
                    select(fy, PlanName, StateName, ActLiabilities_GASB, MktAssets_net,
                           ActFundedRatio_GASB,
                           InvestmentReturnAssumption_GASB, InvestmentReturn_1yr, payroll,
                           PayrollGrowthAssumption, NormCostRate_tot, InflationAssumption_GASB, ReqContRate_tot, PercentReqContPaid,
                           expense_TotBenefits,contrib_ER_regular) %>% arrange(PlanName))




Data$inflation_assum <- 0
Data$inflation_assum[1:20] <-
  PPD[PlanName == "South Carolina RS" & fy >= 2001 & fy < 2021]$InflationAssumption_GASB
Data$inflation_assum[20:21] <- 0.0225

Data$inflation_assum <- as.numeric(Data$inflation_assum)
Data <-  Data %>% mutate(cpi.change = cpi.change.x) %>%
        select(-cpi.change.y, -cpi.change.x)
Data <- Data %>% select(year, inflation_assum, cpi.change)
colnames(Data)[3] <- "payroll_growth_assumption"
Data <- data.table(Data)
#View(data.frame(Data$inflation_assum))

#View(Data)
# UAL4 <- data.table(UAL4[, Tr30 := tr30[(n-UAL4[!is.na(Actual_Return),.N]):last]])
###############
#Adding AVA returns (Arkansas ERS example*)

Data <- data.frame(Data)
#View(data.frame(Data$payroll_growth_assumption))

linePlot <- function (data, title = NULL, caption = FALSE, grid = FALSE, 
  treasury = FALSE, inv.returns = TRUE, ticks = TRUE, font = NULL, 
  yaxisMin = 0, yaxisMax = NULL, yaxisSeq = 5, yaxisScale = 100, 
  format = NULL, str = 20, labelY = NULL, lab1 = NULL, lab2 = NULL, 
  lab3 = NULL, lab4 = NULL, lab5 = NULL) 
{
  reasontheme::set_reason_theme(style = "slide")
  
   plotTheme <- ggplot2::theme(   panel.grid.major = element_blank(),
                                 panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                 plot.margin = margin(0, 0.5,0,0, "cm"),
                                 axis.text.y = element_text(size=12, color = "black"),
                                 axis.text.x = element_text(size=12, color = "black", angle = 0, hjust = 0.5, vjust = -1),
                                 axis.title = element_text(size = 12, face = "bold"),
                                 legend.text = element_text(size = 12),
                                 legend.title = element_blank(),
                                 text = element_text(family = "Calibri"))
   
  x <- length(data$year)
  data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
  if (isTRUE(treasury)) {
    urlfile <- "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/treasury.csv"
    treasury <- read_csv(url(urlfile), col_names = TRUE, 
      na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    treasury$year <- as.numeric(treasury$year)
    treasury <- treasury %>% filter(year>2000 & year < 2020)
    data$year <- as.numeric(data$year)
    treasury <- data.table(treasury %>% filter(year > min(data$year - 
      1)))
    data <- data %>% select(year, arr)
    data <- data.table(data)
    data <- cbind(data, treasury[, 2])
    data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
    data <- as.data.table(data)
    data$alt.discount <- NA
    diff <- (data[year == min(data$year)]$arr - data[year == 
      min(data$year)]$X30.treasury)
    data$alt.discount <- data$X30.treasury + diff
  }
  geomean <- function(x) {
    x <- as.vector(na.omit(x))
    x <- x + 1
    exp(mean(log(x))) - 1
  }
  if (isTRUE(inv.returns)) {
    data$return_1yr <- as.numeric(data$return_1yr)
    returns <- data$return_1yr
    last <- length(returns)
    rolling <- matrix(NA, last, 1)
    rolling[last] <- as.numeric(geomean(returns[(last - 
      9):last]))
    for (i in 1:(last - 10)) {
      rolling[last - i] <- geomean(returns[(last - 9 - 
        i):(last - i)])
    }
    rolling <- data.table(rolling)
    returns[(last - 9):last]
    returns[(last - 9 + 1):(last - 1)]
    data <- data.table(cbind(data, rolling))
    data <- data %>% select(year, return_1yr, ava_return, 
      arr, V1)
  }
  colnames(data) <- c("year", if (!is_null(lab1)) {
    paste(lab1)
  }, if (!is_null(lab2)) {
    paste(lab2)
  }, if (!is_null(lab3)) {
    paste(lab3)
  }, if (!is_null(lab4)) {
    paste(lab4)
  }, if (!is_null(lab5)) {
    paste(lab5)
  })
  
  data <- as.data.table(data)
  graph <- data.table(melt(data, id.vars = "year"))
  lineColors <- c(palette_reason$Yellow, palette_reason$SatBlue, 
    palette_reason$SatBlue, palette_reason$LightGrey, palette_reason$LightGreen)
  options(repr.plot.width = 1, repr.plot.height = 0.75)
  ggplot2::ggplot(graph, ggplot2::aes(x = year, y = yaxisScale * 
    value, group = variable)) + ggplot2::geom_line(ggplot2::aes(colour = str_wrap(factor(variable), 
    str)), size = 1.5) + ggplot2::geom_hline(yintercept = 0, 
    color = "black") + ggplot2::scale_colour_manual(values = lineColors) + 
    ggplot2::scale_y_continuous(breaks = seq(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    }
    else {
      max(graph$value) * yaxisScale * 1.2
    }, by = yaxisSeq), limits = c(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    } else {
      max(graph$value) * yaxisScale * 1.2
    }), labels = function(b) {
      if (format == "%") {
        paste0(round(b, 0), "%")
      }
      else if (format == "$") {
        paste0("$", round(b, 0))
      }
      else {
        paste0(format, round(b, 0))
      }
    }, expand = c(0, 0)) + ggplot2::scale_x_continuous(breaks = seq(min(graph$year), 
    max(graph$year), by = 2), expand = c(0, 0)) + labs(x = element_blank(), 
    y = labelY) + theme(legend.text = element_text(size = 10)) + 
    theme(legend.direction = "vertical", legend.box = "horizontal", 
      legend.position = if (isTRUE(treasury)) {
        c(0.1, 1)
      }
      else {
        c(0.2, 0.09)
      }) + labs(title = paste(title), caption = ifelse(isTRUE(caption), 
    paste("reason.org/pensions"), paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) + ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    ggplot2::theme(text = element_text(family = if (!is_null(font)) {
      paste(font)
    }
    else {
      paste("Arial")
    }, size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid), 
    paste(palette_reason$SpaceGrey), "white"), size = (1))) + plotTheme
}

inflation <- linePlot(Data, title = NULL, caption = FALSE, grid = FALSE, 
                  treasury = FALSE, inv.returns = FALSE, ticks = TRUE, font = "Calibri",
                  yaxisMin = -1, yaxisMax = 6, yaxisSeq = 1,
                  yaxisScale = 100, format = "%", str = 60,
                  labelY = "Inflation %", lab1 = "Assumed Inflation (by SCRS)",
                  lab2 = "Actual inflation (CPI-U)")

inflation
```

### Interest on Debt 2001-2021 w/ R (custom)

```{r int.debt, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial valuation reports.", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

rm(list = ls())

###Load/install packages
#R.Version()
#https://github.com/ReasonFoundation/pensionviewr
#Create token -> usethis::edit_r_environ() -> restart -> Sys.getenv("GITHUB_PAT")
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
#devtools::install_github(
#  "ANiraula/pensionviewr_private",
#   ref = "master", auth_token = "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")
library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(dplyr)
library(plyr)

###
##Pull PERSI data
##Load list of plans

pl <- planList()
reason.data <- pullData(pl, "South Carolina Retirement Systems") %>% filter(year > 2000 & !duplicated(year))

### Net Amo
reason.data$net.amo <- c(reason.data$interest_on_debt_dollar+reason.data$amortization_payment_total_amount)
reason.data$net.amo[1:3] <- c(-26000000,-6000000,-17000000)

### UAL
reason.data$ual <- c(reason.data$actuarially_accrued_liabilities_dollar -
reason.data$actuarial_value_of_assets_dollar)

### Compound Net Amo
reason.data <- reason.data %>% select(year, net.amo,ual)
reason.data$compound <- 0
reason.data$compound[4] <- reason.data$net.amo[4]+reason.data$net.amo[3]
  
for (i in (5:21)){
  reason.data$compound[i] <- reason.data$net.amo[i]+reason.data$compound[i-1]
}

### Remaining UAL
reason.data$ual.left <- reason.data$ual-reason.data$compound
reason.data <- data.frame(reason.data)
reason.data <- reason.data %>% mutate_all(as.numeric)
reason.data <- reason.data %>% select(year, compound,ual.left)

colnames(reason.data)[2:3] <- c("Unpaid Interest on Unfunded Liabilities (Cumulative)",
                                "Unfunded Liability from Other Sources")
reason.data <- data.table(reason.data)
reason.data <- data.table(melt(reason.data, id.vars = "year"))

#### GGPLOT
 plotTheme <- ggplot2::theme(   panel.grid = element_blank(),
                                 panel.border = element_blank(),
                                 axis.line = element_line(colour = "black"),
                                 plot.margin = margin(0,0.5,0,0, "cm"),
                                 axis.text.y = element_text(size=12, color = "black"),
                                 axis.text.x = element_text(size=12, color = "black", angle = 0, hjust = 0.5, vjust = -1),
                                 axis.title = element_text(size = 12, face = "bold"),
                                 legend.text = element_text(size = 11),
                                 legend.title = element_blank(),
                                 text = element_text(family = "Calibri"))
  
  int.debt <- ggplot(data = reason.data, aes(x = year, y = value, fill = variable, 
    group = variable)) + geom_area(cposition = "stack", stat = "identity") + 
    ggplot2::labs(y = "Unfunded Actuarial Accrued Liability (in $Billions)", x = "") + 
    ggplot2::scale_fill_manual(values = c(palette_reason$SpaceGrey, palette_reason$Orange)) + 
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 10), 
    labels = function(b) paste0("$",round(b/1000000000, 0)), expand = c(0,0)) + 
    ggplot2::theme(axis.ticks = ggplot2::element_line()) + 
    ggplot2::scale_x_continuous(breaks = seq(2001,2021, by = 2), expand = c(0, 0)) + 
    theme(legend.position = "top", text = element_text(family = "Calibri", size = 11)) + 
    theme_bw() + plotTheme + theme(legend.position = "top")
  # + geom_text(data=annotation, aes(x=x, y=y, label=label),
  #         color="black", 
  #         size=5 , angle=0, fontface="bold" )

#View(reason.data)

  int.debt
```

### Benefit Accrual & Retention for an Average New SCRS Employee (Age 27)  w/ R (custom)

```{r pwealth, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial reports and CAFRs. Illustration is based on plan’s Class Three assumptions and a hypothetical analysis of an average new member hired at the age of 27", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

rm(list=ls())
###Load/install packages
#R.Version()
#https://github.com/ReasonFoundation/pensionviewr
#Create token -> usethis::edit_r_environ() -> restart -> Sys.getenv("GITHUB_PAT")
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(dplyr)
library(plyr)

 urlfile2 = "https://raw.githubusercontent.com/ANiraula/SCRS.deck/main/SCRS_BModel.csv"
  
SalaryData2 <- data.table(
    read_csv(url(urlfile2), col_names = TRUE, na = c(""), 
                    skip_empty_rows = TRUE, col_types = NULL))

e.age <- unique(SalaryData2$entry_age)
SalaryData2 <- data.frame(SalaryData2)
SalaryData2$entry_age <- as.numeric(SalaryData2$entry_age)
# #View(SalaryData2)
# 
entry <- 27
SalaryData2 <- SalaryData2 
SalaryData2 <- SalaryData2 %>% filter(Age < 81)
SalaryData2$PVPenWealth <- as.numeric(SalaryData2$RealPenWealth)
y_max <- max(SalaryData2$PVPenWealth)

palette_reason <- list(Orange="#FF6633",
                       LightOrange="#FF9900",
                       DarkGrey="#333333", 
                       LightGrey= "#CCCCCC", 
                       SpaceGrey ="#A69FA1",
                       DarkBlue="#0066CC", 
                       GreyBlue= "#6699CC", 
                       Yellow= "#FFCC33",
                       LightBlue = "#66B2FF", 
                       SatBlue = "#3366CC", 
                       Green = "#669900",LightGreen = "#00CC66", Red = "#CC0000",LightRed="#FF0000")

pw.28 <- round(as.numeric(SalaryData2$PVPenWealth[29])/1000,2)
pw.32 <- round(as.numeric(SalaryData2$PVPenWealth[33])/1000,2)
age <- SalaryData2$Age[33]
pw.32.p <- round(as.numeric((pw.32/pw.28-1))*100,1)

#PULL DATA
###################
pwealth <- ggplot(SalaryData2, aes(YOS,PVPenWealth/1000))+
  geom_line(aes(group = 1,
                text = paste0("YOS: ", YOS,
                              "<br>Pension Wealth: $",round(PVPenWealth/1000,1), " Thousands")),size = 1.25, color = palette_reason$SatBlue)+
  geom_line(aes(YOS, RemainingProb* (y_max/1000),
                group = 2,
                text = paste0("YOS: ", YOS,
                              "<br>Members Remaining: ", round(RemainingProb*100,1), "%")), size = 1.25, color = palette_reason$LightBlue, linetype = "dashed")+
  scale_x_continuous(breaks = seq(0, 50, by = 5),labels = function(x) paste0(x),
                     name = paste0("Age (Entry age at ", entry, ")"), expand = c(0,0)) +
  
  scale_y_continuous(breaks = seq(0, 5000, by = 50),limits = c(0, y_max/1000*1.05), labels = function(x) paste0("$",x),
                     sec.axis = sec_axis(~./(y_max/100), breaks = scales::pretty_breaks(n = 10), name = "Percent of Members Remaining",
                                         labels = function(b) paste0(round(b*1000, 0), "%")), 
                     name = "Present Value of Pension Wealth ($Thousands)", expand = c(0,0)) +
  theme_bw()+
  theme(   panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
    plot.margin = margin(0.5, 0.5,0.5,0.5, "cm"),
    axis.text.y = element_text(size=11, color = "black"),
    axis.text.y.right = element_text(size=11, color = "black"),
    axis.text.y.left = element_text(size=11, color = "black"),
    axis.text.x = element_text(size=11, color = "black"),
    legend.title = element_text(size = 9, colour = "black", face = "bold"))

pwealth
```

### Delaying Eligibility for Full Benefits Backloads `r entry` Age New SCRS Hires' Benefits

Only **$`r pw.28`K** is what new Age `r entry` (Class Three) SCRS members will accrue after 28 years on the job (accrued benefits valued at retirement).

</p>
</p>

-   All new employees are better off collecting their own contributions (with credited interest), before they qualify for Reduced or Full Defined Benefits.

</p>
</p>

Value of accrued benefits jumps to **$`r pw.32`K** (or by **`r pw.32.p`%**) just after 4 more years (Age **`r age`**, long enough to receive Unreduced/Full benefits)

-   Such spikes are caused by employer awarding a significantly higher total benefits in the employee's later years of service.
-   This backloading usually benefits only small portion of long-career employees, leaving most of younger workers behind.

</p>

### Retention Rates for a New SCRS Employee  w/ R (custom)

```{r ret, dpi=400, echo = FALSE, fig.cap = "Source: Pension Integrity Project analysis of SCRS actuarial reports and CAFRs. Illustration is based on plan’s Class Three assumptions and a hypothetical analysis of an average new member hired at the age of 27", fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

library(data.table)

urlfile2 = "https://raw.githubusercontent.com/ANiraula/SCRS.deck/main/SCRS_BModel.csv"
  
SalaryData2 <- data.table(
    read_csv(url(urlfile2), col_names = TRUE, na = c(""), 
                    skip_empty_rows = TRUE, col_types = NULL))

e.age <- unique(SalaryData2$entry_age)
SalaryData2 <- data.frame(SalaryData2)
SalaryData2$entry_age <- as.numeric(SalaryData2$entry_age)
# #View(SalaryData2)
# 

entry <- 27
SalaryData2 <- SalaryData2 %>% filter(entry_age == entry)
SalaryData2 <- SalaryData2 %>% filter(Age < 81)
SalaryData2$PVPenWealth <- as.numeric(SalaryData2$RealPenWealth)

palette_reason <- list(Orange="#FF6633",
                       LightOrange="#FF9900",
                       DarkGrey="#333333", 
                       LightGrey= "#CCCCCC", 
                       SpaceGrey ="#A69FA1",
                       DarkBlue="#0066CC", 
                       GreyBlue= "#6699CC", 
                       Yellow= "#FFCC33",
                       LightBlue = "#66B2FF", 
                       SatBlue = "#3366CC", 
                       Green = "#669900",LightGreen = "#00CC66", Red = "#CC0000",LightRed="#FF0000")

vest <- 8
vest.prob <- round(as.numeric(SalaryData2$RemainingProb[vest+1]),3)
vest.20 <- round(as.numeric(SalaryData2$RemainingProb[21]),3)
retire.prob <- data.table(SalaryData2 %>% filter(YOS+Age >= 90) %>% select(RemainingProb))
retire.prob <- round(as.numeric(retire.prob[1]),3)
#View(SalaryData2 %>% select(Age, YOS, RemainingProb))

#PULL DATA
###################
ret <- ggplot(SalaryData2)+
 geom_line(aes(YOS, RemainingProb,
                group = 2,
                text = paste0("YOS: ", YOS,
                              "<br>Members Remaining: ", round(RemainingProb*100,1), "%")), size = 1.25, color = palette_reason$LightBlue, linetype = "dashed")+
  scale_x_continuous(breaks = seq(0, 50, by = 5),labels = function(x) paste0(x),
                     name = paste0("Age (Entry age at ", entry, ")"), expand = c(0,0)) +
  
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10), name = "Percent of Members Remaining",
                                         labels = function(b) paste0(round(b*100, 0), "%"), expand = c(0,0)) +
  theme_bw()+
  theme(   panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
    plot.margin = margin(0.5, 0.5,0.5,0.5, "cm"),
    axis.text.y = element_text(size=11, color = "black"),
    axis.text.y.right = element_text(size=11, color = "black"),
    axis.text.y.left = element_text(size=11, color = "black"),
    axis.text.x = element_text(size=11, color = "black"),
    legend.title = element_text(size = 9, colour = "black", face = "bold"))


ret
```

### Retention: Only Few of `r entry` Age New SCRS Hires Receive Benefits

Only **`r vest.prob*100`%** of new Age `r entry` (Class Three) SCRS members will stay for 8 years.

</p>
</p>

-   Class Three employees must work 8 years before their benefits become vested.
-   Members who leave the plan before then must forfeit contributions their employer made on their behalf.
-   Only **`r vest.20*100`%** of the initial employees will accrue 20 years of service.

</p>
</p>

And only **`r retire.prob*100`%** of Age `r entry` Class Three members hired next year will still be working after reaching Rule of 90 threshold (Age + Years of Service), long enough to qualify for unreduced benefits.

</p>

    
### References

-   <https://github.com/ReasonFoundation/GraphicsR>

    </p>

-   <https://rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf>

    </p>

-   <https://bookdown.org/yihui/rmarkdown/>